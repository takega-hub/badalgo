<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Crypto Bot Admin</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 500px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00d4ff;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #aaa;
        }
        
        .stat-value {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #00ff88;
        }
        
        .stat-value.negative {
            color: #ff4444;
        }
        
        .btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #00b8e6;
        }
        
        .btn.danger {
            background: #ff4444;
            color: #fff;
        }
        
        .btn.danger:hover {
            background: #cc0000;
        }
        
        .btn.success {
            background: #00ff88;
            color: #000;
        }
        
        .btn.success:hover {
            background: #00cc6a;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.running {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-indicator.stopped {
            background: #ff4444;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
        }
        
        th {
            color: #00d4ff;
            font-weight: bold;
        }
        
        td {
            color: #e0e0e0;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è PnL –≤ —Ç–∞–±–ª–∏—Ü–µ */
        td.positive {
            color: #00ff88 !important;
            font-weight: bold;
        }
        
        td.negative {
            color: #ff4444 !important;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        .chart-container {
            width: 100%;
            height: 1200px;  /* –£–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã */
            margin-top: 20px;
        }
        
        .chart-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chart-controls label {
            color: #aaa;
            margin-right: 5px;
        }
        
        .chart-controls input[type="checkbox"] {
            margin-right: 20px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #1a1a1a;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            padding: 8px 16px;
            color: #00d4ff;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
            transition: all 0.3s;
        }
        
        .mode-toggle:hover {
            background: #00d4ff;
            color: #000;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.5);
        }
        
        .mode-toggle.mobile-active {
            background: #00d4ff;
            color: #000;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body.mobile-mode {
            padding: 10px;
        }
        
        body.mobile-mode .container {
            max-width: 100%;
        }
        
        body.mobile-mode h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-right: 100px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è */
        }
        
        body.mobile-mode .tabs {
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        body.mobile-mode .tab {
            padding: 12px 16px;
            font-size: 0.95em;
            flex: 1 1 auto;
            min-width: calc(50% - 5px);
        }
        
        body.mobile-mode .card {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        body.mobile-mode .card h2 {
            font-size: 1.2em;
            margin-bottom: 12px;
        }
        
        body.mobile-mode .btn {
            padding: 14px 20px;
            font-size: 1.1em;
            margin: 8px 0;
            width: 100%;
            min-height: 48px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è */
        }
        
        body.mobile-mode .stat-item {
            padding: 12px 0;
            font-size: 1.1em;
        }
        
        body.mobile-mode .stat-label {
            font-size: 1em;
        }
        
        body.mobile-mode .stat-value {
            font-size: 1.2em;
        }
        
        body.mobile-mode .form-group {
            margin-bottom: 20px;
        }
        
        body.mobile-mode .form-group label {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        body.mobile-mode .form-group input,
        body.mobile-mode .form-group select,
        body.mobile-mode .form-group textarea {
            padding: 14px;
            font-size: 1.1em;
            min-height: 48px;
        }
        
        body.mobile-mode table {
            font-size: 0.9em;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        body.mobile-mode th,
        body.mobile-mode td {
            padding: 12px 8px;
            font-size: 1em;
            white-space: nowrap;
        }
        
        body.mobile-mode .chart-container {
            height: 600px;
            margin-top: 15px;
        }
        
        body.mobile-mode .chart-controls {
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        body.mobile-mode .chart-controls label {
            font-size: 1em;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 6px;
            min-height: 44px;
            display: flex;
            align-items: center;
            flex: 1 1 auto;
            min-width: calc(50% - 4px);
        }
        
        body.mobile-mode .chart-controls input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        body.mobile-mode .grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        body.mobile-mode .mode-toggle {
            top: 10px;
            right: 10px;
            padding: 10px 18px;
            font-size: 0.85em;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        body.mobile-mode .form-group p {
            font-size: 1em;
            line-height: 1.5;
        }
        
        body.mobile-mode label {
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        body.mobile-mode .stat-item label {
            font-size: 1.1em;
        }
        
        body.mobile-mode input[type="checkbox"],
        body.mobile-mode input[type="radio"] {
            width: 24px !important;
            height: 24px !important;
            min-width: 24px;
            min-height: 24px;
            margin-right: 12px;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        body.mobile-mode .table-wrapper {
            margin: 0 -15px;
            padding: 0 15px;
        }
        
        body.mobile-mode .table-wrapper table {
            min-width: 600px;
            font-size: 0.95em;
        }
        
        body.mobile-mode .table-wrapper th,
        body.mobile-mode .table-wrapper td {
            padding: 10px 6px;
            font-size: 0.95em;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            body.mobile-mode h1 {
                font-size: 1.5em;
                padding-right: 90px;
            }
            
            body.mobile-mode .tab {
                font-size: 0.85em;
                padding: 10px 12px;
            }
            
            body.mobile-mode .mode-toggle {
                padding: 8px 14px;
                font-size: 0.75em;
            }
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        body.mobile-mode {
            -webkit-overflow-scrolling: touch;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ touch targets */
        body.mobile-mode button,
        body.mobile-mode .tab,
        body.mobile-mode input[type="checkbox"],
        body.mobile-mode input[type="radio"] {
            -webkit-tap-highlight-color: rgba(0, 212, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ -->
        <button class="mode-toggle" id="modeToggle" onclick="toggleMobileMode()">
            <span id="modeIcon">üì±</span>
            <span id="modeText">Mobile</span>
        </button>
        
        <h1>ü§ñ Crypto Bot Admin Panel</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">Dashboard</button>
            <button class="tab" onclick="showTab('symbols', event)">Symbols</button>
            <button class="tab" onclick="showTab('strategies', event)">Strategies</button>
            <button class="tab" onclick="showTab('strategy', event)">Strategy Settings</button>
            <button class="tab" onclick="showTab('risk', event)">Risk</button>
            <button class="tab" onclick="showTab('trades', event)">Trades</button>
            <button class="tab" onclick="showTab('signals', event)">Signals</button>
            <button class="tab" onclick="showTab('smc_history', event)">SMC History</button>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="tab" onclick="showTab('settings', event)">Settings</button>
                <button class="tab" onclick="logout()" style="color: #ff6666;">Logout</button>
            </div>
        </div>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ -->
        <div id="symbol-selector" style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
            <label style="color: #aaa; margin-right: 10px;">Active Symbol:</label>
            <select id="primary-symbol-select" style="padding: 8px 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; font-size: 1em; cursor: pointer;" onchange="changePrimarySymbol(this.value)">
                <option value="BTCUSDT">BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="SOLUSDT">SOLUSDT</option>
            </select>
            <span id="active-symbols-status" style="margin-left: 20px; color: #aaa; font-size: 0.9em;"></span>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2>Bot Status</h2>
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="bot-status">
                        <span class="status-indicator stopped"></span>Stopped
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current Status:</span>
                    <span class="stat-value" id="current-status">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Market Phase:</span>
                    <span class="stat-value" id="market-phase">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ADX:</span>
                    <span class="stat-value" id="current-adx">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Action:</span>
                    <span class="stat-value" id="last-action" style="font-size: 0.9em; color: #aaa;">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Signal:</span>
                    <span class="stat-value" id="last-signal" style="font-size: 0.9em; color: #aaa;">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Update:</span>
                    <span class="stat-value" id="last-update">-</span>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn success" onclick="startBot()">Start Bot</button>
                    <button class="btn danger" onclick="stopBot()">Stop Bot</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>Account</h2>
                    <div class="stat-item">
                        <span class="stat-label">Symbol:</span>
                        <span class="stat-value" id="symbol">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Leverage:</span>
                        <span class="stat-value" id="leverage">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Available Balance:</span>
                        <span class="stat-value" id="wallet-available">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Wallet Balance:</span>
                        <span class="stat-value" id="wallet-balance">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Position Margin:</span>
                        <span class="stat-value" id="wallet-margin">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total PnL:</span>
                        <span class="stat-value" id="wallet-total-pnl">-</span>
                    </div>
                    <div id="wallet-bonus" style="display: none;">
                        <div class="stat-item">
                            <span class="stat-label">Bonus:</span>
                            <span class="stat-value" id="wallet-bonus-value">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Position</h2>
                    <div class="stat-item">
                        <span class="stat-label">Side:</span>
                        <span class="stat-value" id="position-side">None</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Size:</span>
                        <span class="stat-value" id="position-size">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Entry Price:</span>
                        <span class="stat-value" id="position-entry">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Current Price:</span>
                        <span class="stat-value" id="position-current-price">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unrealised PnL:</span>
                        <span class="stat-value" id="position-pnl">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL %:</span>
                        <span class="stat-value" id="position-pnl-pct">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Take Profit:</span>
                        <span class="stat-value" id="position-tp">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Stop Loss:</span>
                        <span class="stat-value" id="position-sl">-</span>
                    </div>
                    <div class="stat-item" id="position-strategy-container" style="display: none;">
                        <span class="stat-label">Strategy:</span>
                        <span class="stat-value" id="position-strategy">-</span>
                    </div>
                    <div class="stat-item" id="position-entry-signal-container" style="display: none;">
                        <span class="stat-label">Entry Signal:</span>
                        <span class="stat-value" id="position-entry-signal" style="font-size: 0.9em; word-break: break-word;">-</span>
                    </div>
                    <div class="stat-item" id="position-close-button-container" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
                        <button class="btn danger" id="close-position-btn" onclick="closePosition()" style="width: 100%;">
                            üîí Close Position
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Orders</h2>
                    <div class="stat-item">
                        <span class="stat-label">Open Orders:</span>
                        <span class="stat-value" id="open-orders">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Orders Margin:</span>
                        <span class="stat-value" id="orders-margin">-</span>
                    </div>
                    <div id="tp-orders-list" style="margin-top: 10px;">
                        <!-- TP orders will be inserted here -->
                    </div>
                    <div id="sl-orders-list" style="margin-top: 10px;">
                        <!-- SL orders will be inserted here -->
                    </div>
                </div>
                
                <div class="card">
                    <h2>Trading Statistics</h2>
                    <div id="trading-stats">
                        <div class="loading">Loading statistics...</div>
                    </div>
                    <div id="combined-stats" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.1em;">üìä Combined Statistics (All Active Symbols)</h3>
                        <div id="combined-pnl-stats">
                            <div class="loading" style="font-size: 0.9em;">Loading combined statistics...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Symbols Status Panel on Dashboard -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>üìà Symbols Status</h2>
                <div id="dashboard-symbols-status-list" style="margin-top: 15px;">
                    <div class="loading">Loading symbols status...</div>
                </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Price Chart & Signals</h2>
                <div class="chart-controls">
                    <label><input type="checkbox" id="show-sma" checked> SMA20</label>
                    <label><input type="checkbox" id="show-bb" checked> Bollinger Bands</label>
                    <label><input type="checkbox" id="show-volume" checked> Volume</label>
                    <label><input type="checkbox" id="show-rsi"> RSI</label>
                    <label><input type="checkbox" id="show-macd" checked> MACD</label>
                    <label><input type="checkbox" id="show-signals" checked> Entry Signals</label>
                    <button class="btn" onclick="loadChart()" style="margin-left: auto;">Refresh Chart</button>
                </div>
                <div id="chart-container" class="chart-container">
                    <div class="loading">Loading chart...</div>
                </div>
            </div>
        </div>
        
        <!-- Symbols Tab -->
        <div id="symbols" class="tab-content">
            <div class="card">
                <h2>üìä Trading Symbols Management</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Manage active trading pairs and select the primary symbol for display.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #aaa; display: block; margin-bottom: 10px;">Available Symbols:</label>
                    <div id="available-symbols-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="BTCUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">BTCUSDT</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="ETHUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">ETHUSDT</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="SOLUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">SOLUSDT</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #aaa; display: block; margin-bottom: 10px;">Primary Symbol (for display):</label>
                    <select id="symbols-primary-select" style="padding: 10px 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; font-size: 1em; width: 200px;">
                        <option value="BTCUSDT">BTCUSDT</option>
                        <option value="ETHUSDT">ETHUSDT</option>
                        <option value="SOLUSDT">SOLUSDT</option>
                    </select>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">This symbol will be used for the main chart and dashboard display.</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn success" onclick="saveSymbolSettings()">üíæ Save Symbol Settings</button>
                    <button class="btn" onclick="loadSymbolSettings()" style="margin-left: 10px;">üîÑ Refresh</button>
                </div>
                
                <div id="symbols-status-message" style="margin-top: 20px; padding: 15px; border-radius: 5px; display: none;"></div>
                
                <div class="card" style="margin-top: 30px;">
                    <h2>üìà Symbols Status</h2>
                    <div id="symbols-status-list" style="margin-top: 15px;">
                        <p style="color: #666;">Loading symbols status...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Strategies Selection Tab -->
        <div id="strategies" class="tab-content">
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Strategy Selection</h2>
                <p style="color: #aaa; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-trend-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00ff88;">Trend Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Trend strategy - ADX > 25)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-flat-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ffaa00;">Flat Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Flat strategy)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-ml-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #9933ff;">ML Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Machine Learning)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-momentum-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00d4ff;">Momentum Breakout</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(–ò–º–ø—É–ª—å—Å–Ω—ã–π –ø—Ä–æ–±–æ–π –¥–ª—è —Ç—Ä–µ–Ω–¥–∞)</span>
                    </label>
                </div>
                
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-liquidity-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ffd93d;">Liquidity Sweep</span>
                    </div>
                    <div class="stat-item">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="smcCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-size: 1.1em; font-weight: bold; color: #9d4edd;">Smart Money Concepts (SMC)</span>
                            <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Fair Value Gaps, Order Blocks)</span>
                    </label>
                </div>
                
                <div class="form-group" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #444;">
                    <label for="strategy-priority-select" style="display: block; margin-bottom: 10px; color: #aaa; font-weight: bold;">Strategy Priority (–ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —Å–∏–≥–Ω–∞–ª–æ–≤):</label>
                    <select id="strategy-priority-select" style="width: 100%; max-width: 400px; padding: 8px; border-radius: 4px; background-color: #333; color: #e0e0e0; border: 1px solid #555; font-size: 1em;">
                        <option value="trend">Trend Strategy Priority</option>
                        <option value="flat">Flat Strategy Priority</option>
                        <option value="ml">ML Strategy Priority</option>
                        <option value="momentum">Momentum Breakout Priority</option>
                        <option value="liquidity">Liquidity Sweep Priority</option>
                        <option value="smc">Smart Money Concepts Priority</option>
                        <option value="hybrid">Hybrid (–≤—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–≤–Ω–æ–ø—Ä–∞–≤–Ω—ã, –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª)</option>
                    </select>
                    <p style="color: #888; font-size: 0.85em; margin-top: 8px; margin-bottom: 0;">
                        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Å–∏–≥–Ω–∞–ª—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É. –í —Ä–µ–∂–∏–º–µ Hybrid –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª.
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn success" onclick="saveStrategySelection()">Save Strategy Selection</button>
                </div>
            </div>
            
            <!-- ML Model Management -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>ML Model Management</h2>
                
                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä -->
                <div style="margin-bottom: 30px; padding: 20px; background: #1a2a2a; border: 1px solid #00d4ff; border-radius: 8px;">
                    <h3 style="color: #00d4ff; margin-top: 0; margin-bottom: 15px;">üîß Model Type for All Pairs</h3>
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                        Select the model type to use for all trading pairs (BTCUSDT, ETHUSDT, SOLUSDT). 
                        This setting will be applied automatically when models are loaded for each pair.
                    </p>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Model Type for All Pairs:</span>
                        <select id="ml-model-type-for-all" style="width: 100%; max-width: 400px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="">Auto (Ensemble > RF > XGB)</option>
                            <option value="ensemble">üéØ Ensemble (RF + XGBoost) - Recommended</option>
                            <option value="rf">Random Forest</option>
                            <option value="xgb">XGBoost</option>
                        </select>
                    </label>
                    <button class="btn success" onclick="saveMLModelTypeForAll()" style="margin-top: 10px;">Save Model Type for All Pairs</button>
                    <div id="model-type-status" style="margin-top: 10px; color: #aaa;"></div>
                </div>
                
                <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–∞—Ä—ã -->
                <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px solid #444;">
                    <h3 style="color: #e0e0e0; margin-bottom: 15px;">Select Model for Current Pair</h3>
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                        Select a specific ML model for the current trading pair. This overrides the model type setting above.
                    </p>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Select ML Model:</span>
                        <select id="ml-model-select" style="width: 100%; max-width: 500px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="">Loading models...</option>
                        </select>
                    </label>
                    <button class="btn primary" onclick="selectMLModel()" id="select-model-btn" style="margin-top: 10px;">Select Model</button>
                    <div id="select-model-status" style="margin-top: 10px; color: #aaa;"></div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª—è—Ö –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä -->
                <div id="ml-models-all-pairs" style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                    <h4 style="color: #00d4ff; margin-top: 0; margin-bottom: 15px;">üìä Selected Models for All Pairs</h4>
                    <div id="all-pairs-models-content" style="color: #aaa;">
                        <p>Loading models info...</p>
                    </div>
                </div>
                
                <div id="ml-model-info" style="margin-bottom: 20px;">
                    <div class="loading">Loading model info...</div>
                </div>
                
                <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
                    <h3 style="color: #e0e0e0; margin-bottom: 15px;">Retrain Model</h3>
                    
                    <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                        <h4 style="color: #e0e0e0; margin-top: 0; margin-bottom: 15px;">üöÄ Retrain All ML Models</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Optimal Mode Card -->
                            <div style="padding: 12px; background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 4px;">
                                <h5 style="color: #00ff88; margin-top: 0; margin-bottom: 8px;">üü¢ Optimal Mode</h5>
                                <p style="font-size: 0.8em; color: #aaa; margin-bottom: 12px;">High Win Rate (70%+). Balanced signals.</p>
                                <button class="btn success" onclick="retrainAllMLModels('optimal')" id="retrain-all-optimal-btn" style="width: 100%; font-size: 0.9em;">Retrain Optimal</button>
                            </div>
                            <!-- Aggressive Mode Card -->
                            <div style="padding: 12px; background: rgba(255, 68, 68, 0.05); border: 1px solid rgba(255, 68, 68, 0.2); border-radius: 4px;">
                                <h5 style="color: #ff4444; margin-top: 0; margin-bottom: 8px;">üî• Aggressive Mode</h5>
                                <p style="font-size: 0.8em; color: #aaa; margin-bottom: 12px;">Maximum Signals (100+). Lower Win Rate.</p>
                                <button class="btn danger" onclick="retrainAllMLModels('aggressive')" id="retrain-all-aggressive-btn" style="width: 100%; font-size: 0.9em;">Retrain Aggressive</button>
                            </div>
                        </div>
                        <div id="retrain-all-status" style="margin-top: 10px; color: #aaa;"></div>
                    </div>
                    
                    <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ -->
                    <div style="padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                        <h4 style="color: #e0e0e0; margin-top: 0; margin-bottom: 10px;">Retrain Single Model</h4>
                        <label style="display: block; margin-bottom: 10px;">
                            <span style="display: block; margin-bottom: 5px; color: #aaa;">Trading Pair for Retraining:</span>
                            <select id="ml-symbol-select" style="width: 100%; max-width: 300px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                                <option value="BTCUSDT">BTC/USDT</option>
                                <option value="ETHUSDT">ETH/USDT</option>
                                <option value="SOLUSDT" selected>SOL/USDT</option>
                            </select>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn success" onclick="retrainMLModel('optimal')">Retrain Optimal</button>
                            <button class="btn danger" onclick="retrainMLModel('aggressive')">Retrain Aggressive</button>
                        </div>
                        <div id="retrain-status" style="margin-top: 10px; color: #aaa;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Statistics by Strategy -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Strategy Statistics</h2>
                <div id="strategy-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>
        </div>
        
        <!-- Strategy Settings Tab -->
        <div id="strategy" class="tab-content">
            <div class="card">
                <h2>Trend Strategy</h2>
                <div id="strategy-form">
                    <div class="loading">Loading settings...</div>
                </div>
            </div>
        </div>
        
        <!-- Risk Tab -->
        <div id="risk" class="tab-content">
            <div class="card">
                <h2>Risk Management</h2>
                <div id="risk-form">
                    <div class="loading">Loading settings...</div>
                </div>
            </div>
        </div>
        
        <!-- Trades Tab -->
        <div id="trades" class="tab-content">
            <div class="card">
                <h2>Trade History</h2>
                
                <!-- PnL Statistics -->
                <div id="pnl-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
                    <div class="stat-item">
                        <span class="stat-label">PnL —Å–µ–≥–æ–¥–Ω—è:</span>
                        <span class="stat-value" id="pnl-today">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
                        <span class="stat-value" id="pnl-week">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL –∑–∞ –º–µ—Å—è—Ü:</span>
                        <span class="stat-value" id="pnl-month">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–û–±—â–∏–π PnL –ø–æ –ø–∞—Ä–µ:</span>
                        <span class="stat-value" id="pnl-total">-</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <button onclick="removeDuplicateTrades()" style="background: #ffaa00; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Remove Duplicates</button>
                </div>
                <div class="table-wrapper">
                    <div id="trades-table">
                        <div class="loading">Loading trades...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Bybit API Settings</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Configure your Bybit API credentials. Changes will be saved to .env file.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-api-key" style="display: block; margin-bottom: 8px; color: #aaa;">API Key:</label>
                    <input type="password" id="bybit-api-key" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter Bybit API Key">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-api-secret" style="display: block; margin-bottom: 8px; color: #aaa;">API Secret:</label>
                    <input type="password" id="bybit-api-secret" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter Bybit API Secret">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-base-url" style="display: block; margin-bottom: 8px; color: #aaa;">Base URL:</label>
                    <select id="bybit-base-url" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                        <option value="https://api.bybit.com">Production (https://api.bybit.com)</option>
                        <option value="https://api-testnet.bybit.com">Testnet (https://api-testnet.bybit.com)</option>
                    </select>
                    <p style="color: #888; font-size: 0.85em; margin-top: 8px;">Select Production for live trading or Testnet for testing.</p>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn success" onclick="saveBybitApiSettings()">Save API Settings</button>
                    <button class="btn" onclick="loadBybitApiSettings()" style="margin-left: 10px; background: #444;">Load Current Settings</button>
                </div>
                
                <div id="api-settings-status" style="margin-top: 15px; color: #aaa; font-size: 0.9em;"></div>
            </div>
            
            <!-- Admin Password Change Section -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>Admin Password Settings</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Change admin login password.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="current-password" style="display: block; margin-bottom: 8px; color: #aaa;">Current Password:</label>
                    <input type="password" id="current-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter current password">
                    <button type="button" onclick="togglePasswordVisibility('current-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="new-password" style="display: block; margin-bottom: 8px; color: #aaa;">New Password:</label>
                    <input type="password" id="new-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter new password (min 6 characters)">
                    <button type="button" onclick="togglePasswordVisibility('new-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="confirm-password" style="display: block; margin-bottom: 8px; color: #aaa;">Confirm New Password:</label>
                    <input type="password" id="confirm-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Confirm new password">
                    <button type="button" onclick="togglePasswordVisibility('confirm-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn success" onclick="changeAdminPassword()">Change Password</button>
                </div>
                
                <div id="password-change-status" style="margin-top: 15px; color: #aaa; font-size: 0.9em;"></div>
            </div>
        </div>
        
        <!-- Signals Tab -->
        <div id="signals" class="tab-content">
            <div class="card">
                <h2>Signal History</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="clearSignals()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Clear All Signals</button>
                </div>
                <div class="table-wrapper">
                    <div id="signals-table">
                        <div class="loading">Loading signals...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SMC History Tab -->
        <div id="smc_history" class="tab-content">
            <div class="card">
                <h2>Smart Money Concepts History (CSV)</h2>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="loadSMCHistory()" class="btn success">Refresh SMC Data</button>
                    <span id="smc-count" style="color: #aaa;"></span>
                </div>
                <div class="table-wrapper">
                    <div id="smc-history-table">
                        <div class="loading">Loading SMC history from CSV...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let lwChart = null;
        let candleSeries = null;
        let volumeSeries = null;

        async function loadChartLW() {
            try {
                const container = document.getElementById('chart-container');
                const symbolSelect = document.getElementById('chart-symbol-select');
                const symbol = symbolSelect ? symbolSelect.value : 'BTCUSDT';
                
                if (lwChart) { lwChart.remove(); lwChart = null; }
                container.innerHTML = '';

                const response = await fetch(`/api/chart/data?symbol=${encodeURIComponent(symbol)}`);
                const data = await response.json();
                
                if (data.error || !data.candles || data.candles.length === 0) {
                    container.innerHTML = `<p style="color: #ff4444; padding: 20px;">${data.error || 'No data'}</p>`;
                    return;
                }

                lwChart = LightweightCharts.createChart(container, {
                    width: container.clientWidth, height: 500,
                    layout: { background: { type: 'solid', color: '#1a1a1a' }, textColor: '#d1d4dc' },
                    grid: { vertLines: { color: 'rgba(42, 46, 57, 0.1)' }, horzLines: { color: 'rgba(42, 46, 57, 0.1)' } },
                    timeScale: { timeVisible: true, secondsVisible: false },
                });

                candleSeries = lwChart.addCandlestickSeries({
                    upColor: '#00ff88', downColor: '#ff4444', borderVisible: false,
                    wickUpColor: '#00ff88', wickDownColor: '#ff4444',
                });

                candleSeries.setData(data.candles.map((c, i) => ({
                    time: data.times[i] / 1000,
                    open: c.open, high: c.high, low: c.low, close: c.close
                })));

                volumeSeries = lwChart.addHistogramSeries({
                    color: '#26a69a', priceFormat: { type: 'volume' },
                    priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 },
                });

                volumeSeries.setData(data.candles.map((c, i) => ({
                    time: data.times[i] / 1000, value: c.volume,
                    color: c.close >= c.open ? 'rgba(0, 255, 136, 0.2)' : 'rgba(255, 68, 68, 0.2)',
                })));

                if (document.getElementById('show-ema')?.checked && data.indicators.ema_fast) {
                    const emaLine = lwChart.addLineSeries({ color: '#2962FF', lineWidth: 1 });
                    emaLine.setData(data.indicators.ema_fast.map((v, i) => ({ time: data.times[i]/1000, value: v })));
                }

                if (document.getElementById('show-signals')?.checked && data.signals) {
                    candleSeries.setMarkers(data.signals.map(sig => ({
                        time: new Date(sig.timestamp).getTime() / 1000,
                        position: sig.action === 'LONG' ? 'belowBar' : 'aboveBar',
                        color: sig.action === 'LONG' ? '#00ff88' : '#ff4444',
                        shape: sig.action === 'LONG' ? 'arrowUp' : 'arrowDown',
                        text: sig.action
                    })));
                }

                lwChart.timeScale().fitContent();
                window.addEventListener('resize', () => lwChart && lwChart.applyOptions({ width: container.clientWidth }));

            } catch (e) {
                console.error('LW Chart error:', e);
                document.getElementById('chart-container').innerHTML = `<p style="color: #ff4444;">${e.message}</p>`;
            }
        }
        
        // –°—Ç–∞—Ä—ã–π –∫–æ–¥...

        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –°–†–ê–ó–£ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è onclick –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        try {
            window.showTab = window.showTab || function(tabName, event) {
                console.warn('showTab: function not fully loaded yet');
            };
            window.startBot = window.startBot || async function() {
                console.warn('startBot: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            window.stopBot = window.stopBot || async function() {
                console.warn('stopBot: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            window.closePosition = window.closePosition || async function() {
                console.warn('closePosition: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            console.log('‚úÖ Global functions initialized:', {
                showTab: typeof window.showTab,
                startBot: typeof window.startBot,
                stopBot: typeof window.stopBot,
                closePosition: typeof window.closePosition
            });
        } catch (e) {
            console.error('‚ùå Error initializing global functions:', e);
        }
        
        let updateInterval;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞
        function detectDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            const isSmallScreen = window.innerWidth <= 768;
            return isMobile || isSmallScreen;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        function toggleMobileMode() {
            const body = document.body;
            const isMobile = body.classList.contains('mobile-mode');
            const modeToggle = document.getElementById('modeToggle');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            if (isMobile) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø
                body.classList.remove('mobile-mode');
                modeIcon.textContent = 'üì±';
                modeText.textContent = 'Mobile';
                modeToggle.classList.remove('mobile-active');
                localStorage.setItem('adminPanelMode', 'desktop');
            } else {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–π
                body.classList.add('mobile-mode');
                modeIcon.textContent = 'üíª';
                modeText.textContent = 'Desktop';
                modeToggle.classList.add('mobile-active');
                localStorage.setItem('adminPanelMode', 'mobile');
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ Plotly –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
            if (typeof Plotly !== 'undefined') {
                setTimeout(() => {
                    const chartContainer = document.getElementById('chart-container');
                    if (chartContainer && chartContainer.querySelector('.plotly')) {
                        Plotly.Plots.resize(chartContainer);
                    }
                }, 100);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initMobileMode() {
            const savedMode = localStorage.getItem('adminPanelMode');
            const isMobileDevice = detectDevice();
            const body = document.body;
            const modeToggle = document.getElementById('modeToggle');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            if (!savedMode) {
                if (isMobileDevice) {
                    body.classList.add('mobile-mode');
                    modeIcon.textContent = 'üíª';
                    modeText.textContent = 'Desktop';
                    modeToggle.classList.add('mobile-active');
                    localStorage.setItem('adminPanelMode', 'mobile');
                } else {
                    body.classList.remove('mobile-mode');
                    modeIcon.textContent = 'üì±';
                    modeText.textContent = 'Mobile';
                    modeToggle.classList.remove('mobile-active');
                    localStorage.setItem('adminPanelMode', 'desktop');
                }
            } else {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
                if (savedMode === 'mobile') {
                    body.classList.add('mobile-mode');
                    modeIcon.textContent = 'üíª';
                    modeText.textContent = 'Desktop';
                    modeToggle.classList.add('mobile-active');
                } else {
                    body.classList.remove('mobile-mode');
                    modeIcon.textContent = 'üì±';
                    modeText.textContent = 'Mobile';
                    modeToggle.classList.remove('mobile-active');
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (typeof Plotly !== 'undefined') {
                        const chartContainer = document.getElementById('chart-container');
                        if (chartContainer && chartContainer.querySelector('.plotly')) {
                            Plotly.Plots.resize(chartContainer);
                        }
                    }
                }, 250);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            initMobileMode();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (typeof loadWalletData === 'function') {
                loadWalletData();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (typeof loadCombinedPnlStats === 'function') {
                loadCombinedPnlStats();
            }
        });

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é showTab –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.showTab = function(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑–≤–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏—é
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // –ï—Å–ª–∏ event –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –Ω–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ tabName
                const buttons = document.querySelectorAll('.tab');
                buttons.forEach(btn => {
                    if (btn.textContent.trim() === tabName || btn.getAttribute('onclick')?.includes(`'${tabName}'`) || btn.getAttribute('onclick')?.includes(`"${tabName}"`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ Symbols
            if (tabName === 'symbols') {
                if (typeof loadSymbolSettings !== 'undefined') {
                    loadSymbolSettings();
                }
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                if (typeof loadSymbolsStatus !== 'undefined') {
                    loadSymbolsStatus();
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
            if (tabName === 'trades') {
                if (typeof loadTrades !== 'undefined') {
                    loadTrades();
                }
            } else if (tabName === 'signals') {
                if (typeof loadSignals !== 'undefined') {
                    loadSignals();
                }
            } else if (tabName === 'dashboard') {
                // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                if (typeof loadSymbolsStatus !== 'undefined') {
                    loadSymbolsStatus();
                }
            }
            
            if (tabName === 'strategy' || tabName === 'risk') {
                loadSettings();
            } else if (tabName === 'strategies') {
                loadStrategySelection();
                loadStrategyStats();
                loadMLModelInfo();
                if (typeof loadAllPairsModelsInfo !== 'undefined') {
                    loadAllPairsModelsInfo();
                }
            } else if (tabName === 'trades') {
                loadTrades();
            } else if (tabName === 'signals') {
                loadSignals();
            } else if (tabName === 'settings') {
                loadBybitApiSettings();
            }
        }
        
        async function updateStatus() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`/api/status?symbol=${encodeURIComponent(selectedSymbol)}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
                if (data.pnl_stats) {
                    window.currentPnlStats = data.pnl_stats;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
                if (!data || data.error) {
                    console.error('API returned error:', data?.error || 'Unknown error');
                    const statusElement = document.getElementById('current-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<span style="color: #ff4444;">API Error</span>';
                    }
                    return;
                }
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ)
                // –î–ª—è multi-symbol —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é primarySymbolSelect
                const activeSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : (data.account?.primary_symbol || data.account?.symbol || 'BTCUSDT'));
                
                let botStatus = data.bot_status || {};
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                    const symbolStatus = data.symbols_status[activeSymbol];
                    botStatus = {
                        is_running: symbolStatus.is_running || botStatus.is_running || false,
                        current_status: symbolStatus.status || symbolStatus.current_status || botStatus.current_status || 'Stopped',
                        current_phase: symbolStatus.current_phase || botStatus.current_phase || '-',  // –§–∞–∑–∞ —Ä—ã–Ω–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                        current_adx: symbolStatus.current_adx !== undefined && symbolStatus.current_adx !== null ? symbolStatus.current_adx : (botStatus.current_adx || '-'),  // ADX –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                        last_action: symbolStatus.last_action || botStatus.last_action || '-',
                        last_action_time: symbolStatus.last_action_time || botStatus.last_action_time,
                        last_signal: symbolStatus.last_signal || botStatus.last_signal || '-',
                        last_signal_time: symbolStatus.last_signal_time || botStatus.last_signal_time,
                        last_error: symbolStatus.last_error || botStatus.last_error,
                        last_error_time: symbolStatus.last_error_time || botStatus.last_error_time,
                        last_update: botStatus.last_update || new Date().toISOString()
                    };
                }
                
                const botStatusEl = document.getElementById('bot-status');
                if (botStatusEl) {
                    botStatusEl.innerHTML = 
                        `<span class="status-indicator ${botStatus.is_running ? 'running' : 'stopped'}"></span>${botStatus.is_running ? 'Running' : 'Stopped'}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                const statusText = botStatus.current_status || 'Unknown';
                const statusColor = statusText === 'Running' ? '#00ff88' : 
                                   statusText === 'Analyzing' ? '#00d4ff' : 
                                   statusText === 'Fetching Data' ? '#00aaff' :
                                   statusText === 'Signal Found' ? '#ffaa00' : 
                                   statusText === 'Order Placed' ? '#00ff88' : 
                                   statusText === 'Error' ? '#ff4444' : '#aaa';
                const currentStatusEl = document.getElementById('current-status');
                if (currentStatusEl) {
                    currentStatusEl.innerHTML = `<span style="color: ${statusColor};">${statusText}</span>`;
                }
                
                // –§–∞–∑–∞ —Ä—ã–Ω–∫–∞ (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ bot_status)
                const phase = botStatus.current_phase;
                let phaseValue = '-';
                if (phase && phase !== '-' && phase !== null && phase !== undefined) {
                    phaseValue = String(phase).toLowerCase();
                }
                const phaseColor = phaseValue === 'trend' ? '#00ff88' : phaseValue === 'flat' ? '#ffaa00' : '#aaa';
                const marketPhaseEl = document.getElementById('market-phase');
                if (marketPhaseEl) {
                    marketPhaseEl.innerHTML = phaseValue !== '-' ? `<span style="color: ${phaseColor};">${phaseValue.toUpperCase()}</span>` : '-';
                }
                
                // ADX (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ bot_status)
                const adxEl = document.getElementById('current-adx');
                if (adxEl) {
                    const adxValue = botStatus.current_adx;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ adxValue - —ç—Ç–æ —á–∏—Å–ª–æ (–Ω–µ null, –Ω–µ undefined, –Ω–µ NaN, –Ω–µ —Å—Ç—Ä–æ–∫–∞ '-')
                    if (adxValue !== null && adxValue !== undefined && adxValue !== '-' && !isNaN(adxValue) && adxValue !== '') {
                        const adxNum = parseFloat(adxValue);
                        if (!isNaN(adxNum)) {
                            adxEl.textContent = adxNum.toFixed(2);
                        } else {
                            adxEl.textContent = '-';
                        }
                    } else {
                        adxEl.textContent = '-';
                    }
                }
                
                // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
                const lastActionEl = document.getElementById('last-action');
                if (lastActionEl) {
                    lastActionEl.textContent = botStatus.last_action || '-';
                }
                
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
                const lastSignal = botStatus.last_signal || '-';
                const lastSignalTime = botStatus.last_signal_time ? 
                    convertToMSK(botStatus.last_signal_time) : '';
                const lastSignalEl = document.getElementById('last-signal');
                if (lastSignalEl) {
                    lastSignalEl.textContent = 
                        lastSignal !== '-' ? `${lastSignal}${lastSignalTime ? ' (' + lastSignalTime + ')' : ''}` : '-';
                }
                
                const lastUpdateEl = document.getElementById('last-update');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = botStatus.last_update ? convertToMSK(botStatus.last_update) : '-';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º activeSymbol –∏–∑ –∫–æ–¥–∞ –≤—ã—à–µ)
                const account = data.account || {};
                const symbolEl = document.getElementById('symbol');
                if (symbolEl) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (—É–∂–µ –ø–æ–ª—É—á–µ–Ω –≤—ã—à–µ)
                    symbolEl.textContent = activeSymbol;
                }
                const leverageEl = document.getElementById('leverage');
                if (leverageEl) {
                    leverageEl.textContent = account.leverage ? `${account.leverage}x` : '-';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏)
                // –ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ symbols_status –≤—ã—à–µ
                if (typeof loadWalletData === 'function') {
                    try {
                        loadWalletData();
                    } catch (e) {
                        console.warn('Error in loadWalletData:', e);
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏–∑ symbols_status
                let positionData = null;
                // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    const symbolStatus = data.symbols_status[activeSymbol];
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ position —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π, –∏ —á—Ç–æ size > 0
                    if (symbolStatus.position && symbolStatus.position.side && (symbolStatus.position.size > 0 || symbolStatus.position.size)) {
                        positionData = {
                            side: symbolStatus.position.side || null,
                            size: symbolStatus.position.size || 0,
                            avg_price: symbolStatus.position.avg_price || 0,
                            mark_price: symbolStatus.position.mark_price || symbolStatus.position.avg_price || 0,
                            unrealised_pnl: symbolStatus.position.unrealised_pnl || 0,
                            take_profit: symbolStatus.position.take_profit || symbolStatus.position.takeProfit || '',
                            stop_loss: symbolStatus.position.stop_loss || symbolStatus.position.stopLoss || '',
                            leverage: symbolStatus.position.leverage || account.leverage || 1
                        };
                    }
                }
                // –ù–µ—Ç fallback –Ω–∞ data.position - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                if (positionData && positionData.side) {
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–æ
                    const side = positionData.side || 'None';
                    const size = parseFloat(positionData.size) || 0;
                    const avgPrice = parseFloat(positionData.avg_price) || 0;
                    const markPrice = parseFloat(positionData.mark_price) || 0;
                    const pnl = parseFloat(positionData.unrealised_pnl) || 0;
                    const currentPrice = markPrice || avgPrice || 0;
                    const leverage = parseFloat(account?.leverage || positionData?.leverage || 1) || 1;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL%
                    const isLong = side.toLowerCase() === 'long' || side === 'Buy';
                    
                    const positionSideEl = document.getElementById('position-side');
                    if (positionSideEl) {
                        const sideText = isLong ? 'long' : (side.toLowerCase() === 'short' || side === 'Sell' ? 'short' : side);
                        positionSideEl.textContent = sideText;
                        // –¶–≤–µ—Ç–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ: long - –∑–µ–ª–µ–Ω—ã–º, short - –∫—Ä–∞—Å–Ω—ã–º
                        positionSideEl.style.color = isLong ? '#00ff88' : '#ff4444';
                        positionSideEl.style.fontWeight = 'bold';
                    }
                    
                    const positionSizeEl = document.getElementById('position-size');
                    if (positionSizeEl) {
                        positionSizeEl.textContent = size > 0 ? size.toFixed(3) : '-';
                    }
                    
                    const positionEntryEl = document.getElementById('position-entry');
                    if (positionEntryEl) {
                        positionEntryEl.textContent = avgPrice > 0 ? `$${avgPrice.toFixed(2)}` : '-';
                    }
                    
                    const positionCurrentPriceEl = document.getElementById('position-current-price');
                    if (positionCurrentPriceEl) {
                        positionCurrentPriceEl.textContent = currentPrice > 0 ? `$${currentPrice.toFixed(2)}` : '-';
                    }
                    
                    const positionPnlEl = document.getElementById('position-pnl');
                    if (positionPnlEl) {
                        positionPnlEl.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} USDT`;
                        positionPnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // PnL % –æ—Ç –º–∞—Ä–∂–∏ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞
                    let pnlPct = 0;
                    if (size > 0 && avgPrice > 0 && leverage > 0) {
                        // –ú–∞—Ä–∂–∞ = (Size * Entry Price) / Leverage
                        const margin = (size * avgPrice) / leverage;
                        if (margin > 0) {
                            // PnL% –æ—Ç –º–∞—Ä–∂–∏ = (Unrealised PnL / Margin) * 100
                            pnlPct = (pnl / margin) * 100;
                        }
                    }
                    
                    const positionPnlPctEl = document.getElementById('position-pnl-pct');
                    if (positionPnlPctEl) {
                        positionPnlPctEl.textContent = `${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%`;
                        positionPnlPctEl.className = `stat-value ${pnlPct >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // TP/SL (–∏–∑ positionData –∏–ª–∏ –∏–∑ data.position –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                    const tp = positionData.take_profit || positionData.takeProfit || (data.position?.take_profit || data.position?.takeProfit || '');
                    const sl = positionData.stop_loss || positionData.stopLoss || (data.position?.stop_loss || data.position?.stopLoss || '');
                    const tpValue = tp ? parseFloat(tp) : null;
                    const slValue = sl ? parseFloat(sl) : null;
                    
                    const positionTpEl = document.getElementById('position-tp');
                    if (positionTpEl) {
                        positionTpEl.textContent = tpValue ? `$${tpValue.toFixed(2)}` : 'Not set';
                        positionTpEl.style.color = tpValue ? '#00ff88' : '#ffaa00';
                    }
                    
                    const positionSlEl = document.getElementById('position-sl');
                    if (positionSlEl) {
                        positionSlEl.textContent = slValue ? `$${slValue.toFixed(2)}` : 'Not set';
                        positionSlEl.style.color = slValue ? '#ff4444' : '#ffaa00';
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Å–∏–≥–Ω–∞–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
                    const entryReason = positionData.entry_reason || (data.position?.entry_reason) || '';
                    const strategyType = positionData.strategy_type || (data.position?.strategy_type) || '';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    let strategyDisplay = 'Unknown';
                    if (strategyType) {
                        const strategyMap = {
                            'ml': 'ü§ñ ML Strategy',
                            'trend': 'üìà Trend Strategy',
                            'flat': 'üìä Flat Strategy',
                            'momentum': '‚ö° Momentum Strategy',
                            'liquidity': 'üíß Liquidity Sweep',
                            'hybrid': 'üîÑ Hybrid',
                            'unknown': 'Unknown'
                        };
                        strategyDisplay = strategyMap[strategyType.toLowerCase()] || strategyType.toUpperCase();
                    }
                    
                    const positionStrategyEl = document.getElementById('position-strategy');
                    const positionStrategyContainer = document.getElementById('position-strategy-container');
                    if (positionStrategyEl && positionStrategyContainer) {
                        if (strategyType) {
                            positionStrategyEl.textContent = strategyDisplay;
                            positionStrategyEl.style.color = '#00d4ff';
                            positionStrategyContainer.style.display = 'flex';
                        } else {
                            positionStrategyContainer.style.display = 'none';
                        }
                    }
                    
                    const positionEntrySignalEl = document.getElementById('position-entry-signal');
                    const positionEntrySignalContainer = document.getElementById('position-entry-signal-container');
                    if (positionEntrySignalEl && positionEntrySignalContainer) {
                        if (entryReason) {
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º reason –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                            let formattedReason = entryReason;
                            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
                            formattedReason = formattedReason.replace(/^(ml_|trend_|range_|momentum_|liquidity_)/, '');
                            // –ó–∞–º–µ–Ω—è–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
                            formattedReason = formattedReason.replace(/_/g, ' ');
                            // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
                            formattedReason = formattedReason.charAt(0).toUpperCase() + formattedReason.slice(1);
                            
                            positionEntrySignalEl.textContent = formattedReason;
                            positionEntrySignalEl.style.color = '#aaa';
                            positionEntrySignalContainer.style.display = 'flex';
                        } else {
                            positionEntrySignalContainer.style.display = 'none';
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
                    const closeButtonContainer = document.getElementById('position-close-button-container');
                    if (closeButtonContainer) {
                        closeButtonContainer.style.display = 'block';
                    }
                } else {
                    // –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ - –æ—á–∏—â–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const positionElements = ['position-side', 'position-size', 'position-entry', 'position-current-price', 'position-pnl', 'position-pnl-pct', 'position-tp', 'position-sl', 'position-strategy', 'position-entry-signal'];
                    positionElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            if (id === 'position-pnl' || id === 'position-pnl-pct') {
                                el.textContent = '-';
                                el.className = 'stat-value';
                            } else if (id === 'position-tp' || id === 'position-sl') {
                                el.textContent = '-';
                                el.style.color = '#aaa';
                            } else if (id === 'position-side') {
                                el.textContent = 'None';
                                el.style.color = '#aaa';
                                el.style.fontWeight = 'normal';
                            } else {
                                el.textContent = '-';
                            }
                        }
                    });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    const closeButtonContainer = document.getElementById('position-close-button-container');
                    if (closeButtonContainer) {
                        closeButtonContainer.style.display = 'none';
                    }
                    const positionStrategyContainer = document.getElementById('position-strategy-container');
                    if (positionStrategyContainer) {
                        positionStrategyContainer.style.display = 'none';
                    }
                    const positionEntrySignalContainer = document.getElementById('position-entry-signal-container');
                    if (positionEntrySignalContainer) {
                        positionEntrySignalContainer.style.display = 'none';
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ä–¥–µ—Ä–∞—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                let ordersCount = 0;
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                    ordersCount = data.symbols_status[activeSymbol].open_orders || 0;
                } else if (activeSymbol === (data.account?.primary_symbol || data.account?.symbol)) {
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º data.open_orders —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å primary_symbol
                    ordersCount = typeof data.open_orders === 'number' ? data.open_orders : (data.open_orders?.count || 0);
                }
                
                const openOrdersEl = document.getElementById('open-orders');
                if (openOrdersEl) {
                    openOrdersEl.textContent = ordersCount;
                }
                const ordersMargin = data.open_orders?.margin_used || 0;
                const ordersMarginEl = document.getElementById('orders-margin');
                if (ordersMarginEl) {
                    ordersMarginEl.textContent = ordersMargin > 0 ? `${ordersMargin.toFixed(2)} USDT` : '-';
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º TP –æ—Ä–¥–µ—Ä–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞)
                const tpOrdersList = document.getElementById('tp-orders-list');
                if (tpOrdersList) {
                    const ordersData = data.open_orders || {};
                    if (ordersData.tp_orders && Array.isArray(ordersData.tp_orders) && ordersData.tp_orders.length > 0) {
                        let tpHtml = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;"><div style="color: #00ff88; font-weight: bold; margin-bottom: 8px; font-size: 0.95em;">Take Profit Orders:</div>';
                        ordersData.tp_orders.forEach((tp, idx) => {
                            const triggerPrice = parseFloat(tp.trigger_price || tp.price || 0);
                            const qty = parseFloat(tp.qty || 0);
                            const side = tp.side || 'N/A';
                            const margin = parseFloat(tp.margin || 0);
                            
                            tpHtml += `<div style="margin-left: 10px; margin-bottom: 6px; padding: 8px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #00ff88; font-size: 0.9em;">`;
                            tpHtml += `<div style="margin-bottom: 4px;"><span style="color: #aaa;">TP ${idx + 1}:</span> <span style="color: #00ff88; font-weight: bold;">$${triggerPrice.toFixed(2)}</span></div>`;
                            tpHtml += `<div style="font-size: 0.85em; color: #888;">`;
                            tpHtml += `Side: <span style="color: ${side.toUpperCase() === 'BUY' ? '#00ff88' : '#ff4444'}">${side}</span> | `;
                            tpHtml += `Qty: ${qty.toFixed(3)} | `;
                            tpHtml += `Margin: <span style="color: #ffaa00;">${margin.toFixed(2)} USDT</span>`;
                            tpHtml += `</div></div>`;
                        });
                        tpHtml += '</div>';
                        tpOrdersList.innerHTML = tpHtml;
                    } else {
                        tpOrdersList.innerHTML = '';
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º SL –æ—Ä–¥–µ—Ä–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞)
                const slOrdersList = document.getElementById('sl-orders-list');
                if (slOrdersList) {
                    const ordersData = data.open_orders || {};
                    if (ordersData.sl_orders && Array.isArray(ordersData.sl_orders) && ordersData.sl_orders.length > 0) {
                        let slHtml = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;"><div style="color: #ff4444; font-weight: bold; margin-bottom: 8px; font-size: 0.95em;">Stop Loss Orders:</div>';
                        ordersData.sl_orders.forEach((sl, idx) => {
                            const triggerPrice = parseFloat(sl.trigger_price || sl.price || 0);
                            const qty = parseFloat(sl.qty || 0);
                            const side = sl.side || 'N/A';
                            const margin = parseFloat(sl.margin || 0);
                            
                            slHtml += `<div style="margin-left: 10px; margin-bottom: 6px; padding: 8px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #ff4444; font-size: 0.9em;">`;
                            slHtml += `<div style="margin-bottom: 4px;"><span style="color: #aaa;">SL ${idx + 1}:</span> <span style="color: #ff4444; font-weight: bold;">$${triggerPrice.toFixed(2)}</span></div>`;
                            slHtml += `<div style="font-size: 0.85em; color: #888;">`;
                            slHtml += `Side: <span style="color: ${side.toUpperCase() === 'BUY' ? '#00ff88' : '#ff4444'}">${side}</span> | `;
                            slHtml += `Qty: ${qty.toFixed(3)} | `;
                            slHtml += `Margin: <span style="color: #ffaa00;">${margin.toFixed(2)} USDT</span>`;
                            slHtml += `</div></div>`;
                        });
                        slHtml += '</div>';
                        slOrdersList.innerHTML = slHtml;
                    } else {
                        slOrdersList.innerHTML = '';
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                if (typeof loadSymbolsStatus === 'function') {
                    try {
                        loadSymbolsStatus();
                    } catch (e) {
                        console.warn('Error in loadSymbolsStatus:', e);
                    }
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.warn('Error updating status: Server unavailable or network error');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "Error" –≤ UI
                    const statusElement = document.getElementById('current-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<span style="color: #ff4444;">Connection Error</span>';
                    }
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error updating status: Invalid JSON response', error);
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error updating status:', error);
                }
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            }
        }
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const strategyForm = generateStrategyForm(data.strategy);
                document.getElementById('strategy-form').innerHTML = strategyForm;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–∏—Å–∫–∞
                const riskForm = generateRiskForm(data.risk, data.app);
                document.getElementById('risk-form').innerHTML = riskForm;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function generateStrategyForm(strategy) {
            return `
                <form onsubmit="saveSettings(event, 'strategy')">
                    <div class="form-group">
                        <label>ADX Threshold:</label>
                        <input type="number" name="adx_threshold" value="${strategy.adx_threshold}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ADX Length:</label>
                        <input type="number" name="adx_length" value="${strategy.adx_length}">
                    </div>
                    <div class="form-group">
                        <label>DI Length:</label>
                        <input type="number" name="di_length" value="${strategy.di_length}">
                    </div>
                    <div class="form-group">
                        <label>Breakout Lookback:</label>
                        <input type="number" name="breakout_lookback" value="${strategy.breakout_lookback}">
                    </div>
                    <div class="form-group">
                        <label>Breakout Volume Multiplier:</label>
                        <input type="number" name="breakout_volume_mult" value="${strategy.breakout_volume_mult}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>SMA Length:</label>
                        <input type="number" name="sma_length" value="${strategy.sma_length}">
                    </div>
                    <div class="form-group">
                        <label>Pullback Tolerance:</label>
                        <input type="number" name="pullback_tolerance" value="${strategy.pullback_tolerance}" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label>RSI Length:</label>
                        <input type="number" name="rsi_length" value="${strategy.rsi_length}">
                    </div>
                    <div class="form-group">
                        <label>RSI Floor:</label>
                        <input type="number" name="rsi_floor" value="${strategy.rsi_floor}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>RSI Ceiling:</label>
                        <input type="number" name="rsi_ceiling" value="${strategy.rsi_ceiling}" step="0.1">
                    </div>
                    <h3 style="margin-top: 20px; color: #00d4ff;">Range Strategy</h3>
                    <div class="form-group">
                        <label>BB Length:</label>
                        <input type="number" name="bb_length" value="${strategy.bb_length}">
                    </div>
                    <div class="form-group">
                        <label>BB Std:</label>
                        <input type="number" name="bb_std" value="${strategy.bb_std}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range RSI Oversold:</label>
                        <input type="number" name="range_rsi_oversold" value="${strategy.range_rsi_oversold}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range RSI Overbought:</label>
                        <input type="number" name="range_rsi_overbought" value="${strategy.range_rsi_overbought}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range Volume Multiplier:</label>
                        <input type="number" name="range_volume_mult" value="${strategy.range_volume_mult}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range TP Aggressive:</label>
                        <input type="checkbox" name="range_tp_aggressive" ${strategy.range_tp_aggressive ? 'checked' : ''}>
                    </div>
                    <div class="form-group">
                        <label>Range Stop Loss %:</label>
                        <input type="number" name="range_stop_loss_pct" value="${strategy.range_stop_loss_pct}" step="0.001">
                    </div>
                    <button type="submit" class="btn">Save Strategy Settings</button>
                </form>
            `;
        }
        
        function generateRiskForm(risk, app) {
            return `
                <form onsubmit="saveSettings(event, 'risk')">
                    <div class="form-group">
                        <label>Max Position USD:</label>
                        <input type="number" name="max_position_usd" value="${risk.max_position_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Base Order USD:</label>
                        <input type="number" name="base_order_usd" value="${risk.base_order_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Add Order USD:</label>
                        <input type="number" name="add_order_usd" value="${risk.add_order_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Stop Loss %:</label>
                        <input type="number" name="stop_loss_pct" value="${risk.stop_loss_pct}" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>Take Profit %:</label>
                        <input type="number" name="take_profit_pct" value="${risk.take_profit_pct}" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>Balance % Per Trade:</label>
                        <input type="number" name="balance_percent_per_trade" value="${risk.balance_percent_per_trade}" step="0.1">
                    </div>
                    <h3 style="margin-top: 20px; color: #00d4ff;">App Settings</h3>
                    <div class="form-group">
                        <label>Symbol:</label>
                        <input type="text" name="symbol" value="${app.symbol}">
                    </div>
                    <div class="form-group">
                        <label>Timeframe:</label>
                        <input type="text" name="timeframe" value="${app.timeframe}">
                    </div>
                    <div class="form-group">
                        <label>Leverage:</label>
                        <input type="number" name="leverage" value="${app.leverage}">
                    </div>
                    <div class="form-group">
                        <label>Live Poll Seconds:</label>
                        <input type="number" name="live_poll_seconds" value="${app.live_poll_seconds}">
                    </div>
                    <h3 style="margin-top: 20px; color: #9933ff;">ML Strategy Settings</h3>
                    <div class="form-group">
                        <label>ML Confidence Threshold (0-1):</label>
                        <input type="number" name="ml_confidence_threshold" value="${app.ml_confidence_threshold}" step="0.01" min="0" max="1">
                        <small style="color: #aaa; display: block; margin-top: 4px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ML –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (0.0 - 1.0)</small>
                    </div>
                    <div class="form-group">
                        <label>ML Min Signal Strength:</label>
                        <select name="ml_min_signal_strength" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="—Å–ª–∞–±–æ–µ" ${app.ml_min_signal_strength === '—Å–ª–∞–±–æ–µ' ? 'selected' : ''}>–°–ª–∞–±–æ–µ (0%)</option>
                            <option value="—É–º–µ—Ä–µ–Ω–Ω–æ–µ" ${app.ml_min_signal_strength === '—É–º–µ—Ä–µ–Ω–Ω–æ–µ' ? 'selected' : ''}>–£–º–µ—Ä–µ–Ω–Ω–æ–µ (60%)</option>
                            <option value="—Å—Ä–µ–¥–Ω–µ–µ" ${app.ml_min_signal_strength === '—Å—Ä–µ–¥–Ω–µ–µ' ? 'selected' : ''}>–°—Ä–µ–¥–Ω–µ–µ (70%)</option>
                            <option value="—Å–∏–ª—å–Ω–æ–µ" ${app.ml_min_signal_strength === '—Å–∏–ª—å–Ω–æ–µ' ? 'selected' : ''}>–°–∏–ª—å–Ω–æ–µ (80%)</option>
                            <option value="–æ—á–µ–Ω—å_—Å–∏–ª—å–Ω–æ–µ" ${app.ml_min_signal_strength === '–æ—á–µ–Ω—å_—Å–∏–ª—å–Ω–æ–µ' ? 'selected' : ''}>–û—á–µ–Ω—å —Å–∏–ª—å–Ω–æ–µ (90%)</option>
                        </select>
                        <small style="color: #aaa; display: block; margin-top: 4px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è</small>
                    </div>
                    <div class="form-group">
                        <label>ML Stability Filter:</label>
                        <input type="checkbox" name="ml_stability_filter" ${app.ml_stability_filter ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <small style="color: #aaa; display: block; margin-top: 4px;">–¢—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Å–º–µ–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏</small>
                    </div>
                    <button type="submit" class="btn">Save Risk Settings</button>
                </form>
            `;
        }
        
        async function saveSettings(event, section) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º checkbox, –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ
                if (key === 'range_tp_aggressive') {
                    continue;
                }
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—É—é –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –¥—Ä–æ–±–µ–π (–¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
                const normalizedValue = String(value).replace(',', '.');
                const numValue = parseFloat(normalizedValue);
                data[key] = isNaN(numValue) ? value : numValue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º checkbox –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è strategy —Å–µ–∫—Ü–∏–∏
            if (section === 'strategy') {
                const checkbox = event.target.querySelector('[name="range_tp_aggressive"]');
                if (checkbox) {
                    data.range_tp_aggressive = checkbox.checked;
                }
            }
            
            try {
                const payload = { [section]: data };
                if (section === 'risk') {
                    // –î–æ–±–∞–≤–ª—è–µ–º app settings –≤ risk —Ñ–æ—Ä–º—É
                    payload.app = {};
                    for (const [key, value] of formData.entries()) {
                        if (['symbol', 'timeframe', 'leverage', 'live_poll_seconds', 'ml_confidence_threshold', 'ml_min_signal_strength', 'ml_stability_filter'].includes(key)) {
                            if (key === 'ml_stability_filter') {
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º checkbox –æ—Ç–¥–µ–ª—å–Ω–æ
                                payload.app[key] = event.target.querySelector('[name="ml_stability_filter"]').checked;
                            } else if (key === 'ml_confidence_threshold') {
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—É—é –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –¥—Ä–æ–±–µ–π (–¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
                                const normalizedValue = String(value).replace(',', '.');
                                const numValue = parseFloat(normalizedValue);
                                payload.app[key] = isNaN(numValue) ? value : numValue;
                            } else if (key === 'ml_min_signal_strength') {
                                payload.app[key] = value; // –°—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            } else {
                                const numValue = parseFloat(value);
                                payload.app[key] = isNaN(numValue) ? value : numValue;
                            }
                        }
                    }
                }
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    const sectionName = section === 'strategy' ? 'Strategy Settings' : section === 'risk' ? 'Risk Management Settings' : 'Settings';
                    alert(`${sectionName} saved successfully!`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    if (section === 'strategy' || section === 'risk') {
                        loadSettings();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }
        
        async function removeDuplicateTrades() {
            try {
                const response = await fetch('/api/trades/remove-duplicates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Removed ${data.removed_count} duplicate trades. Refreshing list...`);
                    loadTrades(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫
                } else {
                    alert(`Error removing duplicates: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error removing duplicate trades:', error);
                alert('Error removing duplicate trades. Check console for details.');
            }
        }
        
        async function loadTrades() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
                const symbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = symbolSelect ? symbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º symbol
                const url = `/api/trades?symbol=${encodeURIComponent(selectedSymbol)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —Ç–µ—Å—Ç–Ω–µ—Ç (–∏–∑ API –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                const isTestnet = data.is_testnet !== undefined ? data.is_testnet : true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL
                if (data.pnl_stats) {
                    const stats = data.pnl_stats;
                    
                    // PnL —Å–µ–≥–æ–¥–Ω—è
                    const pnlToday = parseFloat(stats.pnl_today || 0);
                    document.getElementById('pnl-today').textContent = `${pnlToday >= 0 ? '+' : ''}${pnlToday.toFixed(2)} USDT`;
                    document.getElementById('pnl-today').className = `stat-value ${pnlToday >= 0 ? 'positive' : 'negative'}`;
                    
                    // PnL –∑–∞ –Ω–µ–¥–µ–ª—é
                    const pnlWeek = parseFloat(stats.pnl_week || 0);
                    document.getElementById('pnl-week').textContent = `${pnlWeek >= 0 ? '+' : ''}${pnlWeek.toFixed(2)} USDT`;
                    document.getElementById('pnl-week').className = `stat-value ${pnlWeek >= 0 ? 'positive' : 'negative'}`;
                    
                    // PnL –∑–∞ –º–µ—Å—è—Ü
                    const pnlMonth = parseFloat(stats.pnl_month || 0);
                    document.getElementById('pnl-month').textContent = `${pnlMonth >= 0 ? '+' : ''}${pnlMonth.toFixed(2)} USDT`;
                    document.getElementById('pnl-month').className = `stat-value ${pnlMonth >= 0 ? 'positive' : 'negative'}`;
                    
                    // –û–±—â–∏–π PnL –ø–æ –ø–∞—Ä–µ
                    const pnlTotal = parseFloat(stats.pnl_total || 0);
                    document.getElementById('pnl-total').textContent = `${pnlTotal >= 0 ? '+' : ''}${pnlTotal.toFixed(2)} USDT`;
                    document.getElementById('pnl-total').className = `stat-value ${pnlTotal >= 0 ? 'positive' : 'negative'}`;
                }
                
                if (data.trades.length === 0) {
                    document.getElementById('trades-table').innerHTML = '<p style="color: #aaa; padding: 20px;">No trades yet</p>';
                    return;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ frontend (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ backend –≤–µ—Ä–Ω–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã—Ö–æ–¥–∞ –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
                const sortedTrades = [...data.trades].sort((a, b) => {
                    const timeA = a.exit_time ? new Date(a.exit_time) : new Date(0);
                    const timeB = b.exit_time ? new Date(b.exit_time) : new Date(0);
                    return timeB - timeA; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
                });
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Time</th><th>Pair</th><th>Strategy</th><th>Side</th><th>Entry</th><th>Exit</th><th>Size</th><th>PnL</th><th>Order ID</th></tr></thead><tbody>';
                sortedTrades.forEach(trade => {
                    const strategyType = (trade.strategy_type || 'unknown').toLowerCase();
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let strategyDisplay = 'UNKNOWN';
                    let strategyColor = '#aaa';
                    if (strategyType === 'trend') {
                        strategyDisplay = 'TREND';
                        strategyColor = '#00ff88';
                    } else if (strategyType === 'flat') {
                        strategyDisplay = 'FLAT';
                        strategyColor = '#ffaa00';
                    } else if (strategyType === 'ml') {
                        strategyDisplay = 'ML';
                        strategyColor = '#9933ff';
                    } else if (strategyType === 'hybrid') {
                        strategyDisplay = 'HYBRID';
                        strategyColor = '#00d4ff';
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏)
                    const exitTimeStr = trade.exit_time ? convertToMSK(trade.exit_time) : '-';
                    
                    // –ü–æ–ª—É—á–∞–µ–º orderId –∏ orderLinkId
                    const orderId = trade.order_id || trade.order_link_id || null;
                    const orderLinkId = trade.order_link_id || null;
                    const symbol = trade.symbol || 'SOLUSDT';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è Order ID (–ø—Ä–∏ –∫–ª–∏–∫–µ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞)
                    // Order ID - —ç—Ç–æ ID –æ—Ä–¥–µ—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (market order, TP –∏–ª–∏ SL)
                    let orderIdDisplay = '-';
                    if (orderId && orderId !== '-' && orderId !== null && orderId !== '') {
                        const shortId = orderId.length > 16 ? orderId.substring(0, 16) + '...' : orderId;
                        orderIdDisplay = `<span onclick="copyToClipboard('${orderId}', this)" style="cursor: pointer; color: #00d4ff; text-decoration: underline; font-family: monospace; font-size: 0.9em;" title="Click to copy Order ID">${shortId}</span>`;
                    } else if (orderLinkId && orderLinkId !== '-' && orderLinkId !== null && orderLinkId !== '') {
                        // –ï—Å–ª–∏ orderId –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å orderLinkId, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –±–æ—Ç–∞)
                        const shortId = orderLinkId.length > 16 ? orderLinkId.substring(0, 16) + '...' : orderLinkId;
                        orderIdDisplay = `<span onclick="copyToClipboard('${orderLinkId}', this)" style="cursor: pointer; color: #888; text-decoration: underline; font-family: monospace; font-size: 0.9em;" title="Click to copy Order Link ID (Internal)">${shortId}</span>`;
                    }
                    
                    html += `<tr>
                        <td>${exitTimeStr}</td>
                        <td>${symbol}</td>
                        <td><span style="color: ${strategyColor}; font-weight: bold;">${strategyDisplay}</span></td>
                        <td>${trade.side}</td>
                        <td>$${trade.entry_price?.toFixed(2) || '-'}</td>
                        <td>$${trade.exit_price?.toFixed(2) || '-'}</td>
                        <td>$${trade.size_usd?.toFixed(2) || '-'}</td>
                        <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl?.toFixed(2) || '0.00'}</td>
                        <td>${orderIdDisplay}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                document.getElementById('trades-table').innerHTML = html;
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        async function loadSMCHistory() {
            try {
                const response = await fetch('/api/smc/history?limit=100');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load SMC history');
                }
                
                const data = result.history || [];
                
                const countSpan = document.getElementById('smc-count');
                if (countSpan) {
                    countSpan.textContent = `(${data.length} signal${data.length !== 1 ? 's' : ''} found)`;
                    countSpan.style.color = data.length > 0 ? '#00ff88' : '#aaa';
                }
                
                if (data.length === 0) {
                    document.getElementById('smc-history-table').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #aaa;">
                            <p style="font-size: 1.2em; margin-bottom: 10px;">üìä No SMC signals yet</p>
                            <p style="font-size: 0.9em;">Signals will appear here once the SMC strategy starts generating entries</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #2a2a2a;">';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Time (MSK)</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Pair</th>';
                html += '<th style="padding: 12px; text-align: center; border-bottom: 2px solid #444;">Action</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">Entry</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">SL</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">TP</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Zone Type</th>';
                html += '<th style="padding: 12px; text-align: center; border-bottom: 2px solid #444;">RR</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach((sig, idx) => {
                    const actionColor = sig.action === 'LONG' ? '#00ff88' : '#ff4444';
                    const timeStr = sig.timestamp ? convertToMSK(sig.timestamp) : '-';
                    const entryPrice = parseFloat(sig.price || 0);
                    const stopLoss = parseFloat(sig.stop_loss || 0);
                    const takeProfit = parseFloat(sig.take_profit || 0);
                    const rrRatio = parseFloat(sig.rr_ratio || 0).toFixed(1);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–æ–Ω—ã –∏–∑ reason (FVG –∏–ª–∏ OB)
                    const reason = sig.reason || '';
                    let zoneType = 'Unknown';
                    let zoneColor = '#aaa';
                    if (reason.includes('FVG')) {
                        zoneType = 'FVG';
                        zoneColor = '#ffaa00';
                    } else if (reason.includes('OB')) {
                        zoneType = 'Order Block';
                        zoneColor = '#9933ff';
                    }
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∏—Å–∫ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å
                    const risk = sig.action === 'LONG' ? (entryPrice - stopLoss) : (stopLoss - entryPrice);
                    const reward = sig.action === 'LONG' ? (takeProfit - entryPrice) : (entryPrice - takeProfit);
                    
                    const bgColor = idx % 2 === 0 ? '#1a1a1a' : '#222';
                    
                    html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #333;">
                        <td style="padding: 10px;">${timeStr}</td>
                        <td style="padding: 10px; font-weight: bold;">${sig.symbol || '-'}</td>
                        <td style="padding: 10px; text-align: center;">
                            <span style="color: ${actionColor}; font-weight: bold; background: ${actionColor}22; padding: 4px 12px; border-radius: 4px;">
                                ${sig.action}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: #00d4ff;">$${entryPrice.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: #ff4444;">$${stopLoss.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: #00ff88;">$${takeProfit.toFixed(2)}</td>
                        <td style="padding: 10px;">
                            <span style="color: ${zoneColor}; font-size: 0.9em; background: ${zoneColor}22; padding: 3px 8px; border-radius: 3px;">
                                ${zoneType}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: bold; color: ${parseFloat(rrRatio) >= 2.0 ? '#00ff88' : '#ffaa00'};">
                            1:${rrRatio}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('smc-history-table').innerHTML = html;
                
                console.log(`‚úÖ Loaded ${data.length} SMC signals`);
            } catch (error) {
                console.error('‚ùå Error loading SMC history:', error);
                document.getElementById('smc-history-table').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff4444;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">‚ö†Ô∏è Error loading SMC history</p>
                        <p style="font-size: 0.9em;">${error.message || 'Unknown error'}</p>
                        <p style="font-size: 0.8em; color: #aaa; margin-top: 10px;">Check console for details</p>
                    </div>
                `;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∑–µ–ª–µ–Ω—ã–π, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ
                const originalColor = element.style.color;
                element.style.color = '#00ff88';
                element.title = 'Copied!';
                setTimeout(() => {
                    element.style.color = originalColor;
                    element.title = 'Click to copy';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ MSK (UTC+3)
        function convertToMSK(isoString) {
            if (!isoString) return '-';
            try {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫—É: –µ—Å–ª–∏ –Ω–µ—Ç timezone, —Å—á–∏—Ç–∞–µ–º UTC
                let dateStr = isoString.trim();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ timezone –≤ —Å—Ç—Ä–æ–∫–µ
                const hasTimezone = dateStr.includes('Z') || dateStr.match(/[+-]\d{2}:?\d{2}$/);
                
                if (!hasTimezone) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç timezone, –¥–æ–±–∞–≤–ª—è–µ–º 'Z' –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è UTC
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?$/)) {
                        // ISO —Ñ–æ—Ä–º–∞—Ç —Å —Å–µ–∫—É–Ω–¥–∞–º–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏)
                        dateStr = dateStr + 'Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                        // ISO —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ —Å–µ–∫—É–Ω–¥
                        dateStr = dateStr + ':00Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/)) {
                        // –§–æ—Ä–º–∞—Ç –±–µ–∑ T, —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
                        dateStr = dateStr.replace(' ', 'T') + 'Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                        // –§–æ—Ä–º–∞—Ç –±–µ–∑ T –∏ —Å–µ–∫—É–Ω–¥
                        dateStr = dateStr.replace(' ', 'T') + ':00Z';
                    } else {
                        // –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å Z –≤ –∫–æ–Ω–µ—Ü
                        dateStr = dateStr + (dateStr.endsWith('Z') ? '' : 'Z');
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç timezone)
                const date = new Date(dateStr);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', isoString, 'normalized to:', dateStr);
                    return isoString;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ MSK
                // –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç timezone –∏—Å—Ö–æ–¥–Ω–æ–π –¥–∞—Ç—ã –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ MSK
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Europe/Moscow',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const parts = formatter.formatToParts(date);
                const year = parts.find(p => p.type === 'year').value;
                const month = parts.find(p => p.type === 'month').value;
                const day = parts.find(p => p.type === 'day').value;
                const hours = parts.find(p => p.type === 'hour').value;
                const minutes = parts.find(p => p.type === 'minute').value;
                const seconds = parts.find(p => p.type === 'second').value;
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} MSK`;
            } catch (e) {
                console.error('Error converting time to MSK:', e, isoString);
                return isoString; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }
        
        async function loadSignals() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
                const symbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = symbolSelect ? symbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º symbol
                const url = `/api/signals?symbol=${encodeURIComponent(selectedSymbol)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.signals.length === 0) {
                    document.getElementById('signals-table').innerHTML = '<p style="color: #aaa; padding: 20px;">No signals yet</p>';
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É (–ø–æ timestamp –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
                const sortedSignals = [...data.signals].sort((a, b) => {
                    const timeA = new Date(a.timestamp || 0).getTime();
                    const timeB = new Date(b.timestamp || 0).getTime();
                    return timeB - timeA; // –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const formatStrategyType = (type) => {
                    const types = {
                        'trend': '<span style="color: #00ff88;">TREND</span>',
                        'flat': '<span style="color: #ffaa00;">FLAT</span>',
                        'ml': '<span style="color: #9933ff;">ML</span>',
                        'momentum': '<span style="color: #00d4ff;">MOMENTUM</span>',
                        'liquidity': '<span style="color: #ffd93d;">LIQUIDITY</span>',
                        'unknown': '<span style="color: #aaa;">UNKNOWN</span>'
                    };
                    return types[type] || types['unknown'];
                };
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è —Å —Ü–≤–µ—Ç–æ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
                const formatAction = (action) => {
                    const actionLower = (action || '').toLowerCase();
                    if (actionLower === 'long') {
                        return '<span style="color: #00ff88; font-weight: bold;">long</span>';
                    } else if (actionLower === 'short') {
                        return '<span style="color: #ff4444; font-weight: bold;">short</span>';
                    } else {
                        return action || '-';
                    }
                };
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Time (MSK)</th><th>Pair</th><th>Strategy</th><th>Action</th><th>Reason</th><th>Price</th></tr></thead><tbody>';
                sortedSignals.forEach(signal => {
                    const mskTime = convertToMSK(signal.timestamp);
                    html += `<tr>
                        <td>${mskTime}</td>
                        <td>${signal.symbol || '-'}</td>
                        <td>${formatStrategyType(signal.strategy_type || 'unknown')}</td>
                        <td>${formatAction(signal.action)}</td>
                        <td>${signal.reason}</td>
                        <td>$${signal.price?.toFixed(2) || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                document.getElementById('signals-table').innerHTML = html;
            } catch (error) {
                console.error('Error loading signals:', error);
                document.getElementById('signals-table').innerHTML = '<p style="color: #ff4444;">Error loading signals</p>';
            }
        }
        
        async function clearSignals() {
            if (!confirm('Are you sure you want to clear all signals? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/signals/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                if (data.success) {
                    alert('All signals cleared successfully');
                    loadSignals(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ (–±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º)
                } else {
                    alert('Error clearing signals: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing signals:', error);
                alert('Error clearing signals: ' + error.message);
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π (–∑–∞–º–µ–Ω—è–µ–º –∑–∞–≥–ª—É—à–∫—É)
        window.startBot = async function() {
            try {
                const response = await fetch('/api/bot/start', { method: 'POST' });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        alert('Error starting bot: ' + (errorData.error || `HTTP ${response.status}: ${response.statusText}`));
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        alert(`Error starting bot: HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    alert('Error: Response is not JSON');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                    if (data.bot_status) {
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator running"></span>Running`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #00ff88;">${data.bot_status.current_status || 'Running'}</span>`;
                        }
                    } else {
                        // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator running"></span>Running`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #00ff88;">Running</span>`;
                        }
                    }
                    
                    alert('Bot started! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        updateStatus();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–æ—Ä–∫–µ—Ä–∞–º–∏
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.error('Error starting bot: Server unavailable or network error', error);
                    console.error('Request details:', {
                        url: '/api/bot/start',
                        method: 'POST',
                        currentUrl: window.location.href,
                        hostname: window.location.hostname,
                        port: window.location.port
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
                    fetch('/api/status')
                        .then(response => {
                            if (response.ok) {
                                alert('Error: Cannot start bot, but server is reachable.\n\n' +
                                      'Please check server logs for errors during bot startup.');
                            } else {
                                alert('Error: Server responded with status ' + response.status + '.\n\n' +
                                      'Please check server logs for details.');
                            }
                        })
                        .catch(checkError => {
                            alert('Error: Server is not reachable.\n\n' +
                                  'Please ensure:\n' +
                                  '1. The server is running (python main.py --mode web)\n' +
                                  '2. The server is accessible at ' + window.location.origin + '\n' +
                                  '3. There are no firewall/network issues\n' +
                                  '4. Check browser console and server logs for more details');
                        });
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error starting bot: Invalid JSON response', error);
                    alert('Error starting bot: Invalid server response.\n\n' +
                          'The server may be returning an error page instead of JSON.\n' +
                          'Please check server logs.');
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error starting bot:', error);
                    alert('Error starting bot: ' + (error.message || 'Unknown error') + '\n\n' +
                          'Check browser console (F12) for details.');
                }
            }
        }
        
        window.stopBot = async function() {
            try {
                const response = await fetch('/api/bot/stop', { method: 'POST' });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        alert('Error stopping bot: ' + (errorData.error || `HTTP ${response.status}: ${response.statusText}`));
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        alert(`Error stopping bot: HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    alert('Error: Response is not JSON');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                    if (data.bot_status) {
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator stopped"></span>Stopped`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #aaa;">${data.bot_status.current_status || 'Stopped'}</span>`;
                        }
                    } else {
                        // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator stopped"></span>Stopped`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #aaa;">Stopped</span>`;
                        }
                    }
                    
                    alert('Bot stopped! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        updateStatus();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.error('Error stopping bot: Server unavailable or network error', error);
                    alert('Error stopping bot: Server unavailable or network error. Please check if the server is running.');
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error stopping bot: Invalid JSON response', error);
                    alert('Error stopping bot: Invalid server response');
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error stopping bot:', error);
                    alert('Error stopping bot: ' + (error.message || 'Unknown error'));
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
        window.closePosition = async function() {
            if (!confirm('Are you sure you want to close the current position? This action cannot be undone.')) {
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const symbol = primarySymbolSelect ? primarySymbolSelect.value : 'BTCUSDT';
                
                const response = await fetch(`/api/position/close?symbol=${encodeURIComponent(symbol)}`, { 
                    method: 'POST' 
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const data = await response.json();
                if (data.success) {
                    alert('Position closed successfully! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
                    setTimeout(() => {
                        updateStatus();
                        if (typeof loadWalletData === 'function') {
                            loadWalletData();
                        }
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 500);
                } else {
                    alert('Error closing position: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error closing position:', error);
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    alert('Error: Server unavailable or network error. Please check if the server is running.');
                } else {
                    alert('Error closing position: ' + (error.message || 'Unknown error'));
                }
            }
        };
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏
        async function loadSymbolSettings() {
            try {
                const response = await fetch('/api/symbols/active');
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                    const checkboxes = document.querySelectorAll('.symbol-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = data.active_symbols.includes(checkbox.value);
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                    const primarySelect = document.getElementById('symbols-primary-select');
                    const topSelect = document.getElementById('primary-symbol-select');
                    if (primarySelect) {
                        primarySelect.value = data.primary_symbol;
                    }
                    if (topSelect) {
                        topSelect.value = data.primary_symbol;
                        currentSymbol = data.primary_symbol;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                    const statusSpan = document.getElementById('active-symbols-status');
                    if (statusSpan) {
                        statusSpan.textContent = `Active: ${data.active_symbols.join(', ')} | Primary: ${data.primary_symbol}`;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                    await loadSymbolsStatus();
                } else {
                    console.error('Error loading symbol settings:', data.error);
                }
            } catch (error) {
                console.error('Error loading symbol settings:', error);
                alert('Error loading symbol settings: ' + error.message);
            }
        }
        
        async function saveSymbolSettings() {
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤
                const checkboxes = document.querySelectorAll('.symbol-checkbox:checked');
                const activeSymbols = Array.from(checkboxes).map(cb => cb.value);
                
                if (activeSymbols.length === 0) {
                    alert('Please select at least one symbol');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º–≤–æ–ª
                const primarySelect = document.getElementById('symbols-primary-select');
                const primarySymbol = primarySelect ? primarySelect.value : activeSymbols[0];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º–≤–æ–ª –≤ —Å–ø–∏—Å–∫–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                if (!activeSymbols.includes(primarySymbol)) {
                    alert('Primary symbol must be in the active symbols list');
                    return;
                }
                
                const response = await fetch('/api/symbols/set-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: activeSymbols,
                        primary: primarySymbol
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
                    const topSelect = document.getElementById('primary-symbol-select');
                    if (topSelect) {
                        topSelect.value = primarySymbol;
                        currentSymbol = primarySymbol;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
                    const statusMessage = document.getElementById('symbols-status-message');
                    if (statusMessage) {
                        statusMessage.style.display = 'block';
                        statusMessage.style.background = '#1a3a1a';
                        statusMessage.style.color = '#00ff88';
                        statusMessage.style.border = '1px solid #00ff88';
                        statusMessage.textContent = `‚úÖ Settings saved! Active symbols: ${data.active_symbols.join(', ')} | Primary: ${data.primary_symbol}`;
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –Ω–æ–≤—ã–º —Å–∏–º–≤–æ–ª–æ–º
                    if (typeof loadChart !== 'undefined') {
                        setTimeout(loadChart, 500);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    if (typeof updateStatus !== 'undefined') {
                        setTimeout(updateStatus, 500);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                    setTimeout(loadSymbolsStatus, 1000);
                } else {
                    alert('Error saving symbol settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving symbol settings:', error);
                alert('Error saving symbol settings: ' + error.message);
            }
        }
        
        async function changePrimarySymbol(symbol) {
            try {
                currentSymbol = symbol;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –≤ –≤–∫–ª–∞–¥–∫–µ Symbols
                const symbolsSelect = document.getElementById('symbols-primary-select');
                if (symbolsSelect) {
                    symbolsSelect.value = symbol;
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –Ω–æ–≤—ã–º —Å–∏–º–≤–æ–ª–æ–º
                if (typeof loadChart !== 'undefined') {
                    loadChartLW();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (typeof updateStatus !== 'undefined') {
                    updateStatus();
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const activeTabId = activeTab.id;
                    if (activeTabId === 'trades' && typeof loadTrades !== 'undefined') {
                        loadTrades();
                    } else if (activeTabId === 'signals' && typeof loadSignals !== 'undefined') {
                        loadSignals();
                    }
                }
            } catch (error) {
                console.error('Error changing primary symbol:', error);
                alert('Error changing primary symbol: ' + error.message);
            }
        }
        
        async function loadSymbolsStatus() {
            try {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (30 —Å–µ–∫—É–Ω–¥) - api_status() –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ API –≤—ã–∑–æ–≤–æ–≤
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 10
                
                const response = await fetch('/api/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    signal: controller.signal,
                    credentials: 'same-origin' // –í–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ cookies/session
                });
                
                clearTimeout(timeoutId);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('[UI] Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        throw new Error(`HTTP ${response.status}: ${errorData.error || errorData.message || response.statusText}`);
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Invalid response type: ${contentType || 'unknown'}`);
                }
                
                const data = await response.json();
                console.log('[UI] Symbols status data:', data);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ
                if (data.error) {
                    console.error('[UI] Error in response:', data.error);
                    if (data.error_details) {
                        console.error('[UI] Error details:', data.error_details);
                    }
                    throw new Error(data.error);
                }
                
                console.log('[UI] Symbols status data:', data.symbols_status);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ symbols_status —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π
                if (data.symbols_status && Object.keys(data.symbols_status).length > 0) {
                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–º–≤–æ–ª–æ–≤
                    const generateStatusTable = (symbolsStatus) => {
                        let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Symbol</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Status</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Position</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">PnL</th></tr></thead><tbody>';
                        
                        for (const [symbol, status] of Object.entries(symbolsStatus)) {
                            const position = status.position;
                            const pnl = position ? (position.unrealised_pnl || 0) : 0;
                            const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                            const positionInfo = position && position.side ? `${position.side} ${position.size ? position.size.toFixed(3) : '0.000'} @ $${position.avg_price ? position.avg_price.toFixed(2) : '0.00'}` : 'No position';
                            const pnlDisplay = position ? `$${pnl.toFixed(2)}` : '$0.00';
                            
                            html += `<tr style="border-bottom: 1px solid #2a2a2a;">
                                <td style="padding: 10px;"><strong>${symbol}</strong></td>
                                <td style="padding: 10px;">
                                    <span class="status-indicator ${status.is_running ? 'running' : 'stopped'}"></span>
                                    ${status.status || (status.is_running ? 'Running' : 'Stopped')}
                                </td>
                                <td style="padding: 10px; font-size: 0.9em; color: #aaa;">${positionInfo}</td>
                                <td class="${pnlClass}" style="padding: 10px; font-weight: bold;">${pnlDisplay}</td>
                            </tr>`;
                        }
                        
                        html += '</tbody></table>';
                        return html;
                    };
                    
                    const statusHtml = generateStatusTable(data.symbols_status);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ Symbols
                    const statusList = document.getElementById('symbols-status-list');
                    if (statusList) {
                        statusList.innerHTML = statusHtml;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ
                    const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                    if (dashboardStatusList) {
                        dashboardStatusList.innerHTML = statusHtml;
                    }
                } else {
                    // –ï—Å–ª–∏ symbols_status –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ bot_status
                    const botStatus = data.bot_status || {};
                    const activeSymbols = data.account?.active_symbols || ['BTCUSDT'];
                    const noDataMsg = activeSymbols.length > 0 ? 
                        '<p style="color: #aaa; font-size: 0.9em;">Bot status: ' + (botStatus.current_status || 'Stopped') + '</p>' :
                        '<p style="color: #666;">No active symbols configured</p>';
                    
                    const statusList = document.getElementById('symbols-status-list');
                    if (statusList) {
                        statusList.innerHTML = noDataMsg;
                    }
                    
                    const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                    if (dashboardStatusList) {
                        dashboardStatusList.innerHTML = noDataMsg;
                    }
                }
            } catch (error) {
                console.error('[UI] Error loading symbols status:', error);
                console.error('[UI] Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                });
                
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                let errorMsg = '';
                if (error.name === 'AbortError') {
                    errorMsg = '<p style="color: #ff4444;">‚è±Ô∏è Request timeout (server not responding)</p>';
                    console.warn('[UI] Request timeout - server may be down or slow');
                } else if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    errorMsg = '<p style="color: #ff4444;">üåê Network error: Server unavailable or not responding</p><p style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Please check if the server is running</p>';
                    console.warn('[UI] Failed to fetch - server may be down or unreachable');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
                    fetch('/api/status', { method: 'GET', credentials: 'same-origin' })
                        .then(response => {
                            if (response.ok) {
                                console.log('[UI] Server is reachable now, retrying...');
                                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                                setTimeout(loadSymbolsStatus, 1000);
                            }
                        })
                        .catch(checkError => {
                            console.error('[UI] Server check failed:', checkError);
                        });
                } else {
                    errorMsg = `<p style="color: #ff4444;">‚ùå Error loading status: ${error.message}</p>`;
                }
                
                const statusList = document.getElementById('symbols-status-list');
                if (statusList) {
                    statusList.innerHTML = errorMsg;
                }
                
                const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                if (dashboardStatusList) {
                    dashboardStatusList.innerHTML = errorMsg;
                }
            }
        }
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        let currentSymbol = null;
        
        async function loadChart() {
            try {
                document.getElementById('chart-container').innerHTML = '<div class="loading">Loading chart...</div>';
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π
                const symbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = symbolSelect ? symbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                currentSymbol = selectedSymbol;
                
                // –ü–µ—Ä–µ–¥–∞–µ–º —Å–∏–º–≤–æ–ª –≤ query –ø–∞—Ä–∞–º–µ—Ç—Ä–µ
                const response = await fetch(`/api/chart/data?symbol=${encodeURIComponent(selectedSymbol)}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('chart-container').innerHTML = `<p style="color: #ff4444; padding: 20px;">Error: ${data.error}</p>`;
                    if (data.traceback) {
                        console.error('Chart error traceback:', data.traceback);
                    }
                    return;
                }
                
                const candles = data.candles || [];
                const indicators = data.indicators || {};
                const signals = data.signals || [];
                const times = data.times || [];
                
                if (candles.length === 0 || times.length === 0) {
                    document.getElementById('chart-container').innerHTML = '<p style="color: #aaa; padding: 20px;">No chart data available</p>';
                    return;
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –º–∞—Å—Å–∏–≤—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –¥–ª–∏–Ω—É
                const dataLength = Math.min(candles.length, times.length);
                const trimmedTimes = times.slice(-dataLength);
                const trimmedCandles = candles.slice(-dataLength);
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–µ—á–µ–π —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º hover
                const candlestick = {
                    x: trimmedTimes,
                    open: trimmedCandles.map(c => c?.open || 0),
                    high: trimmedCandles.map(c => c?.high || 0),
                    low: trimmedCandles.map(c => c?.low || 0),
                    close: trimmedCandles.map(c => c?.close || 0),
                    type: 'candlestick',
                    name: 'Price',
                    increasing: { line: { color: '#00ff88', width: 1.5 }, fillcolor: '#00ff88' },
                    decreasing: { line: { color: '#ff4444', width: 1.5 }, fillcolor: '#ff4444' },
                    xaxis: 'x',
                    yaxis: 'y',
                    hovertemplate: '<b>OHLC</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Open: $%{open:.2f}<br>High: $%{high:.2f}<br>Low: $%{low:.2f}<br>Close: $%{close:.2f}<extra></extra>',
                };
                
                const traces = [candlestick];
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –º–∞—Å—Å–∏–≤–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã
                const trimIndicator = (arr) => {
                    if (!arr || !Array.isArray(arr)) return null;
                    if (arr.length === dataLength) return arr;
                    if (arr.length > dataLength) return arr.slice(-dataLength);
                    // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –∫–æ—Ä–æ—á–µ, –¥–æ–ø–æ–ª–Ω—è–µ–º None –≤ –Ω–∞—á–∞–ª–µ
                    return Array(dataLength - arr.length).fill(null).concat(arr);
                };
                
                // SMA20
                if (document.getElementById('show-sma').checked) {
                    const smaData = trimIndicator(indicators.sma);
                    if (smaData && smaData.some(v => v !== null && v !== undefined)) {
                        traces.push({
                            x: trimmedTimes,
                            y: smaData,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'SMA20',
                            line: { color: '#00d4ff', width: 2 },
                            xaxis: 'x',
                            yaxis: 'y',
                            hovertemplate: '<b>SMA20</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: $%{y:.2f}<extra></extra>',
                        });
                    }
                }
                
                // Bollinger Bands
                if (document.getElementById('show-bb').checked) {
                    const bbUpper = trimIndicator(indicators.bb_upper);
                    const bbMiddle = trimIndicator(indicators.bb_middle);
                    const bbLower = trimIndicator(indicators.bb_lower);
                    
                    if (bbUpper && bbUpper.some(v => v !== null && v !== undefined)) {
                        traces.push({
                            x: trimmedTimes,
                            y: bbUpper,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Upper',
                            line: { color: '#888', width: 1.5, dash: 'dash' },
                            xaxis: 'x',
                            yaxis: 'y',
                            showlegend: false,
                            hovertemplate: '<b>BB Upper</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: $%{y:.2f}<extra></extra>',
                        });
                    }
                    if (bbMiddle && bbMiddle.some(v => v !== null && v !== undefined)) {
                        traces.push({
                            x: trimmedTimes,
                            y: bbMiddle,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Middle',
                            line: { color: '#666', width: 1.5 },
                            xaxis: 'x',
                            yaxis: 'y',
                            showlegend: false,
                            hovertemplate: '<b>BB Middle</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: $%{y:.2f}<extra></extra>',
                        });
                    }
                    if (bbLower && bbLower.some(v => v !== null && v !== undefined)) {
                        traces.push({
                            x: trimmedTimes,
                            y: bbLower,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Lower',
                            line: { color: '#888', width: 1.5, dash: 'dash' },
                            xaxis: 'x',
                            yaxis: 'y',
                            showlegend: false,
                            hovertemplate: '<b>BB Lower</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: $%{y:.2f}<extra></extra>',
                        });
                    }
                }
                
                // –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (—Å–∏–≥–Ω–∞–ª—ã)
                if (document.getElementById('show-signals').checked && signals && Array.isArray(signals) && signals.length > 0) {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã
                    const validSignals = signals.filter(s => {
                        return s && s.time && s.price && (s.side === 'long' || s.side === 'short');
                    });
                    
                    const longSignals = validSignals.filter(s => s.side === 'long');
                    const shortSignals = validSignals.filter(s => s.side === 'short');
                    
                    if (longSignals.length > 0) {
                        traces.push({
                            x: longSignals.map(s => s.time),
                            y: longSignals.map(s => parseFloat(s.price) || 0),
                            type: 'scatter',
                            mode: 'markers',
                            name: 'Long Entry',
                            marker: {
                                symbol: 'triangle-up',
                                size: 12,
                                color: '#00ff88',
                                line: { color: '#000', width: 1 },
                            },
                            text: longSignals.map(s => `${s.action || 'unknown'}: ${s.reason || ''}`),
                            hovertemplate: '<b>Long Entry</b><br>Price: $%{y:.2f}<br>%{text}<extra></extra>',
                        });
                    }
                    
                    if (shortSignals.length > 0) {
                        traces.push({
                            x: shortSignals.map(s => s.time),
                            y: shortSignals.map(s => parseFloat(s.price) || 0),
                            type: 'scatter',
                            mode: 'markers',
                            name: 'Short Entry',
                            marker: {
                                symbol: 'triangle-down',
                                size: 12,
                                color: '#ff4444',
                                line: { color: '#000', width: 1 },
                            },
                            text: shortSignals.map(s => `${s.action || 'unknown'}: ${s.reason || ''}`),
                            hovertemplate: '<b>Short Entry</b><br>Price: $%{y:.2f}<br>%{text}<extra></extra>',
                        });
                    }
                }
                
                // Volume, RSI –∏ MACD subplots
                const volumeVisible = document.getElementById('show-volume').checked;
                const rsiVisible = document.getElementById('show-rsi').checked;
                const macdVisible = document.getElementById('show-macd').checked;
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–∑—É —Ä—ã–Ω–∫–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                const marketPhase = data.market_phase || 'unknown';
                const currentAdx = data.current_adx;
                const phaseText = marketPhase === 'trend' ? 'TREND' : marketPhase === 'flat' ? 'FLAT' : 'UNKNOWN';
                const phaseColor = marketPhase === 'trend' ? '#00ff88' : marketPhase === 'flat' ? '#ffaa00' : '#aaa';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ subplots
                let subplotCount = 0;
                if (volumeVisible) subplotCount++;
                if (rsiVisible) subplotCount++;
                if (macdVisible) subplotCount++;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—ã –¥–ª—è subplots
                let mainChartHeight = 1.0;
                let volumeHeight = 0;
                let rsiHeight = 0;
                let macdHeight = 0;
                
                if (subplotCount === 1) {
                    if (volumeVisible) {
                        mainChartHeight = 0.7;
                        volumeHeight = 0.25;
                    } else if (rsiVisible) {
                        mainChartHeight = 0.65;
                        rsiHeight = 0.3;
                    } else if (macdVisible) {
                        mainChartHeight = 0.65;
                        macdHeight = 0.3;
                    }
                } else if (subplotCount === 2) {
                    if (volumeVisible && rsiVisible) {
                        // –ü–æ—Ä—è–¥–æ–∫: MACD (–Ω–µ –≤–∫–ª—é—á–µ–Ω) ‚Üí Volume ‚Üí RSI
                        mainChartHeight = 0.55;
                        volumeHeight = 0.2;
                        rsiHeight = 0.2;
                    } else if (volumeVisible && macdVisible) {
                        // –ü–æ—Ä—è–¥–æ–∫: MACD ‚Üí Volume
                        mainChartHeight = 0.55;
                        macdHeight = 0.2;
                        volumeHeight = 0.2;
                    } else if (rsiVisible && macdVisible) {
                        // –ü–æ—Ä—è–¥–æ–∫: MACD ‚Üí RSI
                        mainChartHeight = 0.5;
                        macdHeight = 0.2;
                        rsiHeight = 0.25;
                    }
                } else if (subplotCount === 3) {
                    mainChartHeight = 0.45;
                    // –ü–æ—Ä—è–¥–æ–∫ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö: MACD ‚Üí Volume ‚Üí RSI
                    macdHeight = 0.15;
                    volumeHeight = 0.15;
                    rsiHeight = 0.2;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                let positionLine = null;
                if (data.position && trimmedTimes.length > 0) {
                    const pos = data.position;
                    positionLine = {
                        x: [trimmedTimes[0], trimmedTimes[trimmedTimes.length - 1]],
                        y: [pos.entry_price, pos.entry_price],
                        type: 'scatter',
                        mode: 'lines',
                        name: `Position: ${pos.side} @ $${pos.entry_price.toFixed(2)} (PnL: ${pos.unrealised_pnl >= 0 ? '+' : ''}${pos.unrealised_pnl.toFixed(2)})`,
                        line: {
                            color: pos.side === 'Buy' ? '#00ff88' : '#ff4444',
                            width: 2,
                            dash: 'dot',
                        },
                    };
                    traces.push(positionLine);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é Take Profit, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                    if (pos.take_profit && pos.take_profit !== '' && parseFloat(pos.take_profit) > 0) {
                        const tpPrice = parseFloat(pos.take_profit);
                        traces.push({
                            x: [trimmedTimes[0], trimmedTimes[trimmedTimes.length - 1]],
                            y: [tpPrice, tpPrice],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Take Profit: $${tpPrice.toFixed(2)}`,
                            line: {
                                color: '#00ff88',
                                width: 2,
                                dash: 'dash',
                            },
                            hovertemplate: `<b>Take Profit</b><br>Price: $${tpPrice.toFixed(2)}<extra></extra>`,
                        });
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é Stop Loss, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                    if (pos.stop_loss && pos.stop_loss !== '' && parseFloat(pos.stop_loss) > 0) {
                        const slPrice = parseFloat(pos.stop_loss);
                        traces.push({
                            x: [trimmedTimes[0], trimmedTimes[trimmedTimes.length - 1]],
                            y: [slPrice, slPrice],
                            type: 'scatter',
                            mode: 'lines',
                            name: `Stop Loss: $${slPrice.toFixed(2)}`,
                            line: {
                                color: '#ff4444',
                                width: 2,
                                dash: 'dash',
                            },
                            hovertemplate: `<b>Stop Loss</b><br>Price: $${slPrice.toFixed(2)}<extra></extra>`,
                        });
                    }
                }
                
                const layout = {
                    title: {
                        text: `Price Chart with Indicators | Market Phase: <span style="color: ${phaseColor}">${phaseText}</span>${currentAdx ? ` (ADX: ${currentAdx.toFixed(1)})` : ''}${data.position ? ` | Position: ${data.position.side} @ $${data.position.entry_price.toFixed(2)}` : ''}`,
                        font: { color: '#e0e0e0' },
                    },
                    xaxis: {
                        title: 'Time (MSK, UTC+3)',
                        type: 'date',
                        color: '#aaa',
                        gridcolor: '#333',
                        tickformat: '%Y-%m-%d %H:%M',
                        tickangle: -45,
                        showgrid: true,
                        showspikes: true,
                        spikecolor: '#888',
                        spikesnap: 'cursor',
                        spikemode: 'across',
                        spikethickness: 1,
                        domain: [0, 1], // –û–±—â–∏–π –¥–æ–º–µ–Ω –¥–ª—è –≤—Å–µ—Ö subplots
                    },
                    yaxis: {
                        title: 'Price (USDT)',
                        color: '#aaa',
                        gridcolor: '#333',
                        side: 'right',
                    },
                    plot_bgcolor: '#1a1a1a',
                    paper_bgcolor: '#1a1a1a',
                    font: { color: '#e0e0e0' },
                    legend: {
                        x: 0,
                        y: 1,
                        bgcolor: 'rgba(0,0,0,0.5)',
                    },
                    hovermode: 'x unified',
                    dragmode: 'pan',
                    // –£–ª—É—á—à–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                    autosize: true,
                };
                
                // –ï—Å–ª–∏ MACD –≤–∫–ª—é—á–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º subplot (MACD –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É)
                if (macdVisible) {
                    const macdData = trimIndicator(indicators.macd);
                    const macdSignalData = trimIndicator(indicators.macd_signal);
                    const macdHistData = trimIndicator(indicators.macd_hist);
                    
                    if (macdData && macdData.some(v => v !== null && v !== undefined)) {
                        // MACD –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É (–ø–æ–∑–∏—Ü–∏—è 0)
                        const macdStart = 0;
                        const macdEnd = macdStart + macdHeight;
                        
                        layout.yaxis3 = {
                            title: 'MACD',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [macdStart, macdEnd],
                            showgrid: true,
                        };
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º xaxis –¥–ª—è MACD subplot (—Å–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π xaxis)
                        layout.xaxis3 = {
                            type: 'date',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [0, 1],
                            showticklabels: false,
                            showgrid: true,
                        };
                        
                        // –õ–∏–Ω–∏—è MACD
                        traces.push({
                            x: trimmedTimes,
                            y: macdData,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'MACD',
                            line: { color: '#00d4ff', width: 2 },
                            yaxis: 'y3',
                            xaxis: 'x3',
                            hovertemplate: '<b>MACD</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: %{y:.4f}<extra></extra>',
                        });
                        
                        // –°–∏–≥–Ω–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è MACD
                        if (macdSignalData && macdSignalData.some(v => v !== null && v !== undefined)) {
                            traces.push({
                                x: trimmedTimes,
                                y: macdSignalData,
                                type: 'scatter',
                                mode: 'lines',
                                name: 'MACD Signal',
                                line: { color: '#ffaa00', width: 2 },
                                yaxis: 'y3',
                                xaxis: 'x3',
                                hovertemplate: '<b>MACD Signal</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: %{y:.4f}<extra></extra>',
                            });
                        }
                        
                        // MACD Histogram (—Ç–æ–Ω–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏)
                        if (macdHistData && macdHistData.some(v => v !== null && v !== undefined)) {
                            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—É–±–∏—Ä–∞–µ–º null/undefined)
                            const validHistData = macdHistData.map((v, idx) => ({
                                x: trimmedTimes[idx],
                                y: v !== null && v !== undefined ? v : 0,
                                color: v !== null && v !== undefined && v >= 0 ? '#00ff88' : '#ff4444'
                            }));
                            
                            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                            const positiveHist = validHistData.filter(d => d.y >= 0);
                            const negativeHist = validHistData.filter(d => d.y < 0);
                            
                            if (positiveHist.length > 0) {
                                traces.push({
                                    x: positiveHist.map(d => d.x),
                                    y: positiveHist.map(d => d.y),
                                    type: 'bar',
                                    name: 'MACD Histogram +',
                                    marker: {
                                        color: '#00ff88',
                                        opacity: 0.6,
                                        line: { width: 0 }
                                    },
                                    yaxis: 'y3',
                                    xaxis: 'x3',
                                    showlegend: false,
                                    width: 0.8, // –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è —Ç–æ–Ω–∫–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                                });
                            }
                            
                            if (negativeHist.length > 0) {
                                traces.push({
                                    x: negativeHist.map(d => d.x),
                                    y: negativeHist.map(d => d.y),
                                    type: 'bar',
                                    name: 'MACD Histogram -',
                                    marker: {
                                        color: '#ff4444',
                                        opacity: 0.6,
                                        line: { width: 0 }
                                    },
                                    yaxis: 'y3',
                                    xaxis: 'x3',
                                    showlegend: false,
                                    width: 0.8,
                                });
                            }
                        }
                        
                        // –ù—É–ª–µ–≤–∞—è –ª–∏–Ω–∏—è –¥–ª—è MACD (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ—Å—å –≥—Ä–∞—Ñ–∏–∫)
                        layout.yaxis3.zeroline = true;
                        layout.yaxis3.zerolinecolor = '#666';
                        layout.yaxis3.zerolinewidth = 1;
                    }
                }
                
                // –ï—Å–ª–∏ Volume –≤–∫–ª—é—á–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º subplot (Volume –Ω–∞–¥ MACD)
                if (volumeVisible) {
                    const volumeData = trimmedCandles.map(c => c?.volume || 0);
                    if (volumeData && volumeData.some(v => v > 0)) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è Volume subplot (–Ω–∞–¥ MACD, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                        let volumeStart = 0;
                        if (macdVisible) {
                            volumeStart = macdHeight;
                        }
                        const volumeEnd = volumeStart + volumeHeight;
                        
                        layout.yaxis4 = {
                            title: 'Volume',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [volumeStart, volumeEnd],
                            side: 'right',
                            showgrid: true,
                        };
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º xaxis –¥–ª—è Volume subplot (—Å–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫–∏)
                        layout.xaxis4 = {
                            type: 'date',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [0, 1],
                            showticklabels: false,
                            showgrid: true,
                        };
                        
                        // –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É –¥–ª—è –æ–±—ä–µ–º–∞ (–∑–µ–ª–µ–Ω—ã–π –¥–ª—è —Ä–æ—Å—Ç–∞, –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø–∞–¥–µ–Ω–∏—è)
                        const volumeColors = trimmedCandles.map((c, idx) => {
                            if (idx === 0) return '#888';
                            const prevClose = trimmedCandles[idx - 1]?.close || c.close;
                            return c.close >= prevClose ? '#00ff88' : '#ff4444';
                        });
                        
                        // Volume bars
                        traces.push({
                            x: trimmedTimes,
                            y: volumeData,
                            type: 'bar',
                            name: 'Volume',
                            marker: {
                                color: volumeColors,
                                opacity: 0.6,
                            },
                            yaxis: 'y4',
                            xaxis: 'x4',
                            showlegend: false,
                            hovertemplate: '<b>Volume</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Volume: %{y:,.0f}<extra></extra>',
                        });
                    }
                }
                
                // –ï—Å–ª–∏ RSI –≤–∫–ª—é—á–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º subplot (RSI –≤—ã—à–µ –≤—Å–µ—Ö)
                if (rsiVisible) {
                    const rsiData = trimIndicator(indicators.rsi);
                    if (rsiData && rsiData.some(v => v !== null && v !== undefined)) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è RSI subplot (–≤—ã—à–µ –≤—Å–µ—Ö: MACD –∏ Volume, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
                        // –ü–æ—Ä—è–¥–æ–∫ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö: MACD ‚Üí Volume ‚Üí RSI
                        let rsiStart = 0;
                        if (volumeVisible && macdVisible) {
                            // MACD –≤–Ω–∏–∑—É (0), Volume –Ω–∞–¥ MACD, RSI –Ω–∞–¥ Volume
                            rsiStart = macdHeight + volumeHeight;
                        } else if (volumeVisible) {
                            // MACD –Ω–µ –≤–∫–ª—é—á–µ–Ω, Volume –≤–Ω–∏–∑—É, RSI –Ω–∞–¥ Volume
                            rsiStart = volumeHeight;
                        } else if (macdVisible) {
                            // Volume –Ω–µ –≤–∫–ª—é—á–µ–Ω, MACD –≤–Ω–∏–∑—É, RSI –Ω–∞–¥ MACD
                            rsiStart = macdHeight;
                        }
                        const rsiEnd = rsiStart + rsiHeight;
                        
                        layout.yaxis2 = {
                            title: 'RSI',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [rsiStart, rsiEnd],
                            showgrid: true,
                        };
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º xaxis –¥–ª—è RSI subplot (—Å–∫—Ä—ã–≤–∞–µ–º –º–µ—Ç–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π xaxis –≤–Ω–∏–∑—É)
                        layout.xaxis2 = {
                            type: 'date',
                            color: '#aaa',
                            gridcolor: '#333',
                            domain: [0, 1],
                            showticklabels: false,
                            showgrid: true,
                        };
                        
                        traces.push({
                            x: trimmedTimes,
                            y: rsiData,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI',
                            line: { color: '#ffaa00', width: 2 },
                            yaxis: 'y2',
                            xaxis: 'x2',
                            hovertemplate: '<b>RSI</b><br>Time: %{x|%Y-%m-%d %H:%M}<br>Value: %{y:.2f}<extra></extra>',
                        });
                        
                        // RSI —É—Ä–æ–≤–Ω–∏
                        traces.push({
                            x: trimmedTimes,
                            y: Array(trimmedTimes.length).fill(70),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI 70',
                            line: { color: '#ff4444', width: 1, dash: 'dot' },
                            yaxis: 'y2',
                            xaxis: 'x2',
                            showlegend: false,
                        });
                        traces.push({
                            x: trimmedTimes,
                            y: Array(trimmedTimes.length).fill(30),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'RSI 30',
                            line: { color: '#00ff88', width: 1, dash: 'dot' },
                            yaxis: 'y2',
                            xaxis: 'x2',
                            showlegend: false,
                        });
                    }
                }
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ domain –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö subplots
                if (subplotCount > 0) {
                    layout.yaxis.domain = [mainChartHeight, 1];
                }
                
                Plotly.newPlot('chart-container', traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    doubleClick: 'reset',
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'crypto_chart',
                        height: 800,
                        width: 1400,
                        scale: 2
                    },
                });
            } catch (error) {
                console.error('Error loading chart:', error);
                document.getElementById('chart-container').innerHTML = `<p style="color: #ff4444; padding: 20px;">Error loading chart: ${error.message}</p>`;
            }
        }
        
        // Strategy Selection Functions
        async function loadStrategySelection() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.app) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                    const trendCheckbox = document.getElementById('enable-trend-strategy');
                    const flatCheckbox = document.getElementById('enable-flat-strategy');
                    const mlCheckbox = document.getElementById('enable-ml-strategy');
                    const momentumCheckbox = document.getElementById('enable-momentum-strategy');
                    const liquidityCheckbox = document.getElementById('enable-liquidity-strategy');
                    const smcCheckbox = document.getElementById('smcCheckbox');
                    
                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ boolean
                    const toBool = (val) => {
                        if (typeof val === 'boolean') return val;
                        if (typeof val === 'string') {
                            const lower = val.toLowerCase().trim();
                            return lower === 'true' || lower === '1' || lower === 'yes';
                        }
                        return Boolean(val);
                    };
                    
                    if (trendCheckbox) {
                        trendCheckbox.checked = toBool(data.app.enable_trend_strategy);
                    }
                    if (flatCheckbox) {
                        flatCheckbox.checked = toBool(data.app.enable_flat_strategy);
                    }
                    if (mlCheckbox) {
                        mlCheckbox.checked = toBool(data.app.enable_ml_strategy);
                    }
                    if (momentumCheckbox) {
                        momentumCheckbox.checked = toBool(data.app.enable_momentum_strategy);
                    }
                    if (liquidityCheckbox) {
                        liquidityCheckbox.checked = toBool(data.app.enable_liquidity_sweep_strategy);
                    }
                    if (smcCheckbox) {
                        smcCheckbox.checked = toBool(data.app.enable_smc_strategy);
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä—É
                    const symbolSelect = document.getElementById('symbol-select');
                    if (symbolSelect) {
                        if (data.app.symbol) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å –≤ –æ–ø—Ü–∏—è—Ö
                            const optionExists = Array.from(symbolSelect.options).some(opt => opt.value === data.app.symbol);
                            if (optionExists) {
                                symbolSelect.value = data.app.symbol;
                            }
                        }
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä—É –¥–ª—è ML
                    const mlSymbolSelect = document.getElementById('ml-symbol-select');
                    if (mlSymbolSelect && data.app.symbol) {
                        mlSymbolSelect.value = data.app.symbol;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    const strategyPrioritySelect = document.getElementById('strategy-priority-select');
                    if (strategyPrioritySelect && data.app.strategy_priority) {
                        strategyPrioritySelect.value = data.app.strategy_priority;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
                    const modelTypeForAllSelect = document.getElementById('ml-model-type-for-all');
                    if (modelTypeForAllSelect && data.app.ml_model_type_for_all !== undefined) {
                        modelTypeForAllSelect.value = data.app.ml_model_type_for_all || "";
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    if (data.app.ml_model_path) {
                        setTimeout(loadMLModelInfo, 500);
                    }
                }
            } catch (error) {
                console.error('Error loading strategy selection:', error);
            }
        }
        
        async function loadStrategyStats() {
            try {
                const response = await fetch('/api/strategy/stats/all');
                const data = await response.json();
                
                const container = document.getElementById('strategy-stats-container');
                if (!container) {
                    console.error('strategy-stats-container not found');
                    return;
                }
                
                const formatNumber = (num) => {
                    if (num === null || num === undefined) return '0.00';
                    return typeof num === 'number' ? num.toFixed(2) : num;
                };
                
                const formatPercent = (num) => {
                    if (num === null || num === undefined) return '0.00%';
                    return typeof num === 'number' ? (num.toFixed(2) + '%') : num;
                };
                
                let html = '';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Trend —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const trendStats = data.trend || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%); border: 1px solid rgba(0, 255, 136, 0.3);">
                        <h3 style="color: #00ff88; margin-bottom: 15px;">üìà Trend Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${trendStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(trendStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(trendStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${trendStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${trendStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(trendStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(trendStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(trendStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(trendStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(trendStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Flat —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const flatStats = data.flat || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 170, 0, 0.1) 0%, rgba(255, 170, 0, 0.05) 100%); border: 1px solid rgba(255, 170, 0, 0.3);">
                        <h3 style="color: #ffaa00; margin-bottom: 15px;">üìä Flat Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${flatStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(flatStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(flatStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${flatStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${flatStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(flatStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(flatStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(flatStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(flatStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(flatStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ML —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const mlStats = data.ml || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">ü§ñ ML Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${mlStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(mlStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(mlStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${mlStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${mlStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(mlStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(mlStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(mlStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(mlStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(mlStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Momentum —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const momentumStats = data.momentum || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">‚ö° Momentum Breakout</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${momentumStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(momentumStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(momentumStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(momentumStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(momentumStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(momentumStats.avg_pnl || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Liquidity Sweep —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const liquidityStats = data.liquidity || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 217, 61, 0.1) 0%, rgba(255, 217, 61, 0.05) 100%); border: 1px solid rgba(255, 217, 61, 0.3);">
                        <h3 style="color: #ffd93d; margin-bottom: 15px;">üíß Liquidity Sweep</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${liquidityStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(liquidityStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(liquidityStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(liquidityStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(liquidityStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(liquidityStats.avg_pnl || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const allStats = data.all || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(170, 170, 170, 0.1) 0%, rgba(170, 170, 170, 0.05) 100%); border: 1px solid rgba(170, 170, 170, 0.3);">
                        <h3 style="color: #aaa; margin-bottom: 15px;">üìä All Strategies Combined</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${allStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(allStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(allStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${allStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${allStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(allStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(allStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(allStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(allStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(allStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading strategy stats:', error);
                const container = document.getElementById('strategy-stats-container');
                if (container) {
                    container.innerHTML = '<p style="color: #ff4444; padding: 20px;">Error loading statistics</p>';
                }
            }
        }
        
        async function saveStrategySelection() {
            try {
                const trendCheckbox = document.getElementById('enable-trend-strategy');
                const flatCheckbox = document.getElementById('enable-flat-strategy');
                const mlCheckbox = document.getElementById('enable-ml-strategy');
                const momentumCheckbox = document.getElementById('enable-momentum-strategy');
                const liquidityCheckbox = document.getElementById('enable-liquidity-strategy');
                const smcCheckbox = document.getElementById('smcCheckbox');
                const symbolSelect = document.getElementById('symbol-select');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                const missingElements = [];
                if (!trendCheckbox) missingElements.push('enable-trend-strategy');
                if (!flatCheckbox) missingElements.push('enable-flat-strategy');
                if (!mlCheckbox) missingElements.push('enable-ml-strategy');
                
                if (missingElements.length > 0) {
                    console.error('[saveStrategySelection] Missing elements:', missingElements);
                    alert('Error: Could not find strategy selection elements:\n' + missingElements.join(', ') + '\n\nPlease refresh the page and try again.');
                    return;
                }
                
                const strategyPrioritySelect = document.getElementById('strategy-priority-select');
                const selectedPriority = strategyPrioritySelect ? strategyPrioritySelect.value : 'trend';
                
                const data = {
                    app: {
                        enable_trend_strategy: trendCheckbox.checked,
                        enable_flat_strategy: flatCheckbox.checked,
                        enable_ml_strategy: mlCheckbox.checked,
                        enable_momentum_strategy: momentumCheckbox ? momentumCheckbox.checked : false,
                        enable_liquidity_sweep_strategy: liquidityCheckbox ? liquidityCheckbox.checked : false,
                        enable_smc_strategy: smcCheckbox ? smcCheckbox.checked : false,
                        strategy_priority: selectedPriority
                    }
                };
                
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const priorityText = {
                        'trend': 'Trend Strategy Priority',
                        'flat': 'Flat Strategy Priority',
                        'ml': 'ML Strategy Priority',
                        'momentum': 'Momentum Breakout Priority',
                        'liquidity': 'Liquidity Sweep Priority',
                        'smc': 'Smart Money Concepts Priority',
                        'hybrid': 'Hybrid (Latest Signal)'
                    };
                    const enabledStrategies = [];
                    if (trendCheckbox.checked) enabledStrategies.push('Trend');
                    if (flatCheckbox.checked) enabledStrategies.push('Flat');
                    if (mlCheckbox.checked) enabledStrategies.push('ML');
                    if (momentumCheckbox && momentumCheckbox.checked) enabledStrategies.push('Momentum');
                    if (liquidityCheckbox && liquidityCheckbox.checked) enabledStrategies.push('Liquidity Sweep');
                    const smcCheckbox = document.getElementById('smcCheckbox');
                    if (smcCheckbox && smcCheckbox.checked) enabledStrategies.push('Smart Money Concepts');
                    
                    alert('‚úÖ Settings saved successfully!\n\n' +
                          `Enabled Strategies: ${enabledStrategies.length > 0 ? enabledStrategies.join(', ') : 'None'}\n` +
                          `Strategy Priority: ${priorityText[selectedPriority] || selectedPriority}\n\n` +
                          'Note: Settings apply to ALL active trading pairs. If the bot is running, it will use the new settings on the next cycle.');
                    
                    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (result.settings) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                        if (trendCheckbox && result.settings.enable_trend_strategy !== undefined) {
                            trendCheckbox.checked = result.settings.enable_trend_strategy;
                        }
                        if (flatCheckbox && result.settings.enable_flat_strategy !== undefined) {
                            flatCheckbox.checked = result.settings.enable_flat_strategy;
                        }
                        if (mlCheckbox && result.settings.enable_ml_strategy !== undefined) {
                            mlCheckbox.checked = result.settings.enable_ml_strategy;
                        }
                        if (momentumCheckbox && result.settings.enable_momentum_strategy !== undefined) {
                            momentumCheckbox.checked = result.settings.enable_momentum_strategy;
                        }
                        if (liquidityCheckbox && result.settings.enable_liquidity_sweep_strategy !== undefined) {
                            liquidityCheckbox.checked = result.settings.enable_liquidity_sweep_strategy;
                        }
                        const smcCheckbox = document.getElementById('smcCheckbox');
                        if (smcCheckbox && result.settings.enable_smc_strategy !== undefined) {
                            smcCheckbox.checked = result.settings.enable_smc_strategy;
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                        if (strategyPrioritySelect && result.settings.strategy_priority) {
                            strategyPrioritySelect.value = result.settings.strategy_priority;
                        }
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    setTimeout(() => {
                        loadStrategySelection();
                    }, 1500);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                    if (typeof loadChart !== 'undefined') {
                        setTimeout(() => {
                            loadChartLW();
                        }, 1200);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–∏–º–≤–æ–ª
                    if (typeof loadMLModelInfo !== 'undefined') {
                        setTimeout(loadMLModelInfo, 1000);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                    if (typeof loadStrategyStats !== 'undefined') {
                        setTimeout(loadStrategyStats, 1000);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
                    if (typeof updateStatus !== 'undefined') {
                        setTimeout(updateStatus, 500);
                    }
                } else {
                    console.error('[saveStrategySelection] Error response:', result);
                    alert('‚ùå Error saving settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving strategy selection:', error);
                alert('‚ùå Error saving settings: ' + error.message);
            }
        }
        window.saveStrategySelection = saveStrategySelection; // Make global
        
        async function loadAllPairsModelsInfo() {
            try {
                const response = await fetch('/api/ml/models/all-pairs');
                const data = await response.json();
                
                const contentDiv = document.getElementById('all-pairs-models-content');
                if (!contentDiv) return;
                
                if (data.error) {
                    contentDiv.innerHTML = `<p style="color: #ff4444;">Error: ${data.error}</p>`;
                    return;
                }
                
                const models = data.models || {};
                const modelTypePreference = data.model_type_preference || "auto";
                
                let html = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏
                html += `<div style="margin-bottom: 15px; padding: 10px; background: #2a2a2a; border-radius: 4px;">`;
                html += `<span style="color: #aaa;">Model Type Preference: </span>`;
                html += `<span style="color: #00d4ff; font-weight: bold;">${modelTypePreference === "auto" ? "Auto (Ensemble > RF > XGB)" : modelTypePreference.toUpperCase()}</span>`;
                html += `</div>`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª—è—Ö –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
                const symbols = ["BTCUSDT", "ETHUSDT", "SOLUSDT"];
                for (const symbol of symbols) {
                    const modelInfo = models[symbol] || {};
                    const found = modelInfo.found || false;
                    
                    html += `<div style="margin-bottom: 15px; padding: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                    html += `<span style="color: #e0e0e0; font-weight: bold; font-size: 1.1em;">${symbol}</span>`;
                    
                    if (found) {
                        const metadata = modelInfo.metadata || {};
                        const modelType = metadata.model_type || "unknown";
                        const modelName = modelInfo.model_name || "Unknown";
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let modelTypeDisplay = modelType;
                        let modelTypeIcon = "üìä";
                        if (modelType.includes("ensemble")) {
                            modelTypeDisplay = "Ensemble (RF + XGBoost)";
                            modelTypeIcon = "üéØ";
                        } else if (modelType === "rf") {
                            modelTypeDisplay = "Random Forest";
                            modelTypeIcon = "üå≤";
                        } else if (modelType === "xgb") {
                            modelTypeDisplay = "XGBoost";
                            modelTypeIcon = "‚ö°";
                        }
                        
                        html += `<span style="color: #00ff88; font-size: 0.9em;">${modelTypeIcon} ${modelTypeDisplay}</span>`;
                        html += `</div>`;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                        if (metadata.accuracy !== undefined || metadata.cv_mean !== undefined) {
                            html += `<div style="margin-top: 8px; font-size: 0.9em;">`;
                            if (metadata.accuracy !== undefined) {
                                html += `<span style="color: #aaa;">Accuracy: </span>`;
                                html += `<span style="color: #00d4ff;">${((metadata.accuracy || 0) * 100).toFixed(2)}%</span>`;
                            }
                            if (metadata.cv_mean !== undefined) {
                                if (metadata.accuracy !== undefined) html += `<span style="color: #666;"> | </span>`;
                                html += `<span style="color: #aaa;">CV: </span>`;
                                html += `<span style="color: #00d4ff;">${((metadata.cv_mean || 0) * 100).toFixed(2)}%</span>`;
                                if (metadata.cv_std !== undefined) {
                                    html += `<span style="color: #666;"> ¬± ${((metadata.cv_std || 0) * 100).toFixed(2)}%</span>`;
                                }
                            }
                            html += `</div>`;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–±—É—á–µ–Ω–∏—è
                        if (metadata.trained_at) {
                            try {
                                const trainedDate = new Date(metadata.trained_at);
                                const daysAgo = Math.floor((Date.now() - trainedDate.getTime()) / (1000 * 60 * 60 * 24));
                                html += `<div style="margin-top: 5px; font-size: 0.85em; color: #888;">`;
                                html += `Trained: ${trainedDate.toLocaleDateString()} (${daysAgo} days ago)`;
                                html += `</div>`;
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã
                            }
                        }
                    } else {
                        html += `<span style="color: #ff4444; font-size: 0.9em;">‚ùå Model not found</span>`;
                        html += `</div>`;
                        if (modelInfo.error) {
                            html += `<div style="margin-top: 5px; font-size: 0.85em; color: #888;">${modelInfo.error}</div>`;
                        }
                    }
                    
                    html += `</div>`;
                }
                
                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading all pairs models info:', error);
                const contentDiv = document.getElementById('all-pairs-models-content');
                if (contentDiv) {
                    contentDiv.innerHTML = `<p style="color: #ff4444;">Error loading models info: ${error.message}</p>`;
                }
            }
        }
        
        window.loadAllPairsModelsInfo = loadAllPairsModelsInfo;
        
        async function loadMLModelInfo() {
            try {
                const response = await fetch('/api/ml/model/info');
                const mlInfoDiv = document.getElementById('ml-model-info');
                if (!mlInfoDiv) return;
                
                if (response.status === 404) {
                    mlInfoDiv.innerHTML = '<p style="color: #aaa;">No ML model configured</p>';
                    return;
                }
                
                const data = await response.json();
                if (data.error) {
                    mlInfoDiv.innerHTML = `<p style="color: #ff4444;">Error: ${data.error}</p>`;
                    return;
                }
                
                const metadata = data.metadata || {};
                const stats = data.stats || {};
                const shouldRetrain = data.should_retrain || false;
                const retrainReasons = data.retrain_reasons || [];
                const isEnsemble = data.is_ensemble || false;
                const ensembleMetrics = data.ensemble_metrics || {};
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const modelType = metadata.model_type || 'Unknown';
                const modelTypeDisplay = modelType.includes('Ensemble') ? modelType : 
                    (modelType === 'rf' || modelType === 'random_forest' ? 'Random Forest' :
                    (modelType === 'xgb' || modelType === 'xgboost' ? 'XGBoost' : modelType));
                
                let html = '<div style="margin-bottom: 20px;">';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ç–∏–ø–æ–º –º–æ–¥–µ–ª–∏
                html += `
                    <div style="padding: 15px; background: ${isEnsemble ? '#1a3a1a' : '#1a1a1a'}; border: 2px solid ${isEnsemble ? '#00ff88' : '#333'}; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: ${isEnsemble ? '#00ff88' : '#00d4ff'}; margin: 0 0 10px 0; font-size: 1.3em;">
                            ${isEnsemble ? 'üéØ' : 'üìä'} Model Type: <span style="font-weight: bold;">${modelTypeDisplay}</span>
                        </h3>
                        ${isEnsemble ? '<p style="color: #aaa; margin: 0; font-size: 0.9em;">Ensemble combines Random Forest and XGBoost for better performance</p>' : ''}
                    </div>
                `;
                
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                
                if (metadata.trained_at) {
                    const trainedDate = new Date(metadata.trained_at);
                    const daysAgo = Math.floor((Date.now() - trainedDate.getTime()) / (1000 * 60 * 60 * 24));
                    html += `
                        <div class="stat-item">
                            <span class="stat-label">Trained At:</span>
                            <span class="stat-value">${trainedDate.toLocaleString()}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Days Ago:</span>
                            <span class="stat-value">${daysAgo}</span>
                        </div>
                    `;
                }
                
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Symbol:</span>
                        <span class="stat-value">${metadata.symbol || 'N/A'}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Interval:</span>
                        <span class="stat-value">${metadata.interval || '15'}m</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Training Accuracy:</span>
                        <span class="stat-value">${((metadata.accuracy || 0) * 100).toFixed(2)}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CV Accuracy:</span>
                        <span class="stat-value">${((metadata.cv_mean || 0) * 100).toFixed(2)}% ${metadata.cv_std ? '¬± ' + ((metadata.cv_std || 0) * 100).toFixed(2) + '%' : ''}</span>
                    </div>
                `;
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω—Å–∞–º–±–ª—è
                if (isEnsemble && ensembleMetrics) {
                    if (ensembleMetrics.precision !== null && ensembleMetrics.precision !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">Precision:</span>
                                <span class="stat-value">${((ensembleMetrics.precision || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.recall !== null && ensembleMetrics.recall !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">Recall:</span>
                                <span class="stat-value">${((ensembleMetrics.recall || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.f1_score !== null && ensembleMetrics.f1_score !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">F1-Score:</span>
                                <span class="stat-value">${((ensembleMetrics.f1_score || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.cv_f1_mean !== null && ensembleMetrics.cv_f1_mean !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">CV F1-Score:</span>
                                <span class="stat-value">${((ensembleMetrics.cv_f1_mean || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    
                    // –í–µ—Å–∞ –∞–Ω—Å–∞–º–±–ª—è
                    if (ensembleMetrics.rf_weight !== null && ensembleMetrics.rf_weight !== undefined &&
                        ensembleMetrics.xgb_weight !== null && ensembleMetrics.xgb_weight !== undefined) {
                        html += `
                            <div class="stat-item" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <span class="stat-label" style="font-weight: bold; color: #00d4ff;">Ensemble Weights:</span>
                                <div style="margin-top: 5px;">
                                    <span style="color: #aaa;">Random Forest: </span>
                                    <span class="stat-value">${((ensembleMetrics.rf_weight || 0) * 100).toFixed(1)}%</span>
                                    <span style="color: #aaa; margin-left: 15px;">XGBoost: </span>
                                    <span class="stat-value">${((ensembleMetrics.xgb_weight || 0) * 100).toFixed(1)}%</span>
                                </div>
                                ${ensembleMetrics.ensemble_method ? `<p style="color: #888; font-size: 0.85em; margin-top: 5px;">Method: ${ensembleMetrics.ensemble_method}</p>` : ''}
                            </div>
                        `;
                    }
                }
                
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Live Win Rate:</span>
                        <span class="stat-value" style="color: ${stats.win_rate >= 50 ? '#00ff88' : '#ff4444'};">
                            ${(stats.win_rate || 0).toFixed(2)}%
                        </span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Live Total PnL:</span>
                        <span class="stat-value" style="color: ${stats.total_pnl >= 0 ? '#00ff88' : '#ff4444'};">
                            ${stats.total_pnl >= 0 ? '+' : ''}${(stats.total_pnl || 0).toFixed(2)} USDT
                        </span>
                    </div>
                `;
                
                html += '</div></div>';
                
                // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω—Å–∞–º–±–ª—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                if (!isEnsemble && metadata.symbol) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: #1a3a1a40; border: 1px solid #00ff88; border-radius: 4px;">
                            <h3 style="color: #00ff88; margin-top: 0;">üí° Recommendation: Use Ensemble Model</h3>
                            <p style="color: #aaa; margin: 10px 0;">
                                An ensemble model (combining Random Forest and XGBoost) is available for ${metadata.symbol || 'this symbol'}.
                                Ensemble models typically provide better performance and more robust predictions.
                            </p>
                            <p style="color: #888; font-size: 0.9em; margin: 5px 0;">
                                Select an ensemble model from the dropdown above to use it.
                            </p>
                        </div>
                    `;
                }
                
                if (shouldRetrain) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: #ff444420; border: 1px solid #ff4444; border-radius: 4px;">
                            <h3 style="color: #ff4444; margin-top: 0;">‚ö†Ô∏è Retraining Recommended</h3>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${retrainReasons.map(r => `<li style="color: #ffaa00;">${r}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                mlInfoDiv.innerHTML = html;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
                if (data.metadata) {
                    setTimeout(() => {
                        const modelSelect = document.getElementById('ml-model-select');
                        if (modelSelect && data.metadata) {
                            // –ò—â–µ–º –º–æ–¥–µ–ª—å –ø–æ —Å–∏–º–≤–æ–ª—É –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
                            const modelOptions = Array.from(modelSelect.options);
                            for (const option of modelOptions) {
                                if (option.value && option.value.includes(data.metadata.symbol) && option.value.includes(String(data.metadata.interval || '15'))) {
                                    modelSelect.value = option.value;
                                    modelSelect.dataset.currentModel = option.value;
                                    break;
                                }
                            }
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error loading ML model info:', error);
                const mlInfoDiv = document.getElementById('ml-model-info');
                if (mlInfoDiv) {
                    mlInfoDiv.innerHTML = '<p style="color: #ff4444;">Error loading model info</p>';
                }
            }
        }
        
        async function loadMLModelsList() {
            try {
                const response = await fetch('/api/ml/models/list');
                const data = await response.json();
                
                const modelSelect = document.getElementById('ml-model-select');
                if (!modelSelect) return;
                
                if (data.error) {
                    modelSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    return;
                }
                
                const models = data.models || [];
                
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                    return;
                }
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                modelSelect.innerHTML = '';
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ —Å–∏–º–≤–æ–ª–∞–º
                const modelsBySymbol = {};
                models.forEach(model => {
                    const symbol = model.symbol || 'UNKNOWN';
                    if (!modelsBySymbol[symbol]) {
                        modelsBySymbol[symbol] = [];
                    }
                    modelsBySymbol[symbol].push(model);
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã
                const sortedSymbols = Object.keys(modelsBySymbol).sort();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª–∏, –≥—Ä—É–ø–ø–∏—Ä—É—è –ø–æ —Å–∏–º–≤–æ–ª–∞–º
                sortedSymbols.forEach(symbol => {
                    const symbolModels = modelsBySymbol[symbol];
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Å–∏–º–≤–æ–ª–∞: —Å–Ω–∞—á–∞–ª–∞ –∞–Ω—Å–∞–º–±–ª–∏, –ø–æ—Ç–æ–º –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏
                    symbolModels.sort((a, b) => {
                        if (a.is_ensemble && !b.is_ensemble) return -1;
                        if (!a.is_ensemble && b.is_ensemble) return 1;
                        return (b.accuracy || 0) - (a.accuracy || 0);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ç–≥—Ä—É–ø–ø—É –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${symbol} (${symbolModels.length} model${symbolModels.length > 1 ? 's' : ''})`;
                    
                    symbolModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.path;
                        const trainedDate = model.trained_at ? new Date(model.trained_at).toLocaleDateString() : 'Unknown';
                        const accuracy = (model.accuracy * 100).toFixed(2);
                        const modelTypeDisplay = model.model_type || 'Unknown';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω—Å–∞–º–±–ª—è
                        let metricsText = '';
                        if (model.is_ensemble) {
                            const metrics = [];
                            if (model.f1_score !== null && model.f1_score !== undefined) {
                                metrics.push(`F1: ${(model.f1_score * 100).toFixed(1)}%`);
                            }
                            if (model.cv_f1_mean !== null && model.cv_f1_mean !== undefined) {
                                metrics.push(`CV F1: ${(model.cv_f1_mean * 100).toFixed(1)}%`);
                            }
                            if (metrics.length > 0) {
                                metricsText = ` [${metrics.join(', ')}]`;
                            }
                        }
                        
                        option.textContent = `${modelTypeDisplay} - ${accuracy}%${metricsText} - ${trainedDate}`;
                        optgroup.appendChild(option);
                    });
                    
                    modelSelect.appendChild(optgroup);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏–∑ API
                fetch('/api/ml/model/info')
                    .then(response => response.json())
                    .then(modelInfo => {
                        if (modelInfo.metadata && modelInfo.current_model_path) {
                            const currentModelPath = modelInfo.current_model_path;
                            modelSelect.value = currentModelPath;
                            modelSelect.dataset.currentModel = currentModelPath;
                        }
                    })
                    .catch(err => {
                        console.log('Could not get current model path:', err);
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—É—Ç—å
                        const currentModelPath = modelSelect.dataset.currentModel;
                        if (currentModelPath) {
                            modelSelect.value = currentModelPath;
                        }
                    });
            } catch (error) {
                console.error('Error loading ML models list:', error);
                const modelSelect = document.getElementById('ml-model-select');
                if (modelSelect) {
                    modelSelect.innerHTML = '<option value="">Error loading models</option>';
                }
            }
        }
        window.loadMLModelsList = loadMLModelsList;
        
        async function selectMLModel() {
            try {
                const modelSelect = document.getElementById('ml-model-select');
                const statusDiv = document.getElementById('select-model-status');
                
                if (!modelSelect || !statusDiv) {
                    alert('Error: Could not find model selection elements');
                    return;
                }
                
                const modelPath = modelSelect.value;
                if (!modelPath) {
                    statusDiv.textContent = 'Please select a model first';
                    statusDiv.style.color = '#ff4444';
                    return;
                }
                
                statusDiv.textContent = 'Selecting model...';
                statusDiv.style.color = '#aaa';
                
                const response = await fetch('/api/ml/model/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model_path: modelPath })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusDiv.textContent = '‚úÖ Model selected successfully!';
                    statusDiv.style.color = '#00ff88';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏ –∏ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    setTimeout(() => {
                        if (typeof loadMLModelInfo !== 'undefined') {
                            loadMLModelInfo();
                        }
                    }, 300);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    setTimeout(() => {
                        if (typeof loadAllPairsModelsInfo !== 'undefined') {
                            loadAllPairsModelsInfo();
                        }
                    }, 500);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    modelSelect.dataset.currentModel = modelPath;
                } else {
                    statusDiv.textContent = `‚ùå Error: ${result.error || 'Unknown error'}`;
                    statusDiv.style.color = '#ff4444';
                }
            } catch (error) {
                console.error('Error selecting ML model:', error);
                const statusDiv = document.getElementById('select-model-status');
                if (statusDiv) {
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        window.selectMLModel = selectMLModel;
        
        async function saveMLModelTypeForAll() {
            try {
                const modelTypeSelect = document.getElementById('ml-model-type-for-all');
                const statusDiv = document.getElementById('model-type-status');
                
                if (!modelTypeSelect) {
                    console.error('ml-model-type-for-all select not found');
                    return;
                }
                
                const modelType = modelTypeSelect.value || "";
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        app: {
                            ml_model_type_for_all: modelType || null
                        }
                    })
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned non-JSON response (${response.status}): ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (statusDiv) {
                        const displayType = modelType || 'Auto';
                        statusDiv.innerHTML = `<span style="color: #00ff88;">‚úî Model type for all pairs saved successfully! (${displayType})</span>`;
                    }
                    console.log('Model type for all pairs saved:', modelType || 'Auto');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    if (data.settings && data.settings.ml_model_type_for_all !== undefined) {
                        modelTypeSelect.value = data.settings.ml_model_type_for_all || "";
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        if (typeof loadSettings !== 'undefined') {
                            loadSettings();
                        }
                    }, 1000);
                } else {
                    const errorMsg = data.error || data.message || 'Failed to save model type';
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #ff4444;">Error: ${errorMsg}</span>`;
                    }
                    console.error('Error saving model type:', errorMsg);
                }
            } catch (error) {
                console.error('Error saving model type for all pairs:', error);
                const statusDiv = document.getElementById('model-type-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ff4444;">Error: ${error.message}</span>`;
                }
            }
        }
        
        window.saveMLModelTypeForAll = saveMLModelTypeForAll;
        
        async function retrainMLModel(mode = 'optimal') {
            try {
                const symbolSelect = document.getElementById('ml-symbol-select');
                const statusDiv = document.getElementById('retrain-status');
                
                if (!symbolSelect || !statusDiv) {
                    alert('Error: Could not find retrain elements');
                    return;
                }
                
                const symbol = symbolSelect.value;
                const modeDisplay = mode === 'optimal' ? '–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ' : '–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ';
                
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å ${modeDisplay} –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –¥–ª—è ${symbol}?`)) {
                    return;
                }
                
                statusDiv.textContent = `üöÄ –ó–∞–ø—É—Å–∫ ${modeDisplay} –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è...`;
                statusDiv.style.color = '#aaa';
                
                const response = await fetch('/api/ml/model/retrain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, mode: mode })
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.textContent = `‚úÖ ${result.message}`;
                    statusDiv.style.color = '#00ff88';
                } else {
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    statusDiv.style.color = '#ff4444';
                }
            } catch (error) {
                console.error('Retrain error:', error);
                const statusDiv = document.getElementById('retrain-status');
                if (statusDiv) {
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        window.retrainMLModel = retrainMLModel;
        
        async function retrainAllMLModels(mode = 'optimal') {
            try {
                const optimalBtn = document.getElementById('retrain-all-optimal-btn');
                const aggressiveBtn = document.getElementById('retrain-all-aggressive-btn');
                const statusDiv = document.getElementById('retrain-all-status');
                
                const modeName = mode === 'optimal' ? 'OPTIMAL' : 'AGGRESSIVE';
                
                if (!confirm(`Are you sure you want to retrain ALL ML models in ${modeName} mode?\n\nThis will retrain models for:\n- BTCUSDT\n- ETHUSDT\n- SOLUSDT\n\nThis process may take 10-20 minutes.`)) {
                    return;
                }
                
                if (optimalBtn) optimalBtn.disabled = true;
                if (aggressiveBtn) aggressiveBtn.disabled = true;
                
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ffaa00;">‚è≥ Starting ${modeName} model retraining... This may take 10-20 minutes.</span>`;
                }
                
                const response = await fetch('/api/ml/model/retrain-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #00ff88;">‚úÖ ${modeName} model retraining started! The models will be updated when training completes.</span>`;
                    }
                } else {
                    throw new Error(data.error || 'Failed to start retraining');
                }
            } catch (error) {
                console.error('Error retraining all ML models:', error);
                const statusDiv = document.getElementById('retrain-all-status');
                const optimalBtn = document.getElementById('retrain-all-optimal-btn');
                const aggressiveBtn = document.getElementById('retrain-all-aggressive-btn');
                
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ff4444;">‚ùå Error: ${error.message}</span>`;
                }
                
                if (optimalBtn) optimalBtn.disabled = false;
                if (aggressiveBtn) aggressiveBtn.disabled = false;
            }
        }
        
        window.retrainAllMLModels = retrainAllMLModels;
        
        async function loadWalletData() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`/api/wallet?symbol=${encodeURIComponent(selectedSymbol)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading wallet data:', data.error);
                    return;
                }
                
                const wallet = data.wallet || {};
                const position = data.position || null;
                const orders = data.open_orders || {};
                const trading = data.trading || {};
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ Dashboard (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                // Available Balance = Wallet Balance - Position Margin (—Å–≤–æ–±–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π)
                const walletBalance = wallet.wallet_balance || 0;
                const usedMargin = wallet.used_margin || 0;
                const availableBalance = walletBalance - usedMargin;
                
                const walletAvailableEl = document.getElementById('wallet-available');
                if (walletAvailableEl) {
                    walletAvailableEl.textContent = `${availableBalance.toFixed(2)} USDT`;
                    walletAvailableEl.style.color = '#00ff88';
                }
                
                const walletBalanceEl = document.getElementById('wallet-balance');
                if (walletBalanceEl) {
                    walletBalanceEl.textContent = wallet.wallet_balance ? `${wallet.wallet_balance.toFixed(2)} USDT` : '-';
                }
                
                const walletMarginEl = document.getElementById('wallet-margin');
                if (walletMarginEl) {
                    walletMarginEl.textContent = wallet.used_margin ? `${wallet.used_margin.toFixed(2)} USDT` : '-';
                    walletMarginEl.style.color = '#ffaa00';
                }
                
                // Total PnL –≤ –±–ª–æ–∫–µ Account –±–µ—Ä–µ—Ç—Å—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞ (cum_realised_pnl –∏–∑ –∫–æ—à–µ–ª—å–∫–∞)
                const totalPnlFromBalance = wallet.cum_realised_pnl !== undefined ? wallet.cum_realised_pnl : 0;
                const walletTotalPnlEl = document.getElementById('wallet-total-pnl');
                if (walletTotalPnlEl) {
                    walletTotalPnlEl.textContent = `${totalPnlFromBalance >= 0 ? '+' : ''}${totalPnlFromBalance.toFixed(2)} USDT`;
                    walletTotalPnlEl.className = `stat-value ${totalPnlFromBalance >= 0 ? 'positive' : 'negative'}`;
                }
                
                // Bonus
                const walletBonusEl = document.getElementById('wallet-bonus');
                if (walletBonusEl) {
                    if (wallet.bonus && wallet.bonus > 0) {
                        walletBonusEl.style.display = 'block';
                        const walletBonusValueEl = document.getElementById('wallet-bonus-value');
                        if (walletBonusValueEl) {
                            walletBonusValueEl.textContent = `${wallet.bonus.toFixed(2)} USDT`;
                            walletBonusValueEl.style.color = '#00d4ff';
                        }
                    } else {
                        walletBonusEl.style.display = 'none';
                    }
                }
                
                // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ /api/wallet - –ø–æ–∑–∏—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ symbols_status –≤ updateStatus()
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∏–º–≤–æ–ª–∞
                
                // Trading Statistics
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Trading Pair
                const primarySymbolSelectForStats = document.getElementById('primary-symbol-select');
                const selectedSymbolForStats = primarySymbolSelectForStats ? primarySymbolSelectForStats.value : (data.symbol || selectedSymbol || 'BTCUSDT');
                
                // Total PnL –≤ –±–ª–æ–∫–µ Trading Statistics –±–µ—Ä–µ—Ç—Å—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏ (cum_realised_pnl –∏–∑ –ø–æ–∑–∏—Ü–∏–∏) –∏–ª–∏ –∏–∑ –∫–æ—à–µ–ª—å–∫–∞
                // –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
                let totalPnlFromTrading = trading.total_pnl !== undefined ? trading.total_pnl : totalPnlFromBalance;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ updateStatus)
                if (typeof window.currentPnlStats !== 'undefined' && window.currentPnlStats && window.currentPnlStats.pnl_total !== undefined) {
                    totalPnlFromTrading = window.currentPnlStats.pnl_total;
                }
                
                let statsHtml = '';
                if (position) {
                    statsHtml += `<div class="stat-item"><span class="stat-label">Current Unrealised PnL:</span><span class="stat-value ${position.unrealised_pnl >= 0 ? 'positive' : 'negative'}">${position.unrealised_pnl >= 0 ? '+' : ''}${position.unrealised_pnl?.toFixed(2) || '0.00'} USDT</span></div>`;
                } else {
                    statsHtml += `<div class="stat-item"><span class="stat-label">Current Unrealised PnL:</span><span class="stat-value">0.00 USDT</span></div>`;
                }
                statsHtml += `<div class="stat-item"><span class="stat-label">Total PnL:</span><span class="stat-value ${totalPnlFromTrading >= 0 ? 'positive' : 'negative'}">${totalPnlFromTrading >= 0 ? '+' : ''}${totalPnlFromTrading.toFixed(2)} USDT</span></div>`;
                statsHtml += `<div class="stat-item"><span class="stat-label">Trading Pair:</span><span class="stat-value">${selectedSymbolForStats}</span></div>`;
                const tradingStatsEl = document.getElementById('trading-stats');
                if (tradingStatsEl) {
                    tradingStatsEl.innerHTML = statsHtml;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º
                if (typeof loadCombinedPnlStats === 'function') {
                    try {
                        await loadCombinedPnlStats();
                    } catch (e) {
                        console.warn('Error loading combined PnL stats:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ UI
                const walletAvailableEl = document.getElementById('wallet-available');
                if (walletAvailableEl) {
                    walletAvailableEl.textContent = 'Error loading';
                    walletAvailableEl.style.color = '#ff4444';
                }
            }
        }
        
        async function loadCombinedPnlStats() {
            try {
                const response = await fetch('/api/pnl/combined');
                const data = await response.json();
                
                if (!data.success || !data.combined) {
                    document.getElementById('combined-pnl-stats').innerHTML = '<div style="color: #aaa; font-size: 0.9em;">No statistics available</div>';
                    return;
                }
                
                const combined = data.combined;
                const perSymbol = data.per_symbol || {};
                const activeSymbols = data.active_symbols || [];
                
                let html = '';
                
                // –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                html += '<div style="margin-bottom: 20px;">';
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Today:</span><span class="stat-value ${combined.pnl_today >= 0 ? 'positive' : 'negative'}">${combined.pnl_today >= 0 ? '+' : ''}${combined.pnl_today.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Week:</span><span class="stat-value ${combined.pnl_week >= 0 ? 'positive' : 'negative'}">${combined.pnl_week >= 0 ? '+' : ''}${combined.pnl_week.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Month:</span><span class="stat-value ${combined.pnl_month >= 0 ? 'positive' : 'negative'}">${combined.pnl_month >= 0 ? '+' : ''}${combined.pnl_month.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined Total PnL:</span><span class="stat-value ${combined.pnl_total >= 0 ? 'positive' : 'negative'}" style="font-weight: bold; font-size: 1.1em;">${combined.pnl_total >= 0 ? '+' : ''}${combined.pnl_total.toFixed(2)} USDT</span></div>`;
                html += '</div>';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∏–º–≤–æ–ª—É
                if (activeSymbols.length > 1 && Object.keys(perSymbol).length > 0) {
                    html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">';
                    html += '<h4 style="color: #aaa; margin-bottom: 10px; font-size: 0.95em;">Per Symbol:</h4>';
                    for (const symbol of activeSymbols) {
                        const stats = perSymbol[symbol];
                        if (stats) {
                            html += `<div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-radius: 5px;">`;
                            html += `<div style="font-weight: bold; color: #00d4ff; margin-bottom: 5px;">${symbol}</div>`;
                            html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85em;">`;
                            html += `<div><span style="color: #aaa;">Today:</span> <span class="${stats.pnl_today >= 0 ? 'positive' : 'negative'}">${stats.pnl_today >= 0 ? '+' : ''}${stats.pnl_today.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Week:</span> <span class="${stats.pnl_week >= 0 ? 'positive' : 'negative'}">${stats.pnl_week >= 0 ? '+' : ''}${stats.pnl_week.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Month:</span> <span class="${stats.pnl_month >= 0 ? 'positive' : 'negative'}">${stats.pnl_month >= 0 ? '+' : ''}${stats.pnl_month.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Total:</span> <span class="${stats.pnl_total >= 0 ? 'positive' : 'negative'}" style="font-weight: bold;">${stats.pnl_total >= 0 ? '+' : ''}${stats.pnl_total.toFixed(2)}</span></div>`;
                            html += `</div></div>`;
                        }
                    }
                    html += '</div>';
                }
                
                document.getElementById('combined-pnl-stats').innerHTML = html;
            } catch (error) {
                console.error('Error loading combined PnL stats:', error);
                document.getElementById('combined-pnl-stats').innerHTML = '<div style="color: #ff4444; font-size: 0.9em;">Error loading statistics</div>';
            }
        }
        
        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        async function loadWallet() {
            await loadWalletData();
        }
        window.loadWallet = loadWallet;
        window.loadWalletData = loadWalletData;
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, Tonkeeper)
        if (typeof window.ton !== 'undefined' && typeof window.ton.destroy !== 'function') {
            // –ï—Å–ª–∏ window.ton —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ destroy –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ
            try {
                window.ton.destroy = function() {
                    // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫
                };
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
            }
        }
        
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        let serverAvailable = true;
        let consecutiveErrors = 0;
        const maxConsecutiveErrors = 3;
        const errorBackoffDelay = 10000; // 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        
        // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è updateStatus —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function updateStatusWithErrorHandling() {
            try {
                await updateStatus();
                
                // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
                consecutiveErrors = 0;
                if (!serverAvailable) {
                    serverAvailable = true;
                    console.log('[UI] Server connection restored');
                }
            } catch (error) {
                // updateStatus() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Ö –Ω–∞—Ä—É–∂—É
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏
                const statusElement = document.getElementById('current-status');
                const hasError = statusElement && statusElement.innerHTML.includes('Connection Error');
                
                if (hasError) {
                    consecutiveErrors++;
                    if (consecutiveErrors >= maxConsecutiveErrors && serverAvailable) {
                        serverAvailable = false;
                        console.warn(`[UI] Server unavailable after ${maxConsecutiveErrors} consecutive errors. Reducing update frequency to ${errorBackoffDelay}ms.`);
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    consecutiveErrors = 0;
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStatusWithErrorHandling();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        function scheduleNextUpdate() {
            if (updateInterval) {
                clearTimeout(updateInterval);
                updateInterval = null;
            }
            
            const delay = serverAvailable ? 5000 : errorBackoffDelay; // 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            updateInterval = setTimeout(() => {
                updateStatusWithErrorHandling().finally(() => {
                    scheduleNextUpdate();
                });
            }, delay);
        }
        
        scheduleNextUpdate();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞
        loadChartLW();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.loadChart = loadChart;
        // startBot –∏ stopBot —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã—à–µ (—Å—Ç—Ä–æ–∫–∏ 2106 –∏ 2227)
        
        setInterval(loadChart, 60000); // 60000 –º—Å = 1 –º–∏–Ω—É—Ç–∞
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
        setTimeout(() => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
            if (typeof loadSymbolSettings !== 'undefined') {
                loadSymbolSettings();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (typeof loadSymbolsStatus === 'function') {
                loadSymbolsStatus();
            }
            
            if (typeof loadStrategySelection !== 'undefined') {
                loadStrategySelection();
            }
            if (typeof loadMLModelsList !== 'undefined') {
                loadMLModelsList();
            }
            if (typeof loadMLModelInfo !== 'undefined') {
                loadMLModelInfo();
            }
            if (typeof loadAllPairsModelsInfo !== 'undefined') {
                loadAllPairsModelsInfo();
            }
        }, 100);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
        document.getElementById('show-sma').addEventListener('change', loadChart);
        document.getElementById('show-bb').addEventListener('change', loadChart);
        document.getElementById('show-volume').addEventListener('change', loadChart);
        document.getElementById('show-signals').addEventListener('change', loadChart);
        document.getElementById('show-rsi').addEventListener('change', loadChart);
        document.getElementById('show-macd').addEventListener('change', loadChart);
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ API Bybit
        async function loadBybitApiSettings() {
            try {
                const response = await fetch('/api/bybit/settings');
                if (response.ok) {
                    const data = await response.json();
                    const apiKeyInput = document.getElementById('bybit-api-key');
                    const apiSecretInput = document.getElementById('bybit-api-secret');
                    const baseUrlSelect = document.getElementById('bybit-base-url');
                    
                    if (apiKeyInput) {
                        apiKeyInput.value = data.api_key || "";
                    }
                    if (apiSecretInput) {
                        apiSecretInput.value = data.api_secret || "";
                    }
                    if (baseUrlSelect && data.base_url) {
                        baseUrlSelect.value = data.base_url;
                    }
                    
                    const statusDiv = document.getElementById('api-settings-status');
                    if (statusDiv) {
                        statusDiv.textContent = 'Settings loaded successfully.';
                        statusDiv.style.color = '#00ff88';
                    }
                } else {
                    const statusDiv = document.getElementById('api-settings-status');
                    if (statusDiv) {
                        statusDiv.textContent = 'Could not load settings.';
                        statusDiv.style.color = '#ff4444';
                    }
                }
            } catch (error) {
                console.error('Error loading API settings:', error);
                const statusDiv = document.getElementById('api-settings-status');
                if (statusDiv) {
                    statusDiv.textContent = 'Error loading settings: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        
        async function saveBybitApiSettings() {
            const apiKeyInput = document.getElementById('bybit-api-key');
            const apiSecretInput = document.getElementById('bybit-api-secret');
            const baseUrlSelect = document.getElementById('bybit-base-url');
            const statusDiv = document.getElementById('api-settings-status');
            
            if (!apiKeyInput || !apiSecretInput || !baseUrlSelect) {
                alert('Error: Settings form elements not found');
                return;
            }
            
            const apiKey = apiKeyInput.value.trim();
            const apiSecret = apiSecretInput.value.trim();
            const baseUrl = baseUrlSelect.value.trim();
            
            if (!apiKey || !apiSecret || !baseUrl) {
                alert('Please fill in all fields');
                return;
            }
            
            if (statusDiv) {
                statusDiv.textContent = 'Saving...';
                statusDiv.style.color = '#00d4ff';
            }
            
            try {
                const response = await fetch('/api/bybit/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        api_secret: apiSecret,
                        base_url: baseUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (statusDiv) {
                        statusDiv.textContent = '‚úÖ Settings saved successfully! Please restart the bot for changes to take effect.';
                        statusDiv.style.color = '#00ff88';
                    }
                    alert('‚úÖ API settings saved successfully!\n\nPlease restart the bot for changes to take effect.');
                } else {
                    if (statusDiv) {
                        statusDiv.textContent = '‚ùå Error: ' + (result.error || 'Unknown error');
                        statusDiv.style.color = '#ff4444';
                    }
                    alert('‚ùå Error saving settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving API settings:', error);
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Error: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
                alert('‚ùå Error saving settings: ' + error.message);
            }
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà Hide';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è Show';
            }
        }
        
        async function logout(force = false) {
            if (!force && !confirm('Are you sure you want to logout?')) {
                return;
            }
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    window.location.href = '/login';
                }
            } catch (error) {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/login';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function changeAdminPassword() {
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const statusDiv = document.getElementById('password-change-status');
            
            if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput) {
                alert('Error: Password form elements not found');
                return;
            }
            
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!currentPassword || !newPassword || !confirmPassword) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Please fill in all fields';
                    statusDiv.style.color = '#ff4444';
                }
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword.length < 6) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå New password must be at least 6 characters long';
                    statusDiv.style.color = '#ff4444';
                }
                alert('New password must be at least 6 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå New passwords do not match';
                    statusDiv.style.color = '#ff4444';
                }
                alert('New passwords do not match');
                return;
            }
            
            if (statusDiv) {
                statusDiv.textContent = 'Changing password...';
                statusDiv.style.color = '#00d4ff';
            }
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (statusDiv) {
                        statusDiv.textContent = '‚úÖ Password changed successfully! Please log in again with the new password.';
                        statusDiv.style.color = '#00ff88';
                    }
                    alert('‚úÖ Password changed successfully!\n\nPlease log in again with the new password.');
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
                    setTimeout(() => {
                        logout(true);
                    }, 2000);
                } else {
                    if (statusDiv) {
                        statusDiv.textContent = '‚ùå Error: ' + (result.error || 'Unknown error');
                        statusDiv.style.color = '#ff4444';
                    }
                    alert('‚ùå Error changing password: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error changing password:', error);
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Error: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
                alert('‚ùå Error changing password: ' + error.message);
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
        window.loadBybitApiSettings = loadBybitApiSettings;
        window.saveBybitApiSettings = saveBybitApiSettings;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.logout = logout;
        window.changeAdminPassword = changeAdminPassword;
    </script>
</body>
</html>

