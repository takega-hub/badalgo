<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Crypto Bot Admin</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 500px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00d4ff;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #aaa;
        }
        
        .stat-value {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #00ff88;
        }
        
        .stat-value.negative {
            color: #ff4444;
        }
        
        .btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #00b8e6;
        }
        
        .btn.danger {
            background: #ff4444;
            color: #fff;
        }
        
        .btn.danger:hover {
            background: #cc0000;
        }
        
        .btn.success {
            background: #00ff88;
            color: #000;
        }
        
        .btn.success:hover {
            background: #00cc6a;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.running {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-indicator.stopped {
            background: #ff4444;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
        }
        
        th {
            color: #00d4ff;
            font-weight: bold;
        }
        
        td {
            color: #e0e0e0;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è PnL –≤ —Ç–∞–±–ª–∏—Ü–µ */
        td.positive {
            color: #00ff88 !important;
            font-weight: bold;
        }
        
        td.negative {
            color: #ff4444 !important;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }
        
        .chart-container {
            width: 100%;
            height: 1200px;  /* –£–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã */
            margin-top: 20px;
        }
        
        .chart-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chart-controls label {
            color: #aaa;
            margin-right: 5px;
        }
        
        .chart-controls input[type="checkbox"] {
            margin-right: 20px;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #1a1a1a;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            padding: 8px 16px;
            color: #00d4ff;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
            transition: all 0.3s;
        }
        
        .mode-toggle:hover {
            background: #00d4ff;
            color: #000;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.5);
        }
        
        .mode-toggle.mobile-active {
            background: #00d4ff;
            color: #000;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body.mobile-mode {
            padding: 10px;
        }
        
        body.mobile-mode .container {
            max-width: 100%;
        }
        
        body.mobile-mode h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-right: 100px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è */
        }
        
        body.mobile-mode .tabs {
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        body.mobile-mode .tab {
            padding: 12px 16px;
            font-size: 0.95em;
            flex: 1 1 auto;
            min-width: calc(50% - 5px);
        }
        
        body.mobile-mode .card {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        body.mobile-mode .card h2 {
            font-size: 1.2em;
            margin-bottom: 12px;
        }
        
        body.mobile-mode .btn {
            padding: 14px 20px;
            font-size: 1.1em;
            margin: 8px 0;
            width: 100%;
            min-height: 48px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è */
        }
        
        body.mobile-mode .stat-item {
            padding: 12px 0;
            font-size: 1.1em;
        }
        
        body.mobile-mode .stat-label {
            font-size: 1em;
        }
        
        body.mobile-mode .stat-value {
            font-size: 1.2em;
        }
        
        body.mobile-mode .form-group {
            margin-bottom: 20px;
        }
        
        body.mobile-mode .form-group label {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        body.mobile-mode .form-group input,
        body.mobile-mode .form-group select,
        body.mobile-mode .form-group textarea {
            padding: 14px;
            font-size: 1.1em;
            min-height: 48px;
        }
        
        body.mobile-mode table {
            font-size: 0.9em;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        body.mobile-mode th,
        body.mobile-mode td {
            padding: 12px 8px;
            font-size: 1em;
            white-space: nowrap;
        }
        
        body.mobile-mode .chart-container {
            height: 600px;
            margin-top: 15px;
        }
        
        body.mobile-mode .chart-controls {
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        body.mobile-mode .chart-controls label {
            font-size: 1em;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 6px;
            min-height: 44px;
            display: flex;
            align-items: center;
            flex: 1 1 auto;
            min-width: calc(50% - 4px);
        }
        
        body.mobile-mode .chart-controls input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        body.mobile-mode .grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        body.mobile-mode .mode-toggle {
            top: 10px;
            right: 10px;
            padding: 10px 18px;
            font-size: 0.85em;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        body.mobile-mode .form-group p {
            font-size: 1em;
            line-height: 1.5;
        }
        
        body.mobile-mode label {
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        body.mobile-mode .stat-item label {
            font-size: 1.1em;
        }
        
        body.mobile-mode input[type="checkbox"],
        body.mobile-mode input[type="radio"] {
            width: 24px !important;
            height: 24px !important;
            min-width: 24px;
            min-height: 24px;
            margin-right: 12px;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        
        body.mobile-mode .table-wrapper {
            margin: 0 -15px;
            padding: 0 15px;
        }
        
        body.mobile-mode .table-wrapper table {
            min-width: 600px;
            font-size: 0.95em;
        }
        
        body.mobile-mode .table-wrapper th,
        body.mobile-mode .table-wrapper td {
            padding: 10px 6px;
            font-size: 0.95em;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            body.mobile-mode h1 {
                font-size: 1.5em;
                padding-right: 90px;
            }
            
            body.mobile-mode .tab {
                font-size: 0.85em;
                padding: 10px 12px;
            }
            
            body.mobile-mode .mode-toggle {
                padding: 8px 14px;
                font-size: 0.75em;
            }
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        body.mobile-mode {
            -webkit-overflow-scrolling: touch;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ touch targets */
        body.mobile-mode button,
        body.mobile-mode .tab,
        body.mobile-mode input[type="checkbox"],
        body.mobile-mode input[type="radio"] {
            -webkit-tap-highlight-color: rgba(0, 212, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ -->
        <button class="mode-toggle" id="modeToggle" onclick="toggleMobileMode()">
            <span id="modeIcon">üì±</span>
            <span id="modeText">Mobile</span>
        </button>
        
        <h1>ü§ñ Crypto Bot Admin Panel</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">Dashboard</button>
            <button class="tab" onclick="showTab('symbols', event)">Symbols</button>
            <button class="tab" onclick="showTab('strategies', event)">Strategies</button>
            <button class="tab" onclick="showTab('strategy', event)">Strategy Settings</button>
            <button class="tab" onclick="showTab('risk', event)">Risk</button>
            <button class="tab" onclick="showTab('trades', event)">Trades</button>
            <button class="tab" onclick="showTab('signals', event)">Signals</button>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="tab" onclick="showTab('settings', event)">Settings</button>
                <button class="tab" onclick="logout()" style="color: #ff6666;">Logout</button>
            </div>
        </div>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ -->
        <div id="symbol-selector" style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
            <label style="color: #aaa; margin-right: 10px;">Active Symbol (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞):</label>
            <select id="primary-symbol-select" style="padding: 8px 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; font-size: 1em; cursor: pointer;" onchange="changePrimarySymbol(this.value)" title="–í—ã–±–æ—Ä —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞, —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–¥–µ–ª–æ–∫. –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ—Ä–≥–æ–≤—É—é –ª–æ–≥–∏–∫—É.">
                <option value="BTCUSDT">BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="SOLUSDT">SOLUSDT</option>
            </select>
            <span id="active-symbols-status" style="margin-left: 20px; color: #aaa; font-size: 0.9em;"></span>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2>Bot Status</h2>
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="bot-status">
                        <span class="status-indicator stopped"></span>Stopped
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current Status:</span>
                    <span class="stat-value" id="current-status">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Market Phase:</span>
                    <span class="stat-value" id="market-phase">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ADX:</span>
                    <span class="stat-value" id="current-adx">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Action:</span>
                    <span class="stat-value" id="last-action" style="font-size: 0.9em; color: #aaa;">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Signal:</span>
                    <span class="stat-value" id="last-signal" style="font-size: 0.9em; color: #aaa;">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Update:</span>
                    <span class="stat-value" id="last-update">-</span>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn success" onclick="startBot()">Start Bot</button>
                    <button class="btn danger" onclick="stopBot()">Stop Bot</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>Account</h2>
                    <div class="stat-item">
                        <span class="stat-label">Symbol:</span>
                        <span class="stat-value" id="symbol">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Leverage:</span>
                        <span class="stat-value" id="leverage">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Available Balance:</span>
                        <span class="stat-value" id="wallet-available">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Wallet Balance:</span>
                        <span class="stat-value" id="wallet-balance">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Position Margin:</span>
                        <span class="stat-value" id="wallet-margin">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total PnL:</span>
                        <span class="stat-value" id="wallet-total-pnl">-</span>
                    </div>
                    <div id="wallet-bonus" style="display: none;">
                        <div class="stat-item">
                            <span class="stat-label">Bonus:</span>
                            <span class="stat-value" id="wallet-bonus-value">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Position</h2>
                    <div class="stat-item">
                        <span class="stat-label">Side:</span>
                        <span class="stat-value" id="position-side">None</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Size:</span>
                        <span class="stat-value" id="position-size">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Entry Price:</span>
                        <span class="stat-value" id="position-entry">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Current Price:</span>
                        <span class="stat-value" id="position-current-price">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unrealised PnL:</span>
                        <span class="stat-value" id="position-pnl">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL %:</span>
                        <span class="stat-value" id="position-pnl-pct">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Take Profit:</span>
                        <span class="stat-value" id="position-tp">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Stop Loss:</span>
                        <span class="stat-value" id="position-sl">-</span>
                    </div>
                    <div class="stat-item" id="position-strategy-container" style="display: none;">
                        <span class="stat-label">Strategy:</span>
                        <span class="stat-value" id="position-strategy">-</span>
                    </div>
                    <div class="stat-item" id="position-entry-signal-container" style="display: none;">
                        <span class="stat-label">Entry Signal:</span>
                        <span class="stat-value" id="position-entry-signal" style="font-size: 0.9em; word-break: break-word;">-</span>
                    </div>
                    <div class="stat-item" id="position-trade-id-container" style="display: none;">
                        <span class="stat-label">Trade ID:</span>
                        <span class="stat-value" id="position-trade-id" style="font-size: 0.85em; color: #888; font-family: monospace;">-</span>
                    </div>
                    <div class="stat-item" id="position-close-button-container" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
                        <button class="btn danger" id="close-position-btn" onclick="closePosition()" style="width: 100%;">
                            üîí Close Position
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Orders</h2>
                    <div class="stat-item">
                        <span class="stat-label">Open Orders:</span>
                        <span class="stat-value" id="open-orders">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Orders Margin:</span>
                        <span class="stat-value" id="orders-margin">-</span>
                    </div>
                    <div id="tp-orders-list" style="margin-top: 10px;">
                        <!-- TP orders will be inserted here -->
                    </div>
                    <div id="sl-orders-list" style="margin-top: 10px;">
                        <!-- SL orders will be inserted here -->
                    </div>
                </div>
                
                <div class="card">
                    <h2>Trading Statistics</h2>
                    <div id="trading-stats">
                        <div class="loading">Loading statistics...</div>
                    </div>
                    <div id="combined-stats" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                        <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.1em;">üìä Combined Statistics (All Active Symbols)</h3>
                        <div id="combined-pnl-stats">
                            <div class="loading" style="font-size: 0.9em;">Loading combined statistics...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Symbols Status Panel on Dashboard -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>üìà Symbols Status</h2>
                <div id="dashboard-symbols-status-list" style="margin-top: 15px;">
                    <div class="loading">Loading symbols status...</div>
                </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Price Chart & Signals</h2>
                <div class="chart-controls">
                    <label><input type="checkbox" id="show-sma" checked> SMA20</label>
                    <label><input type="checkbox" id="show-bb" checked> Bollinger Bands</label>
                    <label><input type="checkbox" id="show-volume" checked> Volume</label>
                    <label><input type="checkbox" id="show-rsi"> RSI</label>
                    <label><input type="checkbox" id="show-macd" checked> MACD</label>
                    <label><input type="checkbox" id="show-signals" checked> Entry Signals</label>
                    <button class="btn" onclick="loadChartLW()" style="margin-left: auto;">Refresh Chart</button>
                </div>
                <div id="chart-container" class="chart-container">
                    <div class="loading">Loading chart...</div>
                </div>
            </div>
        </div>
        
        <!-- Symbols Tab -->
        <div id="symbols" class="tab-content">
            <div class="card">
                <h2>üìä Trading Symbols Management</h2>
                <p style="color: #aaa; margin-bottom: 20px;">
                    <strong>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –í–°–ï–ú–ò –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</strong><br>
                    –í—ã–±–æ—Ä –ø–∞—Ä—ã –Ω–∏–∂–µ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞, —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–¥–µ–ª–æ–∫ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
                </p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #aaa; display: block; margin-bottom: 10px;">
                        <strong>Active Symbols (–≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏):</strong>
                    </label>
                    <div id="available-symbols-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="BTCUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">BTCUSDT</span>
                            <span style="color: #ffaa00; margin-left: 10px; font-size: 0.9em;">(–ì–ª–∞–≤–Ω–∞—è –ø–∞—Ä–∞ - —Ç—Ä–µ–Ω–¥ BTC –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="ETHUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">ETHUSDT</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                            <input type="checkbox" value="SOLUSDT" class="symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span style="color: #e0e0e0; font-weight: bold;">SOLUSDT</span>
                        </label>
                    </div>
                    <small style="color: #888; display: block; margin-top: 10px;">
                        ‚úÖ –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—è–º–∏ –ø–æ –í–°–ï–ú –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–∞—Ä–∞–º.<br>
                        üí° –ï—Å–ª–∏ BTC —Ä–∞—Å—Ç–µ—Ç ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LONG —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–∞—Ä. –ï—Å–ª–∏ BTC –ø–∞–¥–∞–µ—Ç ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç SHORT.
                    </small>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #aaa; display: block; margin-bottom: 10px;">
                        <strong>PRIMARY_SYMBOL (–æ—Å–Ω–æ–≤–Ω–∞—è –ø–∞—Ä–∞ BTC –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):</strong>
                    </label>
                    <select id="symbols-primary-select" style="padding: 10px 15px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; font-size: 1em; width: 200px;">
                        <option value="BTCUSDT">BTCUSDT</option>
                        <option value="ETHUSDT">ETHUSDT</option>
                        <option value="SOLUSDT">SOLUSDT</option>
                    </select>
                    <p style="color: #666; font-size: 0.9em; margin-top: 5px;">
                        –≠—Ç–∞ –ø–∞—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ <strong>PRIMARY_SYMBOL</strong>:<br>
                        - –ø—Ä–∏ —Ä–æ—Å—Ç–µ BTC ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LONG —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ –¥—Ä—É–≥–∏–º –ø–∞—Ä–∞–º;<br>
                        - –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ BTC ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç SHORT —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ –¥—Ä—É–≥–∏–º –ø–∞—Ä–∞–º;<br>
                        - –µ—Å–ª–∏ –Ω–∞ PRIMARY_SYMBOL –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏—è, –±–æ—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞—Ö.<br>
                        –ì—Ä–∞—Ñ–∏–∫ –∏ –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Ç–∞–∫–∂–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ —ç—Ç–æ–π –ø–∞—Ä–µ.
                    </p>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 5px; border: 1px solid #444;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="follow-primary-symbol-checkbox" style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
                            <span style="color: #e0e0e0; font-weight: bold;">–°–ª–µ–¥–æ–≤–∞—Ç—å –∑–∞ –≥–ª–∞–≤–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º (PRIMARY_SYMBOL)</span>
                        </label>
                        <p style="color: #666; font-size: 0.9em; margin-top: 8px; margin-left: 30px;">
                            <strong>–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ:</strong> –ë–æ—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–¥–µ–ª–∫–∏ —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º –∂–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏, —á—Ç–æ –∏ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ PRIMARY_SYMBOL.<br>
                            <strong>–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ:</strong> –ë–æ—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–æ PRIMARY_SYMBOL –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–¥–µ–ª–∫–∏ –ø–æ –≤—Å–µ–º —Å–∏–≥–Ω–∞–ª–∞–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞.
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn success" onclick="saveSymbolSettings()">üíæ Save Symbol Settings</button>
                    <button class="btn" onclick="loadSymbolSettings()" style="margin-left: 10px;">üîÑ Refresh</button>
                </div>
                
                <div id="symbols-status-message" style="margin-top: 20px; padding: 15px; border-radius: 5px; display: none;"></div>
                
                <div class="card" style="margin-top: 30px;">
                    <h2>üìà Symbols Status</h2>
                    <div id="symbols-status-list" style="margin-top: 15px;">
                        <p style="color: #666;">Loading symbols status...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Strategies Selection Tab -->
        <div id="strategies" class="tab-content">
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Strategy Selection (Per Symbol)</h2>
                <p style="color: #aaa; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π –ø–∞—Ä—ã –æ—Ç–¥–µ–ª—å–Ω–æ. –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
                
                <!-- –í—ã–±–æ—Ä –ø–∞—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="form-group" style="margin-bottom: 25px; padding: 15px; background: #1a2a2a; border: 1px solid #00d4ff; border-radius: 8px;">
                    <label for="strategy-symbol-select" style="display: block; margin-bottom: 10px; color: #00d4ff; font-weight: bold; font-size: 1.1em;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</label>
                    <select id="strategy-symbol-select" style="width: 100%; max-width: 400px; padding: 10px; border-radius: 4px; background-color: #333; color: #e0e0e0; border: 2px solid #00d4ff; font-size: 1.1em; font-weight: bold;" onchange="loadStrategySettingsForSymbol()">
                        <option value="BTCUSDT">BTCUSDT</option>
                        <option value="ETHUSDT">ETHUSDT</option>
                        <option value="SOLUSDT">SOLUSDT</option>
                    </select>
                    <p style="color: #888; font-size: 0.85em; margin-top: 8px; margin-bottom: 0;">
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—É –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –µ—ë —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
                    </p>
                </div>
                
                <div id="strategy-settings-container">
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-trend-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00ff88;">Trend Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Trend strategy - ADX > 25)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-flat-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ffaa00;">Flat Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Flat strategy)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-ml-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #9933ff;">ML Strategy</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Machine Learning)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-momentum-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00d4ff;">Momentum Breakout</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(–ò–º–ø—É–ª—å—Å–Ω—ã–π –ø—Ä–æ–±–æ–π –¥–ª—è —Ç—Ä–µ–Ω–¥–∞)</span>
                    </label>
                </div>
                
                
                <div class="stat-item">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="smcCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-size: 1.1em; font-weight: bold; color: #9d4edd;">Smart Money Concepts (SMC)</span>
                            <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Fair Value Gaps, Order Blocks)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-ict-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ff6b6b;">ICT Silver Bullet</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Inner Circle Trader - Silver Bullet)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-liquidation-hunter-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ff9500;">Liquidation Hunter</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è–º–∏)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-zscore-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00ffaa;">Z-Score</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ä–µ–¥–Ω–µ–º—É)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-vbo-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #ff00ff;">VBO (Volatility Breakout)</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(–í–æ–ª–∞—Ç–∏–ª—å–Ω—ã–π –ø—Ä–æ–±–æ–π)</span>
                    </label>
                </div>
                
                <div class="stat-item" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enable-amt-of-strategy" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-size: 1.1em; font-weight: bold; color: #00d4ff;">AMT &amp; Order Flow Scalper</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.9em;">(Absorption Squeeze –ø–æ –ª–µ–Ω—Ç–µ)</span>
                    </label>
                </div>
                
                <div class="form-group" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #444;">
                    <label for="strategy-priority-select" style="display: block; margin-bottom: 10px; color: #aaa; font-weight: bold;">Strategy Priority (–ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —Å–∏–≥–Ω–∞–ª–æ–≤):</label>
                    <select id="strategy-priority-select" style="width: 100%; max-width: 400px; padding: 8px; border-radius: 4px; background-color: #333; color: #e0e0e0; border: 1px solid #555; font-size: 1em;">
                        <option value="trend">Trend Strategy Priority</option>
                        <option value="flat">Flat Strategy Priority</option>
                        <option value="ml">ML Strategy Priority</option>
                        <option value="momentum">Momentum Breakout Priority</option>
                        <option value="smc">Smart Money Concepts Priority</option>
                        <option value="ict">ICT Silver Bullet Priority</option>
                        <option value="liquidation_hunter">Liquidation Hunter Priority</option>
                        <option value="zscore">Z-Score Priority</option>
                        <option value="vbo">VBO Priority</option>
                        <option value="amt_of">AMT &amp; Order Flow Priority</option>
                        <option value="hybrid">Hybrid (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª)</option>
                        <option value="confluence">Confluence (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ 2+ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)</option>
                    </select>
                    <p style="color: #888; font-size: 0.85em; margin-top: 8px; margin-bottom: 0;">
                        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Å–∏–≥–Ω–∞–ª—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É. –í —Ä–µ–∂–∏–º–µ <b>Hybrid</b> –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª. –í —Ä–µ–∂–∏–º–µ <b>Confluence</b> —Å–¥–µ–ª–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ—Ç –¥–≤—É—Ö –∏ –±–æ–ª–µ–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
                    </p>
                </div>
                
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn success" onclick="saveStrategySelection()">üíæ Save Strategy Selection for Selected Symbol</button>
                    <button class="btn" onclick="copyStrategySettingsToAllSymbols()" style="margin-left: 10px; background: #555; color: #fff;">üìã Copy to All Symbols</button>
                </div>
                
                <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π -->
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%); border: 2px solid #00d4ff; border-radius: 8px;">
                    <h3 style="color: #00d4ff; margin-top: 0; margin-bottom: 15px;">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π</h3>
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                        –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä. 
                        –ë–æ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">–ü–µ—Ä–∏–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–Ω–µ–π):</label>
                        <input type="number" id="optimize-days" value="30" min="7" max="90" style="width: 100px; padding: 5px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π PnL –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:</label>
                        <input type="number" id="optimize-min-pnl" value="0.0" step="0.01" style="width: 100px; padding: 5px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                        <span style="color: #888; font-size: 0.9em; margin-left: 10px;">USDT (—Ç–æ–ª—å–∫–æ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Win Rate (%):</label>
                        <input type="number" id="optimize-min-win-rate" value="0" min="0" max="100" style="width: 100px; padding: 5px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                        <span style="color: #888; font-size: 0.9em; margin-left: 10px;">% (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫)</span>
                    </div>
                    
                    <button class="btn" onclick="optimizeStrategies()" id="optimize-btn" style="background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: #000; font-weight: bold; padding: 12px 24px; font-size: 1.1em;">
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                    </button>
                    
                    <div id="optimize-status" style="margin-top: 15px; color: #aaa;"></div>
                    <div id="optimize-results" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
            
            <!-- ML Model Management -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>ML Model Management</h2>
                
                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä -->
                <div style="margin-bottom: 30px; padding: 20px; background: #1a2a2a; border: 1px solid #00d4ff; border-radius: 8px;">
                    <h3 style="color: #00d4ff; margin-top: 0; margin-bottom: 15px;">üîß Model Type for All Pairs</h3>
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                        Select the model type to use for all trading pairs (BTCUSDT, ETHUSDT, SOLUSDT). 
                        This setting will be applied automatically when models are loaded for each pair.
                    </p>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Model Type for All Pairs:</span>
                        <select id="ml-model-type-for-all" style="width: 100%; max-width: 400px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="">Auto (Ensemble > RF > XGB)</option>
                            <option value="ensemble">üéØ Ensemble (RF + XGBoost) - Recommended</option>
                            <option value="rf">Random Forest</option>
                            <option value="xgb">XGBoost</option>
                        </select>
                    </label>
                    <button class="btn success" onclick="saveMLModelTypeForAll()" style="margin-top: 10px;">Save Model Type for All Pairs</button>
                    <div id="model-type-status" style="margin-top: 10px; color: #aaa;"></div>
                </div>
                
                <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–∞—Ä—ã -->
                <div style="margin-bottom: 20px; padding-top: 20px; border-top: 1px solid #444;">
                    <h3 style="color: #e0e0e0; margin-bottom: 15px;">Select Model for Current Pair</h3>
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                        Select a specific ML model for the current trading pair. This overrides the model type setting above.
                    </p>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Select ML Model:</span>
                        <select id="ml-model-select" style="width: 100%; max-width: 500px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="">Loading models...</option>
                        </select>
                    </label>
                    <button class="btn primary" onclick="selectMLModel()" id="select-model-btn" style="margin-top: 10px;">Select Model</button>
                    <div id="select-model-status" style="margin-top: 10px; color: #aaa;"></div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª—è—Ö –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä -->
                <div id="ml-models-all-pairs" style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                    <h4 style="color: #00d4ff; margin-top: 0; margin-bottom: 15px;">üìä Selected Models for All Pairs</h4>
                    <div id="all-pairs-models-content" style="color: #aaa;">
                        <p>Loading models info...</p>
                    </div>
                </div>
                
                <div id="ml-model-info" style="margin-bottom: 20px;">
                    <div class="loading">Loading model info...</div>
                </div>
                
                <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
                    <h3 style="color: #e0e0e0; margin-bottom: 15px;">Retrain Model</h3>
                    
                    <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                        <h4 style="color: #e0e0e0; margin-top: 0; margin-bottom: 15px;">üöÄ Retrain All ML Models</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Optimal Mode Card -->
                            <div style="padding: 12px; background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 4px;">
                                <h5 style="color: #00ff88; margin-top: 0; margin-bottom: 8px;">üü¢ Optimal Mode</h5>
                                <p style="font-size: 0.8em; color: #aaa; margin-bottom: 12px;">High Win Rate (70%+). Balanced signals.</p>
                                <button class="btn success" onclick="retrainAllMLModels('optimal')" id="retrain-all-optimal-btn" style="width: 100%; font-size: 0.9em;">Retrain Optimal</button>
                            </div>
                            <!-- Aggressive Mode Card -->
                            <div style="padding: 12px; background: rgba(255, 68, 68, 0.05); border: 1px solid rgba(255, 68, 68, 0.2); border-radius: 4px;">
                                <h5 style="color: #ff4444; margin-top: 0; margin-bottom: 8px;">üî• Aggressive Mode</h5>
                                <p style="font-size: 0.8em; color: #aaa; margin-bottom: 12px;">Maximum Signals (100+). Lower Win Rate.</p>
                                <button class="btn danger" onclick="retrainAllMLModels('aggressive')" id="retrain-all-aggressive-btn" style="width: 100%; font-size: 0.9em;">Retrain Aggressive</button>
                            </div>
                        </div>
                        <div id="retrain-all-status" style="margin-top: 10px; color: #aaa;"></div>
                    </div>
                    
                    <!-- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ -->
                    <div style="padding: 15px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px;">
                        <h4 style="color: #e0e0e0; margin-top: 0; margin-bottom: 10px;">Retrain Single Model</h4>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px; color: #aaa;">Trading Pair for Retraining:</span>
                            <select id="ml-symbol-select" style="width: 100%; max-width: 300px; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                                <option value="SOLUSDT" selected>SOL/USDT</option>
                        </select>
                    </label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn success" onclick="retrainMLModel('optimal')">Retrain Optimal</button>
                            <button class="btn danger" onclick="retrainMLModel('aggressive')">Retrain Aggressive</button>
                        </div>
                    <div id="retrain-status" style="margin-top: 10px; color: #aaa;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Statistics by Strategy -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Strategy Statistics</h2>
                <div id="strategy-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>
        </div>
        
        <!-- Strategy Settings Tab -->
        <div id="strategy" class="tab-content">
            <div class="card">
                <h2>Trend Strategy</h2>
                <div id="strategy-form">
                    <div class="loading">Loading settings...</div>
                </div>
            </div>
        </div>
        
        <!-- Risk Tab -->
        <div id="risk" class="tab-content">
            <div class="card">
                <h2>Risk Management</h2>
                <div id="risk-form">
                    <div class="loading">Loading settings...</div>
                </div>
            </div>
        </div>
        
        <!-- Trades Tab -->
        <div id="trades" class="tab-content">
            <div class="card">
                <h2>Trade History</h2>
                
                <!-- PnL Statistics -->
                <div id="pnl-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
                    <div class="stat-item">
                        <span class="stat-label">PnL —Å–µ–≥–æ–¥–Ω—è:</span>
                        <span class="stat-value" id="pnl-today">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
                        <span class="stat-value" id="pnl-week">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">PnL –∑–∞ –º–µ—Å—è—Ü:</span>
                        <span class="stat-value" id="pnl-month">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–û–±—â–∏–π PnL –ø–æ –ø–∞—Ä–µ:</span>
                        <span class="stat-value" id="pnl-total">-</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <button onclick="removeDuplicateTrades()" style="background: #ffaa00; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Remove Duplicates</button>
                </div>
                <div class="table-wrapper">
                    <div id="trades-table">
                        <div class="loading">Loading trades...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Bybit API Settings</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Configure your Bybit API credentials. Changes will be saved to .env file.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-api-key" style="display: block; margin-bottom: 8px; color: #aaa;">API Key:</label>
                    <input type="password" id="bybit-api-key" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter Bybit API Key">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-api-secret" style="display: block; margin-bottom: 8px; color: #aaa;">API Secret:</label>
                    <input type="password" id="bybit-api-secret" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter Bybit API Secret">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="bybit-base-url" style="display: block; margin-bottom: 8px; color: #aaa;">Base URL:</label>
                    <select id="bybit-base-url" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                        <option value="https://api.bybit.com">Production (https://api.bybit.com)</option>
                        <option value="https://api-testnet.bybit.com">Testnet (https://api-testnet.bybit.com)</option>
                    </select>
                    <p style="color: #888; font-size: 0.85em; margin-top: 8px;">Select Production for live trading or Testnet for testing.</p>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn success" onclick="saveBybitApiSettings()">Save API Settings</button>
                    <button class="btn" onclick="loadBybitApiSettings()" style="margin-left: 10px; background: #444;">Load Current Settings</button>
                </div>
                
                <div id="api-settings-status" style="margin-top: 15px; color: #aaa; font-size: 0.9em;"></div>
            </div>
            
            <!-- Admin Password Change Section -->
            <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h2>Admin Password Settings</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Change admin login password.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="current-password" style="display: block; margin-bottom: 8px; color: #aaa;">Current Password:</label>
                    <input type="password" id="current-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter current password">
                    <button type="button" onclick="togglePasswordVisibility('current-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="new-password" style="display: block; margin-bottom: 8px; color: #aaa;">New Password:</label>
                    <input type="password" id="new-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Enter new password (min 6 characters)">
                    <button type="button" onclick="togglePasswordVisibility('new-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="confirm-password" style="display: block; margin-bottom: 8px; color: #aaa;">Confirm New Password:</label>
                    <input type="password" id="confirm-password" style="width: 100%; max-width: 500px; padding: 10px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: monospace;" placeholder="Confirm new password">
                    <button type="button" onclick="togglePasswordVisibility('confirm-password')" style="margin-left: 10px; padding: 8px 12px; background: #444; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; cursor: pointer;">üëÅÔ∏è Show</button>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn success" onclick="changeAdminPassword()">Change Password</button>
                </div>
                
                <div id="password-change-status" style="margin-top: 15px; color: #aaa; font-size: 0.9em;"></div>
            </div>
        </div>
        
        <!-- Signals Tab -->
        <div id="signals" class="tab-content">
            <div class="card">
                <h2>Signal History</h2>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="color: #aaa; margin-right: 5px;">Filter by symbol:</label>
                    <select id="signal-symbol-filter" style="padding: 6px 12px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; cursor: pointer;" onchange="loadSignals()" title="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ—Ä–≥–æ–≤–æ–π –ø–∞—Ä–µ (–¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏). 'All Symbols' –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –≤—Å–µ—Ö –ø–∞—Ä.">
                        <option value="ALL" selected>All Symbols</option>
                        <option value="BTCUSDT">BTCUSDT</option>
                        <option value="ETHUSDT">ETHUSDT</option>
                        <option value="SOLUSDT">SOLUSDT</option>
                    </select>
                    <button onclick="clearSignals()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: auto;">Clear All Signals</button>
                </div>
                <div class="table-wrapper">
                    <div id="signals-table">
                        <div class="loading">Loading signals...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SMC History Tab -->
        <div id="smc_history" class="tab-content">
            <div class="card">
                <h2>Smart Money Concepts History (CSV)</h2>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="loadSMCHistory()" class="btn success">Refresh SMC Data</button>
                    <span id="smc-count" style="color: #aaa;"></span>
                </div>
                <div class="table-wrapper">
                    <div id="smc-history-table">
                        <div class="loading">Loading SMC history from CSV...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏)
        window.activeTVChart = null;
        window.activeTVCandleSeries = null;
        window.activeTVVolumeSeries = null;
        window.activeTVIndicatorSeries = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—Å–µ—Ö –¥–æ–ø. —Å–µ—Ä–∏–π (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)
        window.lastChartSymbol = null;

        window.loadChartLW = async function(forceRefresh = false, explicitSymbol = null) {
            try {
                const container = document.getElementById('chart-container');
                if (!container) return;

                const symbolSelect = document.getElementById('primary-symbol-select');
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª > currentSymbol > select > BTCUSDT
                const symbol = explicitSymbol || window.currentSymbol || (symbolSelect ? symbolSelect.value : 'BTCUSDT');
                console.log(`[Chart] Loading chart for symbol: ${symbol} (explicit: ${explicitSymbol}, currentSymbol: ${window.currentSymbol}, select: ${symbolSelect?.value})`);
                
                // –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                const isSameSymbol = window.lastChartSymbol === symbol;
                
                if (!isSameSymbol || forceRefresh || !window.activeTVChart) {
                    console.log(`[Chart] Creating/Recreating chart for ${symbol}`);
                    if (window.activeTVChart) {
                        try { window.activeTVChart.remove(); } catch(e) {}
                        window.activeTVChart = null;
                    }
                    container.innerHTML = '<div class="loading">Loading chart data...</div>';
                    window.lastChartSymbol = symbol;
                }

                let response;
                try {
                    response = await fetch(`/api/chart/data?symbol=${encodeURIComponent(symbol)}`);
                } catch (fetchError) {
                    console.error(`[Chart] Failed to fetch chart data for ${symbol}:`, fetchError);
                    const container = document.getElementById('chart-container');
                    if (container) {
                        container.innerHTML = `<p style="color: #ff4444; padding: 20px;">Network error: Failed to load chart data for ${symbol}. Please check your connection and try again.</p>`;
                    }
                    return;
                }
                
                if (!response.ok) {
                    const container = document.getElementById('chart-container');
                    if (container) {
                        container.innerHTML = `<p style="color: #ff4444; padding: 20px;">Error loading chart: HTTP ${response.status}</p>`;
                    }
                    return;
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error(`[Chart] Failed to parse JSON for ${symbol}:`, jsonError);
                    const container = document.getElementById('chart-container');
                    if (container) {
                        container.innerHTML = `<p style="color: #ff4444; padding: 20px;">Error parsing chart data for ${symbol}</p>`;
                    }
                    return;
                }
                
                if (data.error || !data.candles || data.candles.length === 0) {
                    container.innerHTML = `<p style="color: #ff4444; padding: 20px;">${data.error || 'No data available for ' + symbol}</p>`;
                    return;
                }

                if (typeof LightweightCharts === 'undefined') {
                    container.innerHTML = `<p style="color: #ff4444; padding: 20px;">Error: Chart library not loaded.</p>`;
                    return;
                }

                const candleData = data.candles.map((c, i) => ({
                    time: Math.floor(data.times[i] / 1000),
                    open: parseFloat(c.open), high: parseFloat(c.high), low: parseFloat(c.low), close: parseFloat(c.close)
                }));

                // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–∏–º–≤–æ–ª —Ç–æ—Ç –∂–µ, –æ–±–Ω–æ–≤–ª—è–µ–º
                if (window.activeTVChart && isSameSymbol && !forceRefresh) {
                    window.activeTVCandleSeries.setData(candleData);
                    
                    if (window.activeTVVolumeSeries) {
                        const volumeData = data.candles.map((c, i) => ({
                            time: Math.floor(data.times[i] / 1000),
                            value: parseFloat(c.volume),
                            color: parseFloat(c.close) >= parseFloat(c.open) ? 'rgba(0, 255, 136, 0.3)' : 'rgba(255, 68, 68, 0.3)',
                        }));
                        window.activeTVVolumeSeries.setData(volumeData);
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ —Ä–∏—Å—É–µ–º –Ω–æ–≤—ã–µ
                    window.activeTVIndicatorSeries.forEach(s => { try { window.activeTVChart.removeSeries(s); } catch(e) {} });
                    window.activeTVIndicatorSeries = [];
                    
                    renderIndicators(window.activeTVChart, data);
                    updateMarkers(data);
                    updatePositionLines(data);
                    return;
                }

                // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                container.innerHTML = '';
                const chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 500,
                    layout: { background: { type: 'solid', color: '#1a1a1a' }, textColor: '#d1d4dc' },
                    grid: { vertLines: { color: '#2b2b2b' }, horzLines: { color: '#2b2b2b' } },
                    timeScale: { timeVisible: true, borderColor: '#2b2b2b' },
                });

                window.activeTVChart = chart;
                window.activeTVCandleSeries = chart.addCandlestickSeries({
                    upColor: '#00ff88', downColor: '#ff4444', borderVisible: false,
                    wickUpColor: '#00ff88', wickDownColor: '#ff4444',
                });
                window.activeTVCandleSeries.setData(candleData);

                if (document.getElementById('show-volume')?.checked) {
                    window.activeTVVolumeSeries = chart.addHistogramSeries({
                        color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '',
                        scaleMargins: { top: 0.85, bottom: 0 },
                    });
                    const volumeData = data.candles.map((c, i) => ({
                        time: Math.floor(data.times[i] / 1000),
                        value: parseFloat(c.volume),
                        color: parseFloat(c.close) >= parseFloat(c.open) ? 'rgba(0, 255, 136, 0.3)' : 'rgba(255, 68, 68, 0.3)',
                    }));
                    window.activeTVVolumeSeries.setData(volumeData);
                }

                renderIndicators(chart, data);
                updateMarkers(data);
                updatePositionLines(data);
                
                chart.timeScale().fitContent();

                // Resize handler
                const handleResize = () => { 
                    const container = document.getElementById('chart-container');
                    if (window.activeTVChart && container) {
                        window.activeTVChart.applyOptions({ width: container.clientWidth });
                    }
                };
                window.addEventListener('resize', handleResize);

            } catch (e) {
                console.error("Chart Error:", e);
                const container = document.getElementById('chart-container');
                if (container) {
                    container.innerHTML = `<div class="card" style="color:#ff4444">Error loading chart: ${e.message}</div>`;
                } else {
                    console.error("Chart container not found, cannot display error");
                }
            }
        };

        function updateMarkers(data) {
            if (!window.activeTVCandleSeries) return;
            const showSignals = document.getElementById('show-signals')?.checked;
            if (showSignals && data.signals && data.signals.length > 0) {
                console.log('[Chart] Processing signals:', data.signals.length);
                const markers = data.signals.map(sig => {
                    const action = (sig.action || '').toLowerCase();
                    const reason = (sig.reason || '').toLowerCase();
                    const price = sig.price ? parseFloat(sig.price).toFixed(2) : '';
                    
                    // –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º reason –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
                    let stratName = '';
                    const reasonLower = reason.toLowerCase();
                    if (reasonLower.startsWith('ml_')) stratName = 'ML';
                    else if (reasonLower.startsWith('smc_')) stratName = 'SMC';
                    else if (reasonLower.startsWith('ict_')) stratName = 'ICT';
                    else if (reasonLower.startsWith('trend_')) stratName = 'TREND';
                    else if (reasonLower.startsWith('range_') || reasonLower.startsWith('flat_')) stratName = 'FLAT';
                    else if (reasonLower.startsWith('momentum_')) stratName = 'MOM';
                    else if (reasonLower.startsWith('liquidity_')) stratName = 'LIQ';
                    else if (reasonLower.startsWith('liquidation_hunter_')) stratName = 'LIQ-H';
                    else if (reasonLower.startsWith('zscore_')) stratName = 'Z-SCORE';
                    else if (reasonLower.startsWith('vbo_')) stratName = 'VBO';
                    else stratName = 'SIG';
                    
                    // –§–æ—Ä–º–∞—Ç: "ML LONG $95000"
                    const label = price ? `${stratName} ${action.toUpperCase()} $${price}` : `${stratName} ${action.toUpperCase()}`;
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è (–ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –º—Å, –Ω—É–∂–Ω–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                    const timeInSeconds = typeof sig.time === 'number' ? Math.floor(sig.time / 1000) : null;
                    
                    if (!timeInSeconds || isNaN(timeInSeconds)) {
                        console.warn('[Chart] Invalid signal time:', sig.time);
                        return null;
                    }
                    
                    return {
                        time: timeInSeconds,
                        position: action === 'long' ? 'belowBar' : 'aboveBar',
                        color: action === 'long' ? '#00ff88' : '#ff4444',
                        shape: action === 'long' ? 'arrowUp' : 'arrowDown',
                        text: label,
                        size: 2  // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
                    };
                }).filter(m => m !== null);
                
                console.log('[Chart] Valid markers:', markers.length);
                if (markers.length > 0) {
                    window.activeTVCandleSeries.setMarkers(markers);
                } else {
                    window.activeTVCandleSeries.setMarkers([]);
                }
            } else {
                window.activeTVCandleSeries.setMarkers([]);
            }
        }

        function renderIndicators(chart, data) {
            const showSMA = document.getElementById('show-sma')?.checked;
            if (showSMA && data.indicators?.sma) {
                const s = chart.addLineSeries({ 
                    color: '#2962FF', 
                    lineWidth: 2, 
                    title: 'SMA20', 
                    priceLineVisible: false,
                    lastValueVisible: false // –£–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å—å –Ω–∞ —à–∫–∞–ª–µ —Ü–µ–Ω
                });
                s.setData(data.indicators.sma.map((v, i) => ({ time: Math.floor(data.times[i]/1000), value: parseFloat(v) })).filter(d => !isNaN(d.value)));
                window.activeTVIndicatorSeries.push(s);
            }
            
            const showBB = document.getElementById('show-bb')?.checked;
            if (showBB && data.indicators?.bb_upper && data.indicators?.bb_lower) {
                const color = 'rgba(173, 216, 230, 0.4)';
                const u = chart.addLineSeries({ 
                    color, 
                    lineWidth: 1, 
                    title: 'BB Upper', 
                    priceLineVisible: false,
                    lastValueVisible: false // –£–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å—å –Ω–∞ —à–∫–∞–ª–µ —Ü–µ–Ω
                });
                u.setData(data.indicators.bb_upper.map((v, i) => ({ time: Math.floor(data.times[i]/1000), value: parseFloat(v) })).filter(d => !isNaN(d.value)));
                window.activeTVIndicatorSeries.push(u);
                
                const l = chart.addLineSeries({ 
                    color, 
                    lineWidth: 1, 
                    title: 'BB Lower', 
                    priceLineVisible: false,
                    lastValueVisible: false // –£–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å—å –Ω–∞ —à–∫–∞–ª–µ —Ü–µ–Ω
                });
                l.setData(data.indicators.bb_lower.map((v, i) => ({ time: Math.floor(data.times[i]/1000), value: parseFloat(v) })).filter(d => !isNaN(d.value)));
                window.activeTVIndicatorSeries.push(l);
            }
        }

        function updatePositionLines(data) {
            if (!window.activeTVCandleSeries) return;
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ª–∏–Ω–∏–∏
            try {
                if (window.activeTVEntryLine) window.activeTVCandleSeries.removePriceLine(window.activeTVEntryLine);
                if (window.activeTVSLLine) window.activeTVCandleSeries.removePriceLine(window.activeTVSLLine);
                if (window.activeTVTPLine) window.activeTVCandleSeries.removePriceLine(window.activeTVTPLine);
            } catch(e) {}

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å –ø–æ–∑–∏—Ü–∏–∏
            updatePositionInfoPanel(data.position);

            if (data.position && parseFloat(data.position.entry_price) > 0) {
                const pos = data.position;
                const sideColor = pos.side === 'long' ? '#00ff88' : '#ff4444';
                
                window.activeTVEntryLine = window.activeTVCandleSeries.createPriceLine({
                    price: parseFloat(pos.entry_price), 
                    color: sideColor, 
                    lineWidth: 2, 
                    lineStyle: 0, 
                    title: `Entry (${pos.side.toUpperCase()}) $${parseFloat(pos.entry_price).toFixed(2)}`
                });
                
                if (parseFloat(pos.stop_loss) > 0) {
                    window.activeTVSLLine = window.activeTVCandleSeries.createPriceLine({
                        price: parseFloat(pos.stop_loss), 
                        color: '#ff4444', 
                        lineWidth: 2, 
                        lineStyle: 2, 
                        title: `SL $${parseFloat(pos.stop_loss).toFixed(2)}`
                    });
                }
                if (parseFloat(pos.take_profit) > 0) {
                    window.activeTVTPLine = window.activeTVCandleSeries.createPriceLine({
                        price: parseFloat(pos.take_profit), 
                        color: '#00ff88', 
                        lineWidth: 2, 
                        lineStyle: 2, 
                        title: `TP $${parseFloat(pos.take_profit).toFixed(2)}`
                    });
                }
            }
        }

        function updatePositionInfoPanel(position) {
            let panel = document.getElementById('position-info-panel');
            if (!panel) {
                // –°–æ–∑–¥–∞—ë–º –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                panel = document.createElement('div');
                panel.id = 'position-info-panel';
                panel.style.cssText = 'position:absolute;top:60px;left:10px;background:rgba(0,0,0,0.85);padding:10px 15px;border-radius:8px;font-size:12px;z-index:100;border:1px solid #333;min-width:180px;';
                const container = document.getElementById('chart-container');
                if (container) {
                    container.style.position = 'relative';
                    container.appendChild(panel);
                }
            }
            
            if (position && parseFloat(position.entry_price) > 0) {
                const side = position.side || 'unknown';
                const sideColor = side === 'long' ? '#00ff88' : '#ff4444';
                const entry = parseFloat(position.entry_price).toFixed(2);
                const size = parseFloat(position.size || 0).toFixed(4);
                const pnl = parseFloat(position.unrealised_pnl || 0).toFixed(2);
                const pnlColor = parseFloat(pnl) >= 0 ? '#00ff88' : '#ff4444';
                const tp = parseFloat(position.take_profit || 0);
                const sl = parseFloat(position.stop_loss || 0);
                
                panel.innerHTML = `
                    <div style="color:#fff;font-weight:bold;margin-bottom:8px;border-bottom:1px solid #444;padding-bottom:5px;">
                        üìä Open Position
                    </div>
                    <div style="display:grid;grid-template-columns:auto auto;gap:4px 12px;">
                        <span style="color:#888;">Side:</span>
                        <span style="color:${sideColor};font-weight:bold;">${side.toUpperCase()}</span>
                        <span style="color:#888;">Entry:</span>
                        <span style="color:#fff;">$${entry}</span>
                        <span style="color:#888;">Size:</span>
                        <span style="color:#fff;">${size}</span>
                        <span style="color:#888;">PnL:</span>
                        <span style="color:${pnlColor};font-weight:bold;">$${pnl}</span>
                        <span style="color:#888;">TP:</span>
                        <span style="color:${tp > 0 ? '#00ff88' : '#666'};">${tp > 0 ? '$' + tp.toFixed(2) : 'Not set'}</span>
                        <span style="color:#888;">SL:</span>
                        <span style="color:${sl > 0 ? '#ff4444' : '#666'};">${sl > 0 ? '$' + sl.toFixed(2) : 'Not set'}</span>
                    </div>
                `;
                panel.style.display = 'block';
            } else {
                panel.innerHTML = `
                    <div style="color:#888;font-size:11px;">
                        No open position
                    </div>
                `;
                panel.style.display = 'block';
            }
        }

        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –°–†–ê–ó–£ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è onclick –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        try {
            window.showTab = window.showTab || function(tabName, event) {
                console.warn('showTab: function not fully loaded yet');
            };
            window.startBot = window.startBot || async function() {
                console.warn('startBot: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            window.stopBot = window.stopBot || async function() {
                console.warn('stopBot: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            window.closePosition = window.closePosition || async function() {
                console.warn('closePosition: function not fully loaded yet');
                alert('Bot functions are still loading. Please wait a moment and try again.');
            };
            console.log('‚úÖ Global functions initialized:', {
                showTab: typeof window.showTab,
                startBot: typeof window.startBot,
                stopBot: typeof window.stopBot,
                closePosition: typeof window.closePosition
            });
        } catch (e) {
            console.error('‚ùå Error initializing global functions:', e);
        }
        
        let updateInterval;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞
        function detectDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            const isSmallScreen = window.innerWidth <= 768;
            return isMobile || isSmallScreen;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        function toggleMobileMode() {
            const body = document.body;
            const isMobile = body.classList.contains('mobile-mode');
            const modeToggle = document.getElementById('modeToggle');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            if (isMobile) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø
                body.classList.remove('mobile-mode');
                modeIcon.textContent = 'üì±';
                modeText.textContent = 'Mobile';
                modeToggle.classList.remove('mobile-active');
                localStorage.setItem('adminPanelMode', 'desktop');
            } else {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–π
                body.classList.add('mobile-mode');
                modeIcon.textContent = 'üíª';
                modeText.textContent = 'Desktop';
                modeToggle.classList.add('mobile-active');
                localStorage.setItem('adminPanelMode', 'mobile');
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
            if (window.activeTVChart) {
                setTimeout(() => {
                    const chartContainer = document.getElementById('chart-container');
                    if (chartContainer) {
                        window.activeTVChart.applyOptions({ width: chartContainer.clientWidth });
                    }
                }, 100);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initMobileMode() {
            const savedMode = localStorage.getItem('adminPanelMode');
            const isMobileDevice = detectDevice();
            const body = document.body;
            const modeToggle = document.getElementById('modeToggle');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            if (!savedMode) {
                if (isMobileDevice) {
                    body.classList.add('mobile-mode');
                    modeIcon.textContent = 'üíª';
                    modeText.textContent = 'Desktop';
                    modeToggle.classList.add('mobile-active');
                    localStorage.setItem('adminPanelMode', 'mobile');
                } else {
                    body.classList.remove('mobile-mode');
                    modeIcon.textContent = 'üì±';
                    modeText.textContent = 'Mobile';
                    modeToggle.classList.remove('mobile-active');
                    localStorage.setItem('adminPanelMode', 'desktop');
                }
            } else {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
                if (savedMode === 'mobile') {
                    body.classList.add('mobile-mode');
                    modeIcon.textContent = 'üíª';
                    modeText.textContent = 'Desktop';
                    modeToggle.classList.add('mobile-active');
                } else {
                    body.classList.remove('mobile-mode');
                    modeIcon.textContent = 'üì±';
                    modeText.textContent = 'Mobile';
                    modeToggle.classList.remove('mobile-active');
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (window.activeTVChart) {
                        const chartContainer = document.getElementById('chart-container');
                        if (chartContainer) {
                            window.activeTVChart.applyOptions({ width: chartContainer.clientWidth });
                        }
                    }
                }, 250);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            initMobileMode();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (typeof loadWalletData === 'function') {
                loadWalletData();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (typeof loadCombinedPnlStats === 'function') {
                loadCombinedPnlStats();
            }
        });

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é showTab –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.showTab = function(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑–≤–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏—é
            if (event && event.target) {
            event.target.classList.add('active');
            } else {
                // –ï—Å–ª–∏ event –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –Ω–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ tabName
                const buttons = document.querySelectorAll('.tab');
                buttons.forEach(btn => {
                    if (btn.textContent.trim() === tabName || btn.getAttribute('onclick')?.includes(`'${tabName}'`) || btn.getAttribute('onclick')?.includes(`"${tabName}"`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ Symbols
            if (tabName === 'symbols') {
                if (typeof loadSymbolSettings !== 'undefined') {
                    loadSymbolSettings();
                }
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                if (typeof loadSymbolsStatus !== 'undefined') {
                    loadSymbolsStatus();
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
            if (tabName === 'trades') {
                if (typeof loadTrades !== 'undefined') {
                    loadTrades();
                }
            } else if (tabName === 'signals') {
                if (typeof loadSignals !== 'undefined') {
                    loadSignals();
                }
            } else if (tabName === 'dashboard') {
                // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                if (typeof loadSymbolsStatus !== 'undefined') {
                    loadSymbolsStatus();
                }
            }
            
            if (tabName === 'strategy' || tabName === 'risk') {
                loadSettings();
            } else if (tabName === 'strategies') {
                loadStrategySelection();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞—Ä—ã
                const strategySymbolSelect = document.getElementById('strategy-symbol-select');
                if (strategySymbolSelect) {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ primary_symbol
                    const symbolSelect = document.getElementById('symbol-select');
                    if (symbolSelect && symbolSelect.value) {
                        strategySymbolSelect.value = symbolSelect.value;
                    }
                    loadStrategySettingsForSymbol();
                }
                loadStrategyStats();
                loadMLModelInfo();
                if (typeof loadAllPairsModelsInfo !== 'undefined') {
                    loadAllPairsModelsInfo();
                }
            } else if (tabName === 'trades') {
                loadTrades();
            } else if (tabName === 'signals') {
                loadSignals();
            } else if (tabName === 'settings') {
                loadBybitApiSettings();
            }
        }
        
        async function updateStatus() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`/api/status?symbol=${encodeURIComponent(selectedSymbol)}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
                if (data.pnl_stats) {
                    window.currentPnlStats = data.pnl_stats;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
                if (!data || data.error) {
                    console.error('API returned error:', data?.error || 'Unknown error');
                    const statusElement = document.getElementById('current-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<span style="color: #ff4444;">API Error</span>';
                    }
                    return;
                }
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ)
                // –î–ª—è multi-symbol —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é primarySymbolSelect
                const activeSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : (data.account?.primary_symbol || data.account?.symbol || 'BTCUSDT'));
                
                let botStatus = data.bot_status || {};
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                    const symbolStatus = data.symbols_status[activeSymbol];
                    botStatus = {
                        is_running: symbolStatus.is_running || botStatus.is_running || false,
                        current_status: symbolStatus.status || symbolStatus.current_status || botStatus.current_status || 'Stopped',
                        current_phase: symbolStatus.current_phase || botStatus.current_phase || '-',  // –§–∞–∑–∞ —Ä—ã–Ω–∫–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                        current_adx: symbolStatus.current_adx !== undefined && symbolStatus.current_adx !== null ? symbolStatus.current_adx : (botStatus.current_adx || '-'),  // ADX –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                        last_action: symbolStatus.last_action || botStatus.last_action || '-',
                        last_action_time: symbolStatus.last_action_time || botStatus.last_action_time,
                        last_signal: symbolStatus.last_signal || botStatus.last_signal || '-',
                        last_signal_time: symbolStatus.last_signal_time || botStatus.last_signal_time,
                        last_error: symbolStatus.last_error || botStatus.last_error,
                        last_error_time: symbolStatus.last_error_time || botStatus.last_error_time,
                        last_update: botStatus.last_update || new Date().toISOString()
                    };
                }
                
                const botStatusEl = document.getElementById('bot-status');
                if (botStatusEl) {
                    botStatusEl.innerHTML = 
                        `<span class="status-indicator ${botStatus.is_running ? 'running' : 'stopped'}"></span>${botStatus.is_running ? 'Running' : 'Stopped'}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                const statusText = botStatus.current_status || 'Unknown';
                const statusColor = statusText === 'Running' ? '#00ff88' : 
                                   statusText === 'Analyzing' ? '#00d4ff' : 
                                   statusText === 'Fetching Data' ? '#00aaff' :
                                   statusText === 'Signal Found' ? '#ffaa00' : 
                                   statusText === 'Order Placed' ? '#00ff88' : 
                                   statusText === 'Error' ? '#ff4444' : '#aaa';
                const currentStatusEl = document.getElementById('current-status');
                if (currentStatusEl) {
                    currentStatusEl.innerHTML = `<span style="color: ${statusColor};">${statusText}</span>`;
                }
                
                // –§–∞–∑–∞ —Ä—ã–Ω–∫–∞ (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ bot_status)
                const phase = botStatus.current_phase;
                let phaseValue = '-';
                if (phase && phase !== '-' && phase !== null && phase !== undefined) {
                    phaseValue = String(phase).toLowerCase();
                }
                const phaseColor = phaseValue === 'trend' ? '#00ff88' : phaseValue === 'flat' ? '#ffaa00' : '#aaa';
                const marketPhaseEl = document.getElementById('market-phase');
                if (marketPhaseEl) {
                    marketPhaseEl.innerHTML = phaseValue !== '-' ? `<span style="color: ${phaseColor};">${phaseValue.toUpperCase()}</span>` : '-';
                }
                
                // ADX (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ bot_status)
                const adxEl = document.getElementById('current-adx');
                if (adxEl) {
                    const adxValue = botStatus.current_adx;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ adxValue - —ç—Ç–æ —á–∏—Å–ª–æ (–Ω–µ null, –Ω–µ undefined, –Ω–µ NaN, –Ω–µ —Å—Ç—Ä–æ–∫–∞ '-')
                    if (adxValue !== null && adxValue !== undefined && adxValue !== '-' && !isNaN(adxValue) && adxValue !== '') {
                        const adxNum = parseFloat(adxValue);
                        if (!isNaN(adxNum)) {
                            adxEl.textContent = adxNum.toFixed(2);
                        } else {
                            adxEl.textContent = '-';
                        }
                    } else {
                        adxEl.textContent = '-';
                    }
                }
                
                // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
                const lastActionEl = document.getElementById('last-action');
                if (lastActionEl) {
                    lastActionEl.textContent = botStatus.last_action || '-';
                }
                
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
                const lastSignal = botStatus.last_signal || '-';
                const lastSignalTime = botStatus.last_signal_time ? 
                    convertToMSK(botStatus.last_signal_time) : '';
                const lastSignalEl = document.getElementById('last-signal');
                if (lastSignalEl) {
                    lastSignalEl.textContent = 
                        lastSignal !== '-' ? `${lastSignal}${lastSignalTime ? ' (' + lastSignalTime + ')' : ''}` : '-';
                }
                
                const lastUpdateEl = document.getElementById('last-update');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = botStatus.last_update ? convertToMSK(botStatus.last_update) : '-';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º activeSymbol –∏–∑ –∫–æ–¥–∞ –≤—ã—à–µ)
                const account = data.account || {};
                const symbolEl = document.getElementById('symbol');
                if (symbolEl) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (—É–∂–µ –ø–æ–ª—É—á–µ–Ω –≤—ã—à–µ)
                    symbolEl.textContent = activeSymbol;
                }
                const leverageEl = document.getElementById('leverage');
                if (leverageEl) {
                    leverageEl.textContent = account.leverage ? `${account.leverage}x` : '-';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏)
                // –ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ symbols_status –≤—ã—à–µ
                if (typeof loadWalletData === 'function') {
                    try {
                        loadWalletData();
                    } catch (e) {
                        console.warn('Error in loadWalletData:', e);
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏–∑ symbols_status
                let positionData = null;
                // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    const symbolStatus = data.symbols_status[activeSymbol];
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ position —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π, –∏ —á—Ç–æ size > 0
                    if (symbolStatus.position && symbolStatus.position.side && (symbolStatus.position.size > 0 || symbolStatus.position.size)) {
                        positionData = {
                            side: symbolStatus.position.side || null,
                            size: symbolStatus.position.size || 0,
                            avg_price: symbolStatus.position.avg_price || 0,
                            mark_price: symbolStatus.position.mark_price || symbolStatus.position.avg_price || 0,
                            unrealised_pnl: symbolStatus.position.unrealised_pnl || 0,
                            take_profit: symbolStatus.position.take_profit || symbolStatus.position.takeProfit || '',
                            stop_loss: symbolStatus.position.stop_loss || symbolStatus.position.stopLoss || '',
                            leverage: symbolStatus.position.leverage || account.leverage || 1,
                            entry_reason: symbolStatus.position.entry_reason || '',
                            strategy_type: symbolStatus.position.strategy_type || '',
                            trade_id: symbolStatus.position.trade_id || ''
                        };
                    }
                }
                // –ù–µ—Ç fallback –Ω–∞ data.position - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                if (positionData && positionData.side) {
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á–∏—Å–ª–æ
                    const side = positionData.side || 'None';
                    const size = parseFloat(positionData.size) || 0;
                    const avgPrice = parseFloat(positionData.avg_price) || 0;
                    const markPrice = parseFloat(positionData.mark_price) || 0;
                    const pnl = parseFloat(positionData.unrealised_pnl) || 0;
                    const currentPrice = markPrice || avgPrice || 0;
                    const leverage = parseFloat(account?.leverage || positionData?.leverage || 1) || 1;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL%
                    const isLong = side.toLowerCase() === 'long' || side === 'Buy';
                    
                    const positionSideEl = document.getElementById('position-side');
                    if (positionSideEl) {
                        const sideText = isLong ? 'long' : (side.toLowerCase() === 'short' || side === 'Sell' ? 'short' : side);
                        positionSideEl.textContent = sideText;
                        // –¶–≤–µ—Ç–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ: long - –∑–µ–ª–µ–Ω—ã–º, short - –∫—Ä–∞—Å–Ω—ã–º
                        positionSideEl.style.color = isLong ? '#00ff88' : '#ff4444';
                        positionSideEl.style.fontWeight = 'bold';
                    }
                    
                    const positionSizeEl = document.getElementById('position-size');
                    if (positionSizeEl) {
                        positionSizeEl.textContent = size > 0 ? size.toFixed(3) : '-';
                    }
                    
                    const positionEntryEl = document.getElementById('position-entry');
                    if (positionEntryEl) {
                        positionEntryEl.textContent = avgPrice > 0 ? `$${avgPrice.toFixed(2)}` : '-';
                    }
                    
                    const positionCurrentPriceEl = document.getElementById('position-current-price');
                    if (positionCurrentPriceEl) {
                        positionCurrentPriceEl.textContent = currentPrice > 0 ? `$${currentPrice.toFixed(2)}` : '-';
                    }
                    
                    const positionPnlEl = document.getElementById('position-pnl');
                    if (positionPnlEl) {
                        positionPnlEl.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} USDT`;
                        positionPnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // PnL % –æ—Ç –º–∞—Ä–∂–∏ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞
                    let pnlPct = 0;
                    if (size > 0 && avgPrice > 0 && leverage > 0) {
                        // –ú–∞—Ä–∂–∞ = (Size * Entry Price) / Leverage
                        const margin = (size * avgPrice) / leverage;
                        if (margin > 0) {
                            // PnL% –æ—Ç –º–∞—Ä–∂–∏ = (Unrealised PnL / Margin) * 100
                            pnlPct = (pnl / margin) * 100;
                        }
                    }
                    
                    const positionPnlPctEl = document.getElementById('position-pnl-pct');
                    if (positionPnlPctEl) {
                        positionPnlPctEl.textContent = `${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%`;
                        positionPnlPctEl.className = `stat-value ${pnlPct >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // TP/SL (–∏–∑ positionData –∏–ª–∏ –∏–∑ data.position –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                    const tp = positionData.take_profit || positionData.takeProfit || (data.position?.take_profit || data.position?.takeProfit || '');
                    const sl = positionData.stop_loss || positionData.stopLoss || (data.position?.stop_loss || data.position?.stopLoss || '');
                    const tpValue = tp ? parseFloat(tp) : null;
                    const slValue = sl ? parseFloat(sl) : null;
                    
                    const positionTpEl = document.getElementById('position-tp');
                    if (positionTpEl) {
                        positionTpEl.textContent = tpValue ? `$${tpValue.toFixed(2)}` : 'Not set';
                        positionTpEl.style.color = tpValue ? '#00ff88' : '#ffaa00';
                    }
                    
                    const positionSlEl = document.getElementById('position-sl');
                    if (positionSlEl) {
                        positionSlEl.textContent = slValue ? `$${slValue.toFixed(2)}` : 'Not set';
                        positionSlEl.style.color = slValue ? '#ff4444' : '#ffaa00';
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Å–∏–≥–Ω–∞–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
                    const entryReason = positionData.entry_reason || (data.position?.entry_reason) || '';
                    const strategyType = positionData.strategy_type || (data.position?.strategy_type) || '';
                    const tradeId = positionData.trade_id || (data.position?.trade_id) || '';
                    
                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('[Position Panel] Data:', {
                        entry_reason: entryReason,
                        strategy_type: strategyType,
                        trade_id: tradeId,
                        positionData: positionData,
                        data_position: data.position
                    });
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    let strategyDisplay = 'Unknown';
                    if (strategyType) {
                        const strategyMap = {
                            'ml': 'ü§ñ ML Strategy',
                            'trend': 'üìà Trend Strategy',
                            'flat': 'üìä Flat Strategy',
                            'momentum': '‚ö° Momentum Strategy',
                            'smc': 'üü£ Smart Money Concepts',
                            'ict': 'üî¥ ICT Silver Bullet',
                            'liquidation_hunter': 'üü† Liquidation Hunter',
                            'zscore': 'üü¢ Z-Score',
                            'vbo': 'üü£ VBO (Volatility Breakout)',
                            'amt_of': '‚ö´ AMT & Order Flow Scalper',
                            'hybrid': 'üîÑ Hybrid',
                            'unknown': 'Unknown'
                        };
                        strategyDisplay = strategyMap[strategyType.toLowerCase()] || strategyType.toUpperCase();
                    }
                    
                    const positionStrategyEl = document.getElementById('position-strategy');
                    const positionStrategyContainer = document.getElementById('position-strategy-container');
                    if (positionStrategyEl && positionStrategyContainer) {
                        if (strategyType) {
                            positionStrategyEl.textContent = strategyDisplay;
                            positionStrategyEl.style.color = '#00d4ff';
                            positionStrategyContainer.style.display = 'flex';
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "Unknown" –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞
                            positionStrategyEl.textContent = 'Unknown';
                            positionStrategyEl.style.color = '#888';
                            positionStrategyContainer.style.display = 'flex';
                        }
                    }
                    
                    const positionEntrySignalEl = document.getElementById('position-entry-signal');
                    const positionEntrySignalContainer = document.getElementById('position-entry-signal-container');
                    if (positionEntrySignalEl && positionEntrySignalContainer) {
                        if (entryReason) {
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º reason –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                            let formattedReason = entryReason;
                            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
                            formattedReason = formattedReason.replace(/^(ml_|trend_|range_|momentum_|liquidity_|smc_|ict_|liquidation_hunter_|zscore_|vbo_|amt_of_)/, '');
                            // –ó–∞–º–µ–Ω—è–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
                            formattedReason = formattedReason.replace(/_/g, ' ');
                            // –£–ª—É—á—à–∞–µ–º —á–∏—Ç–∞–µ–º–æ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                            formattedReason = formattedReason.replace(/spike (\d+\.\d+)x/g, 'Spike $1x');
                            formattedReason = formattedReason.replace(/long|short/gi, function(match) {
                                return match.charAt(0).toUpperCase() + match.slice(1);
                            });
                            formattedReason = formattedReason.replace(/fvg|reteest|sl|tp/gi, function(match) {
                                const map = { 'fvg': 'FVG', 'reteest': 'Retest', 'sl': 'SL', 'tp': 'TP' };
                                return map[match.toLowerCase()] || match;
                            });
                            // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π
                            formattedReason = formattedReason.charAt(0).toUpperCase() + formattedReason.slice(1);
                            
                            positionEntrySignalEl.textContent = formattedReason;
                            positionEntrySignalEl.style.color = '#aaa';
                            positionEntrySignalContainer.style.display = 'flex';
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "N/A" –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞
                            positionEntrySignalEl.textContent = 'N/A';
                            positionEntrySignalEl.style.color = '#666';
                            positionEntrySignalContainer.style.display = 'flex';
                        }
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ID —Å–¥–µ–ª–∫–∏
                    const positionTradeIdEl = document.getElementById('position-trade-id');
                    const positionTradeIdContainer = document.getElementById('position-trade-id-container');
                    if (positionTradeIdEl && positionTradeIdContainer) {
                        if (tradeId) {
                            positionTradeIdEl.textContent = tradeId;
                            positionTradeIdEl.style.color = '#888';
                            positionTradeIdContainer.style.display = 'flex';
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "N/A" –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞
                            positionTradeIdEl.textContent = 'N/A';
                            positionTradeIdEl.style.color = '#666';
                            positionTradeIdContainer.style.display = 'flex';
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
                    const closeButtonContainer = document.getElementById('position-close-button-container');
                    if (closeButtonContainer) {
                        closeButtonContainer.style.display = 'block';
                    }
                } else {
                    // –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ - –æ—á–∏—â–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const positionElements = ['position-side', 'position-size', 'position-entry', 'position-current-price', 'position-pnl', 'position-pnl-pct', 'position-tp', 'position-sl', 'position-strategy', 'position-entry-signal', 'position-trade-id'];
                    positionElements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            if (id === 'position-pnl' || id === 'position-pnl-pct') {
                                el.textContent = '-';
                                el.className = 'stat-value';
                            } else if (id === 'position-tp' || id === 'position-sl') {
                                el.textContent = '-';
                                el.style.color = '#aaa';
                            } else if (id === 'position-side') {
                                el.textContent = 'None';
                                el.style.color = '#aaa';
                                el.style.fontWeight = 'normal';
                            } else {
                                el.textContent = '-';
                            }
                        }
                    });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    const closeButtonContainer = document.getElementById('position-close-button-container');
                    if (closeButtonContainer) {
                        closeButtonContainer.style.display = 'none';
                    }
                    const positionStrategyContainer = document.getElementById('position-strategy-container');
                    if (positionStrategyContainer) {
                        positionStrategyContainer.style.display = 'none';
                    }
                    const positionEntrySignalContainer = document.getElementById('position-entry-signal-container');
                    if (positionEntrySignalContainer) {
                        positionEntrySignalContainer.style.display = 'none';
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ä–¥–µ—Ä–∞—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                let ordersCount = 0;
                if (data.symbols_status && data.symbols_status[activeSymbol]) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ symbols_status –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                    ordersCount = data.symbols_status[activeSymbol].open_orders || 0;
                } else if (activeSymbol === (data.account?.primary_symbol || data.account?.symbol)) {
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º data.open_orders —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å primary_symbol
                    ordersCount = typeof data.open_orders === 'number' ? data.open_orders : (data.open_orders?.count || 0);
                }
                
                const openOrdersEl = document.getElementById('open-orders');
                if (openOrdersEl) {
                    openOrdersEl.textContent = ordersCount;
                }
                const ordersMargin = data.open_orders?.margin_used || 0;
                const ordersMarginEl = document.getElementById('orders-margin');
                if (ordersMarginEl) {
                    ordersMarginEl.textContent = ordersMargin > 0 ? `${ordersMargin.toFixed(2)} USDT` : '-';
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º TP –æ—Ä–¥–µ—Ä–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞)
                const tpOrdersList = document.getElementById('tp-orders-list');
                if (tpOrdersList) {
                    const ordersData = data.open_orders || {};
                    if (ordersData.tp_orders && Array.isArray(ordersData.tp_orders) && ordersData.tp_orders.length > 0) {
                        let tpHtml = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;"><div style="color: #00ff88; font-weight: bold; margin-bottom: 8px; font-size: 0.95em;">Take Profit Orders:</div>';
                        ordersData.tp_orders.forEach((tp, idx) => {
                            const triggerPrice = parseFloat(tp.trigger_price || tp.price || 0);
                            const qty = parseFloat(tp.qty || 0);
                            const side = tp.side || 'N/A';
                            const margin = parseFloat(tp.margin || 0);
                            
                            tpHtml += `<div style="margin-left: 10px; margin-bottom: 6px; padding: 8px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #00ff88; font-size: 0.9em;">`;
                            tpHtml += `<div style="margin-bottom: 4px;"><span style="color: #aaa;">TP ${idx + 1}:</span> <span style="color: #00ff88; font-weight: bold;">$${triggerPrice.toFixed(2)}</span></div>`;
                            tpHtml += `<div style="font-size: 0.85em; color: #888;">`;
                            tpHtml += `Side: <span style="color: ${side.toUpperCase() === 'BUY' ? '#00ff88' : '#ff4444'}">${side}</span> | `;
                            tpHtml += `Qty: ${qty.toFixed(3)} | `;
                            tpHtml += `Margin: <span style="color: #ffaa00;">${margin.toFixed(2)} USDT</span>`;
                            tpHtml += `</div></div>`;
                        });
                        tpHtml += '</div>';
                        tpOrdersList.innerHTML = tpHtml;
                    } else {
                        tpOrdersList.innerHTML = '';
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º SL –æ—Ä–¥–µ—Ä–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç–∞)
                const slOrdersList = document.getElementById('sl-orders-list');
                if (slOrdersList) {
                    const ordersData = data.open_orders || {};
                    if (ordersData.sl_orders && Array.isArray(ordersData.sl_orders) && ordersData.sl_orders.length > 0) {
                        let slHtml = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;"><div style="color: #ff4444; font-weight: bold; margin-bottom: 8px; font-size: 0.95em;">Stop Loss Orders:</div>';
                        ordersData.sl_orders.forEach((sl, idx) => {
                            const triggerPrice = parseFloat(sl.trigger_price || sl.price || 0);
                            const qty = parseFloat(sl.qty || 0);
                            const side = sl.side || 'N/A';
                            const margin = parseFloat(sl.margin || 0);
                            
                            slHtml += `<div style="margin-left: 10px; margin-bottom: 6px; padding: 8px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #ff4444; font-size: 0.9em;">`;
                            slHtml += `<div style="margin-bottom: 4px;"><span style="color: #aaa;">SL ${idx + 1}:</span> <span style="color: #ff4444; font-weight: bold;">$${triggerPrice.toFixed(2)}</span></div>`;
                            slHtml += `<div style="font-size: 0.85em; color: #888;">`;
                            slHtml += `Side: <span style="color: ${side.toUpperCase() === 'BUY' ? '#00ff88' : '#ff4444'}">${side}</span> | `;
                            slHtml += `Qty: ${qty.toFixed(3)} | `;
                            slHtml += `Margin: <span style="color: #ffaa00;">${margin.toFixed(2)} USDT</span>`;
                            slHtml += `</div></div>`;
                        });
                        slHtml += '</div>';
                        slOrdersList.innerHTML = slHtml;
                    } else {
                        slOrdersList.innerHTML = '';
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                if (typeof loadSymbolsStatus === 'function') {
                    try {
                        loadSymbolsStatus();
                    } catch (e) {
                        console.warn('Error in loadSymbolsStatus:', e);
                    }
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.warn('Error updating status: Server unavailable or network error');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "Error" –≤ UI
                    const statusElement = document.getElementById('current-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<span style="color: #ff4444;">Connection Error</span>';
                    }
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error updating status: Invalid JSON response', error);
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error updating status:', error);
                }
                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            }
        }
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const strategyForm = generateStrategyForm(data.strategy);
                document.getElementById('strategy-form').innerHTML = strategyForm;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–∏—Å–∫–∞
                const riskForm = generateRiskForm(data.risk, data.app);
                document.getElementById('risk-form').innerHTML = riskForm;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function generateStrategyForm(strategy) {
            return `
                <form onsubmit="saveSettings(event, 'strategy')">
                    <div class="form-group">
                        <label>ADX Threshold:</label>
                        <input type="number" name="adx_threshold" value="${strategy.adx_threshold}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ADX Length:</label>
                        <input type="number" name="adx_length" value="${strategy.adx_length}">
                    </div>
                    <div class="form-group">
                        <label>DI Length:</label>
                        <input type="number" name="di_length" value="${strategy.di_length}">
                    </div>
                    <div class="form-group">
                        <label>Breakout Lookback:</label>
                        <input type="number" name="breakout_lookback" value="${strategy.breakout_lookback}">
                    </div>
                    <div class="form-group">
                        <label>Breakout Volume Multiplier:</label>
                        <input type="number" name="breakout_volume_mult" value="${strategy.breakout_volume_mult}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>SMA Length:</label>
                        <input type="number" name="sma_length" value="${strategy.sma_length}">
                    </div>
                    <div class="form-group">
                        <label>Pullback Tolerance:</label>
                        <input type="number" name="pullback_tolerance" value="${strategy.pullback_tolerance}" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label>RSI Length:</label>
                        <input type="number" name="rsi_length" value="${strategy.rsi_length}">
                    </div>
                    <div class="form-group">
                        <label>RSI Floor:</label>
                        <input type="number" name="rsi_floor" value="${strategy.rsi_floor}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>RSI Ceiling:</label>
                        <input type="number" name="rsi_ceiling" value="${strategy.rsi_ceiling}" step="0.1">
                    </div>
                    <h3 style="margin-top: 20px; color: #00d4ff;">Range Strategy</h3>
                    <div class="form-group">
                        <label>BB Length:</label>
                        <input type="number" name="bb_length" value="${strategy.bb_length}">
                    </div>
                    <div class="form-group">
                        <label>BB Std:</label>
                        <input type="number" name="bb_std" value="${strategy.bb_std}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range RSI Oversold:</label>
                        <input type="number" name="range_rsi_oversold" value="${strategy.range_rsi_oversold}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range RSI Overbought:</label>
                        <input type="number" name="range_rsi_overbought" value="${strategy.range_rsi_overbought}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Range Volume Multiplier:</label>
                        <input type="number" name="range_volume_mult" value="${strategy.range_volume_mult}" step="0.1">
                    </div>
                    <div class="form-group" style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 5px; border-left: 3px solid #ffaa00;">
                        <label style="color: #ffaa00;">üìä FLAT (Range) Strategy Settings:</label>
                        <small style="color: #aaa; display: block; margin-bottom: 10px;">
                            –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è FLAT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Ç–æ—Ä–≥–æ–≤–ª—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ).<br>
                            –ï—Å–ª–∏ FLAT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞, —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.
                        </small>
                        
                        <div style="margin-top: 10px;">
                        <label>Range TP Aggressive:</label>
                        <input type="checkbox" name="range_tp_aggressive" ${strategy.range_tp_aggressive ? 'checked' : ''}>
                            <small style="color: #aaa; display: block; margin-top: 5px;">
                                –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ: –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π –≥—Ä–∞–Ω–∏—Ü—ã Bollinger Bands (–≤–µ—Ä—Ö–Ω–µ–π –¥–ª—è LONG, –Ω–∏–∂–Ω–µ–π –¥–ª—è SHORT)
                            </small>
                    </div>
                        
                        <div style="margin-top: 15px;">
                        <label>Range Stop Loss %:</label>
                            <input type="number" name="range_stop_loss_pct" value="${(strategy.range_stop_loss_pct * 100).toFixed(2)}" step="0.1" min="0.1" max="50">
                            <small style="color: #aaa; display: block; margin-top: 5px;">
                                –°—Ç–æ–ø-–ª–æ—Å—Å –¥–ª—è FLAT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5 –¥–ª—è 1.5%).<br>
                                <strong style="color: #ff4444;">‚ö†Ô∏è –í–ê–ñ–ù–û:</strong> –≠—Ç–æ –ù–ï –æ—Å–Ω–æ–≤–Ω–æ–π SL –∏–∑ Risk Management! –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π SL —Ç–æ–ª—å–∫–æ –¥–ª—è FLAT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
                            </small>
                        </div>
                    </div>
                    <button type="submit" class="btn">Save Strategy Settings</button>
                </form>
            `;
        }
        
        function generateRiskForm(risk, app) {
            return `
                <form onsubmit="saveSettings(event, 'risk')">
                    <div class="form-group">
                        <label>Max Position USD:</label>
                        <input type="number" name="max_position_usd" value="${risk.max_position_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Base Order USD:</label>
                        <input type="number" name="base_order_usd" value="${risk.base_order_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Add Order USD:</label>
                        <input type="number" name="add_order_usd" value="${risk.add_order_usd}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Stop Loss % (–ú–∞–∫—Å–∏–º—É–º –æ—Ç –º–∞—Ä–∂–∏):</label>
                        <input type="number" name="stop_loss_pct" value="${(risk.stop_loss_pct * 100).toFixed(2)}" step="0.1" min="0.1" max="50">
                        <small style="color: #aaa; display: block; margin-top: 5px;">
                            <strong>–ì—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è SL (–æ—Ç –º–∞—Ä–∂–∏ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞):</strong> –ë–æ—Ç —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç SL –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è.<br>
                            –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π SL –æ—Ç –º–∞—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15% –æ—Ç –º–∞—Ä–∂–∏).<br>
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong> Entry=$3128.84, Leverage=10x, SL=15% –æ—Ç –º–∞—Ä–∂–∏ ‚Üí SL —Ü–µ–Ω–∞ = $3128.84 * (1 - 0.15/10) = $3128.84 * 0.985 = $3081.91<br>
                            –ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π SL –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç—Ç–æ–π –≥—Ä–∞–Ω–∏—Ü—ã —Å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Ä–∏—Å–∫–∞ 2-3:1.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Take Profit % (–ú–∞–∫—Å–∏–º—É–º –æ—Ç –º–∞—Ä–∂–∏):</label>
                        <input type="number" name="take_profit_pct" value="${(risk.take_profit_pct * 100).toFixed(2)}" step="0.1" min="0.5" max="100">
                        <small style="color: #aaa; display: block; margin-top: 5px;">
                            <strong>–ì—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è TP (–æ—Ç –º–∞—Ä–∂–∏ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞):</strong> –ë–æ—Ç —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç TP –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω–µ–π —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è/–ø–æ–¥–¥–µ—Ä–∂–∫–∏.<br>
                            –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π TP –æ—Ç –º–∞—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30% –æ—Ç –º–∞—Ä–∂–∏).<br>
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong> Entry=$3128.84, Leverage=10x, TP=30% –æ—Ç –º–∞—Ä–∂–∏ ‚Üí TP —Ü–µ–Ω–∞ = $3128.84 * (1 + 0.30/10) = $3128.84 * 1.03 = $3222.71<br>
                            –ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π TP –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç—Ç–æ–π –≥—Ä–∞–Ω–∏—Ü—ã —Å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Ä–∏—Å–∫–∞ 2-3:1.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Balance % Per Trade:</label>
                        <input type="number" name="balance_percent_per_trade" value="${risk.balance_percent_per_trade}" step="0.1">
                    </div>
                    <h3 style="margin-top: 20px; color: #00d4ff;">Trailing Stop Settings</h3>
                    <div class="form-group">
                        <label>Enable Trailing Stop:</label>
                        <input type="checkbox" name="enable_trailing_stop" ${risk.enable_trailing_stop ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <small style="color: #aaa; display: block; margin-top: 5px;">
                            –í–∫–ª—é—á–∏—Ç—å trailing stop. SL –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –≤—Å–ª–µ–¥ –∑–∞ —Ü–µ–Ω–æ–π, –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ –ø—Ä–æ–π–¥–µ—Ç –ø–æ–ª–æ–≤–∏–Ω—É –¥–æ TP.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Trailing Stop Activation % (–º–∏–Ω–∏–º—É–º –æ—Ç –º–∞—Ä–∂–∏):</label>
                        <input type="number" name="trailing_stop_activation_pct" value="${(risk.trailing_stop_activation_pct * 100).toFixed(3)}" step="0.001" min="0.1" max="10">
                        <small style="color: #aaa; display: block; margin-top: 5px;">
                            <strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ trailing stop (–æ—Ç –º–∞—Ä–∂–∏):</strong><br>
                            Trailing stop –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø—Ä–∏–±—ã–ª—å >= max(—ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–æ TP).<br>
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong> –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 0.5%, —Ç–æ trailing stop –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–±—ã–ª–∏ >= 0.5% –æ—Ç –º–∞—Ä–∂–∏, –∏–ª–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–æ TP (–µ—Å–ª–∏ –æ–Ω–∞ –±–æ–ª—å—à–µ).
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Trailing Stop Distance % (–æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã):</label>
                        <input type="number" name="trailing_stop_distance_pct" value="${(risk.trailing_stop_distance_pct * 100).toFixed(3)}" step="0.001" min="0.1" max="5">
                        <small style="color: #aaa; display: block; margin-top: 5px;">
                            <strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ trailing stop –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã:</strong><br>
                            SL –±—É–¥–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ —ç—Ç–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–π —Ü–µ–Ω—ã.<br>
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong> –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 0.3%, –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ = $143.50, —Ç–æ trailing SL = $143.50 * (1 - 0.003) = $143.07
                        </small>
                    </div>
                    <h3 style="margin-top: 20px; color: #00d4ff;">App Settings</h3>
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
                    <input type="hidden" name="symbol" value="${app.symbol}">
                    <input type="hidden" name="timeframe" value="${app.timeframe || '15m'}">
                    <input type="hidden" name="live_poll_seconds" value="${app.live_poll_seconds || 60}">
                    
                    <div class="form-group">
                        <label>Leverage:</label>
                        <input type="number" name="leverage" value="${app.leverage}" min="1" max="125" step="1">
                        <small style="color: #aaa; display: block; margin-top: 5px;">–¢–æ—Ä–≥–æ–≤–æ–µ –ø–ª–µ—á–æ (1-125). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –∏ TP/SL –¥–ª—è ML —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.</small>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9em; color: #aaa;">
                        <strong style="color: #888;">–°–∫—Ä—ã—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</strong><br>
                        ‚Ä¢ <strong>Symbol:</strong> –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ "Active Symbols" –≤—ã—à–µ<br>
                        ‚Ä¢ <strong>Timeframe:</strong> –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ 15 –º–∏–Ω—É—Ç (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π)<br>
                        ‚Ä¢ <strong>Live Poll Seconds:</strong> –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ 60 —Å–µ–∫—É–Ω–¥ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏)
                    </div>
                    <h3 style="margin-top: 20px; color: #9933ff;">ML Strategy Settings</h3>
                    <div class="form-group">
                        <label>ML Confidence Threshold (0-1):</label>
                        <input type="number" name="ml_confidence_threshold" value="${app.ml_confidence_threshold}" step="0.01" min="0" max="1">
                        <small style="color: #aaa; display: block; margin-top: 4px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ML –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (0.0 - 1.0)</small>
                    </div>
                    <div class="form-group">
                        <label>ML Min Signal Strength:</label>
                        <select name="ml_min_signal_strength" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px;">
                            <option value="—Å–ª–∞–±–æ–µ" ${app.ml_min_signal_strength === '—Å–ª–∞–±–æ–µ' ? 'selected' : ''}>–°–ª–∞–±–æ–µ (0%)</option>
                            <option value="—É–º–µ—Ä–µ–Ω–Ω–æ–µ" ${app.ml_min_signal_strength === '—É–º–µ—Ä–µ–Ω–Ω–æ–µ' ? 'selected' : ''}>–£–º–µ—Ä–µ–Ω–Ω–æ–µ (60%)</option>
                            <option value="—Å—Ä–µ–¥–Ω–µ–µ" ${app.ml_min_signal_strength === '—Å—Ä–µ–¥–Ω–µ–µ' ? 'selected' : ''}>–°—Ä–µ–¥–Ω–µ–µ (70%)</option>
                            <option value="—Å–∏–ª—å–Ω–æ–µ" ${app.ml_min_signal_strength === '—Å–∏–ª—å–Ω–æ–µ' ? 'selected' : ''}>–°–∏–ª—å–Ω–æ–µ (80%)</option>
                            <option value="–æ—á–µ–Ω—å_—Å–∏–ª—å–Ω–æ–µ" ${app.ml_min_signal_strength === '–æ—á–µ–Ω—å_—Å–∏–ª—å–Ω–æ–µ' ? 'selected' : ''}>–û—á–µ–Ω—å —Å–∏–ª—å–Ω–æ–µ (90%)</option>
                        </select>
                        <small style="color: #aaa; display: block; margin-top: 4px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è</small>
                    </div>
                    <div class="form-group">
                        <label>ML Stability Filter:</label>
                        <input type="checkbox" name="ml_stability_filter" ${app.ml_stability_filter ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <small style="color: #aaa; display: block; margin-top: 4px;">–¢—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Å–º–µ–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏</small>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
                        <button type="button" id="test-ml-strategy-btn" onclick="testMLStrategy()" style="padding: 10px 20px; background: #9933ff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-right: 10px;">üß™ Test ML Strategy</button>
                        <div id="ml-test-results" style="margin-top: 15px; display: none;">
                            <h4 style="color: #9933ff; margin-bottom: 10px;">Test Results:</h4>
                            <div id="ml-test-content" style="color: #e0e0e0; font-size: 0.9em; line-height: 1.6;"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn">Save Risk Settings</button>
                </form>
            `;
        }
        
        async function saveSettings(event, section) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º checkbox, –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
                if (key === 'range_tp_aggressive' || key === 'enable_trailing_stop') {
                    continue;
                }
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—É—é –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –¥—Ä–æ–±–µ–π (–¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
                const normalizedValue = String(value).replace(',', '.');
                const numValue = parseFloat(normalizedValue);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –¥–æ–ª–∏ –¥–ª—è stop_loss_pct, take_profit_pct, range_stop_loss_pct, trailing_stop_activation_pct –∏ trailing_stop_distance_pct
                if (key === 'stop_loss_pct' || key === 'take_profit_pct' || key === 'range_stop_loss_pct' || 
                    key === 'trailing_stop_activation_pct' || key === 'trailing_stop_distance_pct') {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5 –¥–ª—è 0.5%), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –¥–æ–ª–∏ (0.005)
                    data[key] = isNaN(numValue) ? value : numValue / 100.0;
                } else {
                data[key] = isNaN(numValue) ? value : numValue;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º checkbox –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è strategy —Å–µ–∫—Ü–∏–∏
            if (section === 'strategy') {
                const checkbox = event.target.querySelector('[name="range_tp_aggressive"]');
                if (checkbox) {
                    data.range_tp_aggressive = checkbox.checked;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º checkbox –¥–ª—è risk —Å–µ–∫—Ü–∏–∏
            if (section === 'risk') {
                const trailingStopCheckbox = event.target.querySelector('[name="enable_trailing_stop"]');
                if (trailingStopCheckbox) {
                    data.enable_trailing_stop = trailingStopCheckbox.checked;
                }
            }
            
            try {
                const payload = { [section]: data };
                if (section === 'risk') {
                    // –î–æ–±–∞–≤–ª—è–µ–º app settings –≤ risk —Ñ–æ—Ä–º—É
                    payload.app = {};
                    for (const [key, value] of formData.entries()) {
                        if (['symbol', 'timeframe', 'leverage', 'live_poll_seconds', 'ml_confidence_threshold', 'ml_min_signal_strength', 'ml_stability_filter'].includes(key)) {
                            if (key === 'ml_stability_filter') {
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º checkbox –æ—Ç–¥–µ–ª—å–Ω–æ
                                payload.app[key] = event.target.querySelector('[name="ml_stability_filter"]').checked;
                            } else if (key === 'ml_confidence_threshold') {
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—É—é –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –¥—Ä–æ–±–µ–π (–¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
                                const normalizedValue = String(value).replace(',', '.');
                                const numValue = parseFloat(normalizedValue);
                                payload.app[key] = isNaN(numValue) ? value : numValue;
                            } else if (key === 'ml_min_signal_strength') {
                                payload.app[key] = value; // –°—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            } else {
                                const numValue = parseFloat(value);
                                payload.app[key] = isNaN(numValue) ? value : numValue;
                            }
                        }
                    }
                }
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    const sectionName = section === 'strategy' ? 'Strategy Settings' : section === 'risk' ? 'Risk Management Settings' : 'Settings';
                    alert(`${sectionName} saved successfully!`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    if (section === 'strategy' || section === 'risk') {
                        loadSettings();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }
        
        async function removeDuplicateTrades() {
            try {
                const response = await fetch('/api/trades/remove-duplicates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Removed ${data.removed_count} duplicate trades. Refreshing list...`);
                    loadTrades(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫
                } else {
                    alert(`Error removing duplicates: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error removing duplicate trades:', error);
                alert('Error removing duplicate trades. Check console for details.');
            }
        }
        
        async function testMLStrategy() {
            try {
                const btn = document.getElementById('test-ml-strategy-btn');
                const resultsDiv = document.getElementById('ml-test-results');
                const contentDiv = document.getElementById('ml-test-content');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –ø–æ –∏–º–µ–Ω–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
                const confidenceInput = document.querySelector('[name="ml_confidence_threshold"]');
                const strengthSelect = document.querySelector('[name="ml_min_signal_strength"]');
                const stabilityCheckbox = document.querySelector('[name="ml_stability_filter"]');
                
                if (!confidenceInput || !strengthSelect || !stabilityCheckbox) {
                    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–µ—Ä–µ–∑ API
                    console.warn('ML settings inputs not found in DOM, fetching from API...');
                    try {
                        const settingsResponse = await fetch('/api/settings');
                        const settingsData = await settingsResponse.json();
                        if (settingsData && settingsData.app) {
                            const app = settingsData.app;
                            const confidenceValue = app.ml_confidence_threshold || 0.4;
                            const strengthValue = app.ml_min_signal_strength || '—É–º–µ—Ä–µ–Ω–Ω–æ–µ';
                            const stabilityValue = app.ml_stability_filter !== undefined ? app.ml_stability_filter : false;
                            
                            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª
                            const symbolSelect = document.getElementById('primary-symbol-select');
                            const symbol = symbolSelect ? symbolSelect.value : 'BTCUSDT';
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                            btn.disabled = true;
                            btn.textContent = '‚è≥ Testing...';
                            resultsDiv.style.display = 'block';
                            contentDiv.innerHTML = '<div style="color: #aaa;">Loading...</div>';
                            
                            // –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ API
                            const response = await fetch('/api/ml/test', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    symbol: symbol,
                                    ml_confidence_threshold: confidenceValue,
                                    ml_min_signal_strength: strengthValue,
                                    ml_stability_filter: stabilityValue,
                                }),
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || `HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –Ω–∏–∂–µ)
                            const stats = data.statistics;
                            const params = data.parameters;
                            const confStats = data.confidence_stats || {};
                            const period = data.data_period || {};
                            
                            let html = `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #9933ff;">Symbol:</strong> ${data.symbol}<br>
                                    <strong style="color: #9933ff;">Parameters:</strong><br>
                                    &nbsp;&nbsp;‚Ä¢ Confidence Threshold: ${params.ml_confidence_threshold}<br>
                                    &nbsp;&nbsp;‚Ä¢ Min Signal Strength: ${params.ml_min_signal_strength}<br>
                                    &nbsp;&nbsp;‚Ä¢ Stability Filter: ${params.ml_stability_filter ? 'Enabled' : 'Disabled'}
                                </div>
                                <div style="margin-bottom: 15px; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                                    <strong style="color: #9933ff;">Signal Statistics:</strong><br>
                                    &nbsp;&nbsp;‚Ä¢ Total Signals: <span style="color: #e0e0e0;">${stats.total_signals}</span><br>
                                    &nbsp;&nbsp;‚Ä¢ LONG Signals: <span style="color: #4caf50;">${stats.long_signals}</span><br>
                                    &nbsp;&nbsp;‚Ä¢ SHORT Signals: <span style="color: #f44336;">${stats.short_signals}</span><br>
                                    &nbsp;&nbsp;‚Ä¢ HOLD Signals: <span style="color: #aaa;">${stats.hold_signals}</span><br>
                                    <br>
                                    <strong style="color: #9933ff;">Fresh Signals (24h):</strong><br>
                                    &nbsp;&nbsp;‚Ä¢ Total: <span style="color: #e0e0e0;">${stats.fresh_signals_24h}</span><br>
                                    &nbsp;&nbsp;‚Ä¢ LONG: <span style="color: #4caf50;">${stats.fresh_long_24h}</span><br>
                                    &nbsp;&nbsp;‚Ä¢ SHORT: <span style="color: #f44336;">${stats.fresh_short_24h}</span>
                            `;
                            
                            if (Object.keys(confStats).length > 0) {
                                html += `
                                    <br><br>
                                    <strong style="color: #9933ff;">Confidence Statistics:</strong><br>
                                    &nbsp;&nbsp;‚Ä¢ Min: ${(confStats.min * 100).toFixed(1)}%<br>
                                    &nbsp;&nbsp;‚Ä¢ Max: ${(confStats.max * 100).toFixed(1)}%<br>
                                    &nbsp;&nbsp;‚Ä¢ Mean: ${(confStats.mean * 100).toFixed(1)}%<br>
                                    &nbsp;&nbsp;‚Ä¢ Median: ${(confStats.median * 100).toFixed(1)}%
                                `;
                            }
                            
                            if (period.start_time && period.end_time) {
                                html += `
                                    <br><br>
                                    <strong style="color: #9933ff;">Data Period:</strong><br>
                                    &nbsp;&nbsp;‚Ä¢ Candles: ${period.candles_count}<br>
                                    &nbsp;&nbsp;‚Ä¢ From: ${new Date(period.start_time).toLocaleString()}<br>
                                    &nbsp;&nbsp;‚Ä¢ To: ${new Date(period.end_time).toLocaleString()}
                                `;
                            }
                            
                            html += '</div>';
                            contentDiv.innerHTML = html;
                            btn.disabled = false;
                            btn.textContent = 'üß™ Test ML Strategy';
                            return;
                        }
                    } catch (apiError) {
                        console.error('Error fetching settings from API:', apiError);
                    }
                    alert('ML settings inputs not found. Please make sure you are on the Risk Management Settings tab.');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª
                const symbolSelect = document.getElementById('primary-symbol-select');
                const symbol = symbolSelect ? symbolSelect.value : 'BTCUSDT';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                btn.disabled = true;
                btn.textContent = '‚è≥ Testing...';
                resultsDiv.style.display = 'block';
                contentDiv.innerHTML = '<div style="color: #aaa;">Loading...</div>';
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
                const confidenceValue = parseFloat(confidenceInput.value.replace(',', '.')) || 0.4;
                const strengthValue = strengthSelect.value;
                const stabilityValue = stabilityCheckbox.checked;
                
                const response = await fetch('/api/ml/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        ml_confidence_threshold: confidenceValue,
                        ml_min_signal_strength: strengthValue,
                        ml_stability_filter: stabilityValue,
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const stats = data.statistics;
                const params = data.parameters;
                const confStats = data.confidence_stats || {};
                const period = data.data_period || {};
                
                let html = `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #9933ff;">Symbol:</strong> ${data.symbol}<br>
                        <strong style="color: #9933ff;">Parameters:</strong><br>
                        &nbsp;&nbsp;‚Ä¢ Confidence Threshold: ${params.ml_confidence_threshold}<br>
                        &nbsp;&nbsp;‚Ä¢ Min Signal Strength: ${params.ml_min_signal_strength}<br>
                        &nbsp;&nbsp;‚Ä¢ Stability Filter: ${params.ml_stability_filter ? 'Enabled' : 'Disabled'}
                    </div>
                    <div style="margin-bottom: 15px; padding: 10px; background: #2a2a2a; border-radius: 5px;">
                        <strong style="color: #9933ff;">Signal Statistics:</strong><br>
                        &nbsp;&nbsp;‚Ä¢ Total Signals: <span style="color: #e0e0e0;">${stats.total_signals}</span><br>
                        &nbsp;&nbsp;‚Ä¢ LONG Signals: <span style="color: #4caf50;">${stats.long_signals}</span><br>
                        &nbsp;&nbsp;‚Ä¢ SHORT Signals: <span style="color: #f44336;">${stats.short_signals}</span><br>
                        &nbsp;&nbsp;‚Ä¢ HOLD Signals: <span style="color: #aaa;">${stats.hold_signals}</span><br>
                        <br>
                        <strong style="color: #9933ff;">Fresh Signals (24h):</strong><br>
                        &nbsp;&nbsp;‚Ä¢ Total: <span style="color: #e0e0e0;">${stats.fresh_signals_24h}</span><br>
                        &nbsp;&nbsp;‚Ä¢ LONG: <span style="color: #4caf50;">${stats.fresh_long_24h}</span><br>
                        &nbsp;&nbsp;‚Ä¢ SHORT: <span style="color: #f44336;">${stats.fresh_short_24h}</span>
                `;
                
                if (Object.keys(confStats).length > 0) {
                    html += `
                        <br><br>
                        <strong style="color: #9933ff;">Confidence Statistics:</strong><br>
                        &nbsp;&nbsp;‚Ä¢ Min: ${(confStats.min * 100).toFixed(1)}%<br>
                        &nbsp;&nbsp;‚Ä¢ Max: ${(confStats.max * 100).toFixed(1)}%<br>
                        &nbsp;&nbsp;‚Ä¢ Mean: ${(confStats.mean * 100).toFixed(1)}%<br>
                        &nbsp;&nbsp;‚Ä¢ Median: ${(confStats.median * 100).toFixed(1)}%
                    `;
                }
                
                if (period.start_time && period.end_time) {
                    html += `
                        <br><br>
                        <strong style="color: #9933ff;">Data Period:</strong><br>
                        &nbsp;&nbsp;‚Ä¢ Candles: ${period.candles_count}<br>
                        &nbsp;&nbsp;‚Ä¢ From: ${new Date(period.start_time).toLocaleString()}<br>
                        &nbsp;&nbsp;‚Ä¢ To: ${new Date(period.end_time).toLocaleString()}
                    `;
                }
                
                html += '</div>';
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error testing ML strategy:', error);
                const contentDiv = document.getElementById('ml-test-content');
                contentDiv.innerHTML = `<div style="color: #f44336;">Error: ${error.message}</div>`;
            } finally {
                const btn = document.getElementById('test-ml-strategy-btn');
                btn.disabled = false;
                btn.textContent = 'üß™ Test ML Strategy';
            }
        }
        
        async function loadTrades() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª –∏–∑ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Å–∏–º–≤–æ–ª–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
                const symbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = symbolSelect ? symbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º symbol
                const url = `/api/trades?symbol=${encodeURIComponent(selectedSymbol)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —Ç–µ—Å—Ç–Ω–µ—Ç (–∏–∑ API –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                const isTestnet = data.is_testnet !== undefined ? data.is_testnet : true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL
                if (data.pnl_stats) {
                    const stats = data.pnl_stats;
                    
                    // PnL —Å–µ–≥–æ–¥–Ω—è
                    const pnlToday = parseFloat(stats.pnl_today || 0);
                    document.getElementById('pnl-today').textContent = `${pnlToday >= 0 ? '+' : ''}${pnlToday.toFixed(2)} USDT`;
                    document.getElementById('pnl-today').className = `stat-value ${pnlToday >= 0 ? 'positive' : 'negative'}`;
                    
                    // PnL –∑–∞ –Ω–µ–¥–µ–ª—é
                    const pnlWeek = parseFloat(stats.pnl_week || 0);
                    document.getElementById('pnl-week').textContent = `${pnlWeek >= 0 ? '+' : ''}${pnlWeek.toFixed(2)} USDT`;
                    document.getElementById('pnl-week').className = `stat-value ${pnlWeek >= 0 ? 'positive' : 'negative'}`;
                    
                    // PnL –∑–∞ –º–µ—Å—è—Ü
                    const pnlMonth = parseFloat(stats.pnl_month || 0);
                    document.getElementById('pnl-month').textContent = `${pnlMonth >= 0 ? '+' : ''}${pnlMonth.toFixed(2)} USDT`;
                    document.getElementById('pnl-month').className = `stat-value ${pnlMonth >= 0 ? 'positive' : 'negative'}`;
                    
                    // –û–±—â–∏–π PnL –ø–æ –ø–∞—Ä–µ
                    const pnlTotal = parseFloat(stats.pnl_total || 0);
                    document.getElementById('pnl-total').textContent = `${pnlTotal >= 0 ? '+' : ''}${pnlTotal.toFixed(2)} USDT`;
                    document.getElementById('pnl-total').className = `stat-value ${pnlTotal >= 0 ? 'positive' : 'negative'}`;
                }
                
                if (data.trades.length === 0) {
                    document.getElementById('trades-table').innerHTML = '<p style="color: #aaa; padding: 20px;">No trades yet</p>';
                    return;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ frontend (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ backend –≤–µ—Ä–Ω–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã—Ö–æ–¥–∞ –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
                const sortedTrades = [...data.trades].sort((a, b) => {
                    const timeA = a.exit_time ? new Date(a.exit_time) : new Date(0);
                    const timeB = b.exit_time ? new Date(b.exit_time) : new Date(0);
                    return timeB - timeA; // –ü–æ —É–±—ã–≤–∞–Ω–∏—é (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
                });
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Time</th><th>Pair</th><th>Strategy</th><th>Side</th><th>Entry</th><th>Exit</th><th>Size</th><th>PnL</th><th>Order ID</th></tr></thead><tbody>';
                sortedTrades.forEach(trade => {
                    const strategyType = (trade.strategy_type || 'unknown').toLowerCase();
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let strategyDisplay = 'UNKNOWN';
                    let strategyColor = '#aaa';
                    if (strategyType === 'trend') {
                        strategyDisplay = 'TREND';
                        strategyColor = '#00ff88';
                    } else if (strategyType === 'flat') {
                        strategyDisplay = 'FLAT';
                        strategyColor = '#ffaa00';
                    } else if (strategyType === 'ml') {
                        strategyDisplay = 'ML';
                        strategyColor = '#9933ff';
                    } else if (strategyType === 'momentum') {
                        strategyDisplay = 'MOMENTUM';
                        strategyColor = '#00d4ff';
                    } else if (strategyType === 'smc') {
                        strategyDisplay = 'SMC';
                        strategyColor = '#9d4edd';
                    } else if (strategyType === 'ict') {
                        strategyDisplay = 'ICT';
                        strategyColor = '#ff6b6b';
                    } else if (strategyType === 'liquidation_hunter') {
                        strategyDisplay = 'LIQUIDATION HUNTER';
                        strategyColor = '#ff9500';
                    } else if (strategyType === 'zscore') {
                        strategyDisplay = 'Z-SCORE';
                        strategyColor = '#00ffaa';
                    } else if (strategyType === 'vbo') {
                        strategyDisplay = 'VBO';
                        strategyColor = '#ff00ff';
                    } else if (strategyType === 'hybrid') {
                        strategyDisplay = 'HYBRID';
                        strategyColor = '#00d4ff';
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤—ã—Ö–æ–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏)
                    const exitTimeStr = trade.exit_time ? convertToMSK(trade.exit_time) : '-';
                    
                    // –ü–æ–ª—É—á–∞–µ–º orderId –∏ orderLinkId
                    const orderId = trade.order_id || trade.order_link_id || null;
                    const orderLinkId = trade.order_link_id || null;
                    const symbol = trade.symbol || 'SOLUSDT';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è Order ID (–ø—Ä–∏ –∫–ª–∏–∫–µ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞)
                    // Order ID - —ç—Ç–æ ID –æ—Ä–¥–µ—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (market order, TP –∏–ª–∏ SL)
                    let orderIdDisplay = '-';
                    if (orderId && orderId !== '-' && orderId !== null && orderId !== '') {
                        const shortId = orderId.length > 16 ? orderId.substring(0, 16) + '...' : orderId;
                        orderIdDisplay = `<span onclick="copyToClipboard('${orderId}', this)" style="cursor: pointer; color: #00d4ff; text-decoration: underline; font-family: monospace; font-size: 0.9em;" title="Click to copy Order ID">${shortId}</span>`;
                    } else if (orderLinkId && orderLinkId !== '-' && orderLinkId !== null && orderLinkId !== '') {
                        // –ï—Å–ª–∏ orderId –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å orderLinkId, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –±–æ—Ç–∞)
                        const shortId = orderLinkId.length > 16 ? orderLinkId.substring(0, 16) + '...' : orderLinkId;
                        orderIdDisplay = `<span onclick="copyToClipboard('${orderLinkId}', this)" style="cursor: pointer; color: #888; text-decoration: underline; font-family: monospace; font-size: 0.9em;" title="Click to copy Order Link ID (Internal)">${shortId}</span>`;
                    }
                    
                    html += `<tr>
                        <td>${exitTimeStr}</td>
                        <td>${symbol}</td>
                        <td><span style="color: ${strategyColor}; font-weight: bold;">${strategyDisplay}</span></td>
                        <td>${trade.side}</td>
                        <td>$${trade.entry_price?.toFixed(2) || '-'}</td>
                        <td>$${trade.exit_price?.toFixed(2) || '-'}</td>
                        <td>$${trade.size_usd?.toFixed(2) || '-'}</td>
                        <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl?.toFixed(2) || '0.00'}</td>
                        <td>${orderIdDisplay}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                document.getElementById('trades-table').innerHTML = html;
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        async function loadSMCHistory() {
            try {
                const response = await fetch('/api/smc/history?limit=100');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load SMC history');
                }
                
                const data = result.history || [];
                
                const countSpan = document.getElementById('smc-count');
                if (countSpan) {
                    countSpan.textContent = `(${data.length} signal${data.length !== 1 ? 's' : ''} found)`;
                    countSpan.style.color = data.length > 0 ? '#00ff88' : '#aaa';
                }
                
                if (data.length === 0) {
                    document.getElementById('smc-history-table').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #aaa;">
                            <p style="font-size: 1.2em; margin-bottom: 10px;">üìä No SMC signals yet</p>
                            <p style="font-size: 0.9em;">Signals will appear here once the SMC strategy starts generating entries</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #2a2a2a;">';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Time (MSK)</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Pair</th>';
                html += '<th style="padding: 12px; text-align: center; border-bottom: 2px solid #444;">Action</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">Entry</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">SL</th>';
                html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid #444;">TP</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #444;">Zone Type</th>';
                html += '<th style="padding: 12px; text-align: center; border-bottom: 2px solid #444;">RR</th>';
                html += '</tr></thead><tbody>';
                
                data.forEach((sig, idx) => {
                    const actionColor = sig.action === 'LONG' ? '#00ff88' : '#ff4444';
                    const timeStr = sig.timestamp ? convertToMSK(sig.timestamp) : '-';
                    const entryPrice = parseFloat(sig.price || 0);
                    const stopLoss = parseFloat(sig.stop_loss || 0);
                    const takeProfit = parseFloat(sig.take_profit || 0);
                    const rrRatio = parseFloat(sig.rr_ratio || 0).toFixed(1);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–æ–Ω—ã –∏–∑ reason (FVG –∏–ª–∏ OB)
                    const reason = sig.reason || '';
                    let zoneType = 'Unknown';
                    let zoneColor = '#aaa';
                    if (reason.includes('FVG')) {
                        zoneType = 'FVG';
                        zoneColor = '#ffaa00';
                    } else if (reason.includes('OB')) {
                        zoneType = 'Order Block';
                        zoneColor = '#9933ff';
                    }
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∏—Å–∫ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å
                    const risk = sig.action === 'LONG' ? (entryPrice - stopLoss) : (stopLoss - entryPrice);
                    const reward = sig.action === 'LONG' ? (takeProfit - entryPrice) : (entryPrice - takeProfit);
                    
                    const bgColor = idx % 2 === 0 ? '#1a1a1a' : '#222';
                    
                    html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #333;">
                        <td style="padding: 10px;">${timeStr}</td>
                        <td style="padding: 10px; font-weight: bold;">${sig.symbol || '-'}</td>
                        <td style="padding: 10px; text-align: center;">
                            <span style="color: ${actionColor}; font-weight: bold; background: ${actionColor}22; padding: 4px 12px; border-radius: 4px;">
                                ${sig.action}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: #00d4ff;">$${entryPrice.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: #ff4444;">$${stopLoss.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; color: #00ff88;">$${takeProfit.toFixed(2)}</td>
                        <td style="padding: 10px;">
                            <span style="color: ${zoneColor}; font-size: 0.9em; background: ${zoneColor}22; padding: 3px 8px; border-radius: 3px;">
                                ${zoneType}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: bold; color: ${parseFloat(rrRatio) >= 2.0 ? '#00ff88' : '#ffaa00'};">
                            1:${rrRatio}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('smc-history-table').innerHTML = html;
                
                console.log(`‚úÖ Loaded ${data.length} SMC signals`);
            } catch (error) {
                console.error('‚ùå Error loading SMC history:', error);
                document.getElementById('smc-history-table').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff4444;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">‚ö†Ô∏è Error loading SMC history</p>
                        <p style="font-size: 0.9em;">${error.message || 'Unknown error'}</p>
                        <p style="font-size: 0.8em; color: #aaa; margin-top: 10px;">Check console for details</p>
                    </div>
                `;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∑–µ–ª–µ–Ω—ã–π, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ
                const originalColor = element.style.color;
                element.style.color = '#00ff88';
                element.title = 'Copied!';
                setTimeout(() => {
                    element.style.color = originalColor;
                    element.title = 'Click to copy';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ MSK (UTC+3)
        function convertToMSK(isoString) {
            if (!isoString) return '-';
            try {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
                let dateStr = isoString.trim();
                
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç MSK - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (—É–∂–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ)
                if (dateStr.includes('MSK')) {
                    return dateStr;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ timezone –≤ —Å—Ç—Ä–æ–∫–µ
                const hasTimezone = dateStr.includes('Z') || dateStr.match(/[+-]\d{2}:?\d{2}$/);
                
                if (!hasTimezone) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç timezone, –¥–æ–±–∞–≤–ª—è–µ–º 'Z' –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è UTC
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?$/)) {
                        // ISO —Ñ–æ—Ä–º–∞—Ç —Å —Å–µ–∫—É–Ω–¥–∞–º–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏)
                        dateStr = dateStr + 'Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                        // ISO —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ —Å–µ–∫—É–Ω–¥
                        dateStr = dateStr + ':00Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/)) {
                        // –§–æ—Ä–º–∞—Ç –±–µ–∑ T, —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
                        dateStr = dateStr.replace(' ', 'T') + 'Z';
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                        // –§–æ—Ä–º–∞—Ç –±–µ–∑ T –∏ —Å–µ–∫—É–Ω–¥
                        dateStr = dateStr.replace(' ', 'T') + ':00Z';
                    }
                    // –ï—Å–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                }
                
                // –°–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç timezone)
                const date = new Date(dateStr);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', isoString, 'normalized to:', dateStr);
                    return isoString;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ MSK
                // –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç timezone –∏—Å—Ö–æ–¥–Ω–æ–π –¥–∞—Ç—ã –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ MSK
                const formatter = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Europe/Moscow',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const parts = formatter.formatToParts(date);
                const year = parts.find(p => p.type === 'year').value;
                const month = parts.find(p => p.type === 'month').value;
                const day = parts.find(p => p.type === 'day').value;
                const hours = parts.find(p => p.type === 'hour').value;
                const minutes = parts.find(p => p.type === 'minute').value;
                const seconds = parts.find(p => p.type === 'second').value;
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} MSK`;
            } catch (e) {
                console.error('Error converting time to MSK:', e, isoString);
                return isoString; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }
        
        async function loadSignals() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–∏–º–≤–æ–ª –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º "ALL" –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
                const signalSymbolFilter = document.getElementById('signal-symbol-filter');
                const selectedSymbol = signalSymbolFilter && signalSymbolFilter.value !== 'ALL' 
                    ? signalSymbolFilter.value 
                    : 'ALL'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º symbol (–∏–ª–∏ –±–µ–∑ –Ω–µ–≥–æ, –µ—Å–ª–∏ "ALL")
                const url = `/api/signals?symbol=${encodeURIComponent(selectedSymbol)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.signals.length === 0) {
                    document.getElementById('signals-table').innerHTML = '<p style="color: #aaa; padding: 20px;">No signals yet</p>';
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É (–ø–æ timestamp –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
                const sortedSignals = [...data.signals].sort((a, b) => {
                    const timeA = new Date(a.timestamp || 0).getTime();
                    const timeB = new Date(b.timestamp || 0).getTime();
                    return timeB - timeA; // –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const formatStrategyType = (type) => {
                    const types = {
                        'trend': '<span style="color: #00ff88;">TREND</span>',
                        'flat': '<span style="color: #ffaa00;">FLAT</span>',
                        'ml': '<span style="color: #9933ff;">ML</span>',
                        'momentum': '<span style="color: #00d4ff;">MOMENTUM</span>',
                        'smc': '<span style="color: #9d4edd;">SMC</span>',
                        'ict': '<span style="color: #ff6b6b;">ICT</span>',
                        'liquidation_hunter': '<span style="color: #ff9500;">LIQUIDATION HUNTER</span>',
                        'zscore': '<span style="color: #00ffaa;">Z-SCORE</span>',
                        'vbo': '<span style="color: #ff00ff;">VBO</span>',
                        'unknown': '<span style="color: #aaa;">UNKNOWN</span>'
                    };
                    return types[type] || types['unknown'];
                };
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è —Å —Ü–≤–µ—Ç–æ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
                const formatAction = (action) => {
                    const actionLower = (action || '').toLowerCase();
                    if (actionLower === 'long') {
                        return '<span style="color: #00ff88; font-weight: bold;">long</span>';
                    } else if (actionLower === 'short') {
                        return '<span style="color: #ff4444; font-weight: bold;">short</span>';
                    } else {
                        return action || '-';
                    }
                };
                
                let html = '<div class="table-wrapper"><table><thead><tr><th>Time (MSK)</th><th>Pair</th><th>Strategy</th><th>Action</th><th>Reason</th><th>Price</th></tr></thead><tbody>';
                sortedSignals.forEach(signal => {
                    const mskTime = convertToMSK(signal.timestamp);
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ reason, –µ—Å–ª–∏ strategy_type –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ "unknown"
                    let strategyType = signal.strategy_type || 'unknown';
                    if (strategyType === 'unknown' || !strategyType) {
                        const reason = (signal.reason || '').toLowerCase();
                        if (reason.startsWith('ml_')) strategyType = 'ml';
                        else if (reason.startsWith('smc_')) strategyType = 'smc';
                        else if (reason.startsWith('trend_')) strategyType = 'trend';
                        else if (reason.startsWith('range_') || reason.startsWith('flat_')) strategyType = 'flat';
                        else if (reason.startsWith('momentum_')) strategyType = 'momentum';
                        else if (reason.startsWith('ict_')) strategyType = 'ict';
                        else if (reason.startsWith('liquidation_hunter_')) strategyType = 'liquidation_hunter';
                        else if (reason.startsWith('zscore_')) strategyType = 'zscore';
                        else if (reason.startsWith('vbo_')) strategyType = 'vbo';
                    }
                    html += `<tr>
                        <td>${mskTime}</td>
                        <td>${signal.symbol || '-'}</td>
                        <td>${formatStrategyType(strategyType)}</td>
                        <td>${formatAction(signal.action)}</td>
                        <td>${signal.reason}</td>
                        <td>$${signal.price?.toFixed(2) || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                document.getElementById('signals-table').innerHTML = html;
            } catch (error) {
                console.error('Error loading signals:', error);
                document.getElementById('signals-table').innerHTML = '<p style="color: #ff4444;">Error loading signals</p>';
            }
        }
        
        async function clearSignals() {
            if (!confirm('Are you sure you want to clear all signals? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/signals/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                if (data.success) {
                    alert('All signals cleared successfully');
                    loadSignals(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ (–±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º)
                } else {
                    alert('Error clearing signals: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing signals:', error);
                alert('Error clearing signals: ' + error.message);
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π (–∑–∞–º–µ–Ω—è–µ–º –∑–∞–≥–ª—É—à–∫—É)
        window.startBot = async function() {
            try {
                const response = await fetch('/api/bot/start', { method: 'POST' });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        alert('Error starting bot: ' + (errorData.error || `HTTP ${response.status}: ${response.statusText}`));
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        alert(`Error starting bot: HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    alert('Error: Response is not JSON');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                    if (data.bot_status) {
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator running"></span>Running`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #00ff88;">${data.bot_status.current_status || 'Running'}</span>`;
                        }
                    } else {
                        // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator running"></span>Running`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #00ff88;">Running</span>`;
                        }
                    }
                    
                    alert('Bot started! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        updateStatus();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–æ—Ä–∫–µ—Ä–∞–º–∏
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.error('Error starting bot: Server unavailable or network error', error);
                    console.error('Request details:', {
                        url: '/api/bot/start',
                        method: 'POST',
                        currentUrl: window.location.href,
                        hostname: window.location.hostname,
                        port: window.location.port
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
                    fetch('/api/status')
                        .then(response => {
                            if (response.ok) {
                                alert('Error: Cannot start bot, but server is reachable.\n\n' +
                                      'Please check server logs for errors during bot startup.');
                            } else {
                                alert('Error: Server responded with status ' + response.status + '.\n\n' +
                                      'Please check server logs for details.');
                            }
                        })
                        .catch(checkError => {
                            alert('Error: Server is not reachable.\n\n' +
                                  'Please ensure:\n' +
                                  '1. The server is running (python main.py --mode web)\n' +
                                  '2. The server is accessible at ' + window.location.origin + '\n' +
                                  '3. There are no firewall/network issues\n' +
                                  '4. Check browser console and server logs for more details');
                        });
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error starting bot: Invalid JSON response', error);
                    alert('Error starting bot: Invalid server response.\n\n' +
                          'The server may be returning an error page instead of JSON.\n' +
                          'Please check server logs.');
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error starting bot:', error);
                    alert('Error starting bot: ' + (error.message || 'Unknown error') + '\n\n' +
                          'Check browser console (F12) for details.');
                }
            }
        }
        
        window.stopBot = async function() {
            try {
                const response = await fetch('/api/bot/stop', { method: 'POST' });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        alert('Error stopping bot: ' + (errorData.error || `HTTP ${response.status}: ${response.statusText}`));
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        alert(`Error stopping bot: HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    alert('Error: Response is not JSON');
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
                    if (data.bot_status) {
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator stopped"></span>Stopped`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #aaa;">${data.bot_status.current_status || 'Stopped'}</span>`;
                        }
                    } else {
                        // Fallback: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é
                        const botStatusEl = document.getElementById('bot-status');
                        if (botStatusEl) {
                            botStatusEl.innerHTML = 
                                `<span class="status-indicator stopped"></span>Stopped`;
                        }
                        
                        const currentStatusEl = document.getElementById('current-status');
                        if (currentStatusEl) {
                            currentStatusEl.innerHTML = 
                                `<span style="color: #aaa;">Stopped</span>`;
                        }
                    }
                    
                    alert('Bot stopped! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        updateStatus();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤–∫–ª–∞–¥–∫–µ Symbols
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.error('Error stopping bot: Server unavailable or network error', error);
                    alert('Error stopping bot: Server unavailable or network error. Please check if the server is running.');
                } else if (error.name === 'SyntaxError') {
                    // –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    console.error('Error stopping bot: Invalid JSON response', error);
                    alert('Error stopping bot: Invalid server response');
                } else {
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    console.error('Error stopping bot:', error);
                    alert('Error stopping bot: ' + (error.message || 'Unknown error'));
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
        window.closePosition = async function() {
            if (!confirm('Are you sure you want to close the current position? This action cannot be undone.')) {
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const symbol = primarySymbolSelect ? primarySymbolSelect.value : 'BTCUSDT';
                
                const response = await fetch(`/api/position/close?symbol=${encodeURIComponent(symbol)}`, { 
                    method: 'POST' 
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const data = await response.json();
                if (data.success) {
                    alert('Position closed successfully! ' + (data.message || ''));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
                    setTimeout(() => {
                        updateStatus();
                        if (typeof loadWalletData === 'function') {
                            loadWalletData();
                        }
                        if (typeof loadSymbolsStatus === 'function') {
                            loadSymbolsStatus();
                        }
                    }, 500);
                } else {
                    alert('Error closing position: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error closing position:', error);
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    alert('Error: Server unavailable or network error. Please check if the server is running.');
                } else {
                    alert('Error closing position: ' + (error.message || 'Unknown error'));
                }
            }
        };
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏
        async function loadSymbolSettings() {
            try {
                const response = await fetch('/api/symbols/active');
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                    const checkboxes = document.querySelectorAll('.symbol-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = data.active_symbols.includes(checkbox.value);
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ (PRIMARY_SYMBOL)
                    const primarySelect = document.getElementById('symbols-primary-select');
                    
                    if (primarySelect) {
                        primarySelect.value = data.primary_symbol;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –≥–ª–∞–≤–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º
                    const followPrimaryCheckbox = document.getElementById('follow-primary-symbol-checkbox');
                    if (followPrimaryCheckbox) {
                        followPrimaryCheckbox.checked = data.follow_primary_symbol !== false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                    }
                    
                    // –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º topSelect (—Å–µ–ª–µ–∫—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞) —Å PRIMARY_SYMBOL
                    // –≠—Ç–∏ –¥–≤–∞ —Å–µ–ª–µ–∫—Ç–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∏–º–≤–æ–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                    const statusSpan = document.getElementById('active-symbols-status');
                    if (statusSpan) {
                        statusSpan.textContent = `Active: ${data.active_symbols.join(', ')} | Primary: ${data.primary_symbol}`;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                    await loadSymbolsStatus();
                } else {
                    console.error('Error loading symbol settings:', data.error);
                }
            } catch (error) {
                console.error('Error loading symbol settings:', error);
                alert('Error loading symbol settings: ' + error.message);
            }
        }
        
        async function saveSymbolSettings() {
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤
                const checkboxes = document.querySelectorAll('.symbol-checkbox:checked');
                const activeSymbols = Array.from(checkboxes).map(cb => cb.value);
                
                if (activeSymbols.length === 0) {
                    alert('Please select at least one symbol');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º–≤–æ–ª
                const primarySelect = document.getElementById('symbols-primary-select');
                const primarySymbol = primarySelect ? primarySelect.value : activeSymbols[0];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º–≤–æ–ª –≤ —Å–ø–∏—Å–∫–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                if (!activeSymbols.includes(primarySymbol)) {
                    alert('Primary symbol must be in the active symbols list');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –≥–ª–∞–≤–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º
                const followPrimaryCheckbox = document.getElementById('follow-primary-symbol-checkbox');
                const followPrimarySymbol = followPrimaryCheckbox ? followPrimaryCheckbox.checked : true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true
                
                const response = await fetch('/api/symbols/set-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: activeSymbols,
                        primary: primarySymbol,
                        follow_primary_symbol: followPrimarySymbol
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º PRIMARY_SYMBOL —Å–µ–ª–µ–∫—Ç–æ—Ä (–¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏)
                    const primarySelect = document.getElementById('symbols-primary-select');
                    if (primarySelect) {
                        primarySelect.value = primarySymbol;
                    }
                    
                    // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º Active Symbol —Å–µ–ª–µ–∫—Ç–æ—Ä (–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞)
                    // –≠—Ç–∏ –¥–≤–∞ —Å–µ–ª–µ–∫—Ç–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∏–º–≤–æ–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
                    const statusMessage = document.getElementById('symbols-status-message');
                    if (statusMessage) {
                        statusMessage.style.display = 'block';
                        statusMessage.style.background = '#1a3a1a';
                        statusMessage.style.color = '#00ff88';
                        statusMessage.style.border = '1px solid #00ff88';
                        statusMessage.textContent = `‚úÖ Settings saved! Active symbols: ${data.active_symbols.join(', ')} | Primary: ${data.primary_symbol}`;
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –Ω–æ–≤—ã–º —Å–∏–º–≤–æ–ª–æ–º
                    if (typeof loadChart !== 'undefined') {
                        setTimeout(loadChart, 500);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    if (typeof updateStatus !== 'undefined') {
                        setTimeout(updateStatus, 500);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤
                    setTimeout(loadSymbolsStatus, 1000);
                } else {
                    alert('Error saving symbol settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving symbol settings:', error);
                alert('Error saving symbol settings: ' + error.message);
            }
        }
        
        async function changePrimarySymbol(symbol) {
            try {
                console.log(`[UI] Changing Active Symbol (for display only) to: ${symbol}`);
                window.currentSymbol = symbol;
                
                // –í–ê–ñ–ù–û: –ú–µ–Ω—è–µ–º –¢–û–õ–¨–ö–û Active Symbol –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (primary-symbol-select)
                // –ù–ï –º–µ–Ω—è–µ–º PRIMARY_SYMBOL (symbols-primary-select) - —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!
                const topSelect = document.getElementById('primary-symbol-select');
                if (topSelect) topSelect.value = symbol;
                
                // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º symbols-primary-select - —ç—Ç–æ PRIMARY_SYMBOL –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏!
                // const symbolsSelect = document.getElementById('symbols-primary-select');
                // if (symbolsSelect) symbolsSelect.value = symbol; // –£–î–ê–õ–ï–ù–û - –Ω–µ –º–µ–Ω—è–µ–º PRIMARY_SYMBOL
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ (forceRefresh = true –¥–ª—è —á–∏—Å—Ç–æ–π —Å–º–µ–Ω—ã)
                if (typeof loadChartLW === 'function') {
                    loadChartLW(true, symbol);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                if (typeof updateStatus === 'function') {
                    updateStatus();
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const id = activeTab.id;
                    if (id === 'trades') loadTrades();
                    else if (id === 'signals') loadSignals();
                    else if (id === 'smc_history') loadSMCHistory();
                    else if (id === 'strategies') {
                        loadStrategyStats();
                        loadMLModelInfo();
                    }
                }
            } catch (error) {
                console.error('Error changing active symbol:', error);
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ AbortController
        let currentSymbolsStatusController = null;
        
        async function loadSymbolsStatus() {
            try {
                // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
                if (currentSymbolsStatusController) {
                    try {
                        currentSymbolsStatusController.abort();
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                    }
                }
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (30 —Å–µ–∫—É–Ω–¥) - api_status() –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ API –≤—ã–∑–æ–≤–æ–≤
                const controller = new AbortController();
                currentSymbolsStatusController = controller;
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 10
                
                const response = await fetch('/api/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    signal: controller.signal,
                    credentials: 'same-origin' // –í–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ cookies/session
                });
                
                clearTimeout(timeoutId);
                currentSymbolsStatusController = null; // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 401 (Unauthorized), –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è
                    if (response.status === 401) {
                        console.warn('[UI] Session expired, redirecting to login...');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å JSON —Å –æ—à–∏–±–∫–æ–π
                    try {
                        const errorData = await response.json();
                        throw new Error(`HTTP ${response.status}: ${errorData.error || errorData.message || response.statusText}`);
                    } catch (jsonError) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫—É
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Invalid response type: ${contentType || 'unknown'}`);
                }
                
                const data = await response.json();
                console.log('[UI] Symbols status data:', data);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ
                if (data.error) {
                    console.error('[UI] Error in response:', data.error);
                    if (data.error_details) {
                        console.error('[UI] Error details:', data.error_details);
                    }
                    throw new Error(data.error);
                }
                
                console.log('[UI] Symbols status data:', data.symbols_status);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ symbols_status —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π
                if (data.symbols_status && Object.keys(data.symbols_status).length > 0) {
                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–º–≤–æ–ª–æ–≤
                    // currentDisplaySymbol - —ç—Ç–æ Active Symbol –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–ù–ï PRIMARY_SYMBOL!)
                    const generateStatusTable = (symbolsStatus, currentDisplaySymbol = null) => {
                        let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Symbol</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Status</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">Position</th><th style="padding: 10px; text-align: left; border-bottom: 1px solid #333;">PnL</th></tr></thead><tbody>';
                        
                        for (const [symbol, status] of Object.entries(symbolsStatus)) {
                            const position = status.position;
                            const pnl = position ? (position.unrealised_pnl || 0) : 0;
                            const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                            const positionInfo = position && position.side ? `${position.side} ${position.size ? position.size.toFixed(3) : '0.000'} @ $${position.avg_price ? position.avg_price.toFixed(2) : '0.00'}` : 'No position';
                            const pnlDisplay = position ? `$${pnl.toFixed(2)}` : '$0.00';
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç —Å–∏–º–≤–æ–ª —Ç–µ–∫—É—â–∏–º Active Symbol –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–ù–ï PRIMARY_SYMBOL!)
                            const isCurrentDisplaySymbol = currentDisplaySymbol && symbol === currentDisplaySymbol;
                            const symbolStyle = isCurrentDisplaySymbol ? 
                                'padding: 10px; background: rgba(0, 255, 136, 0.1); border-left: 3px solid #00ff88;' : 
                                'padding: 10px;';
                            
                            // –î–µ–ª–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º - –∫–ª–∏–∫ –º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û Active Symbol –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                            const symbolLink = `<a href="#" onclick="switchPrimarySymbol('${symbol}'); return false;" 
                                style="color: ${isCurrentDisplaySymbol ? '#00ff88' : '#4a9eff'}; text-decoration: none; font-weight: bold; cursor: pointer; 
                                transition: color 0.2s; padding: 2px 6px; border-radius: 3px; display: inline-block;"
                                onmouseover="this.style.color='#00ff88'; this.style.background='rgba(0, 255, 136, 0.1)';" 
                                onmouseout="this.style.color='${isCurrentDisplaySymbol ? '#00ff88' : '#4a9eff'}'; this.style.background='transparent';"
                                title="Click to switch chart view to ${symbol} (does not change PRIMARY_SYMBOL)">${symbol}${isCurrentDisplaySymbol ? ' ‚≠ê' : ''}</a>`;
                            
                            html += `<tr style="border-bottom: 1px solid #2a2a2a;">
                                <td style="${symbolStyle}">${symbolLink}</td>
                                <td style="padding: 10px;">
                                    <span class="status-indicator ${status.is_running ? 'running' : 'stopped'}"></span>
                                    ${status.status || (status.is_running ? 'Running' : 'Stopped')}
                                </td>
                                <td style="padding: 10px; font-size: 0.9em; color: #aaa;">${positionInfo}</td>
                                <td class="${pnlClass}" style="padding: 10px; font-weight: bold;">${pnlDisplay}</td>
                            </tr>`;
                        }
                        
                        html += '</tbody></table>';
                        return html;
                    };
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–ù–ï PRIMARY_SYMBOL!)
                    // –≠—Ç–æ —Å–∏–º–≤–æ–ª, –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ
                    const topSelect = document.getElementById('primary-symbol-select');
                    const currentDisplaySymbol = (topSelect && topSelect.value) || window.currentSymbol || data.account?.primary_symbol || data.account?.symbol || null;
                    const statusHtml = generateStatusTable(data.symbols_status, currentDisplaySymbol);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ Symbols
                    const statusList = document.getElementById('symbols-status-list');
                    if (statusList) {
                        statusList.innerHTML = statusHtml;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ
                    const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                    if (dashboardStatusList) {
                        dashboardStatusList.innerHTML = statusHtml;
                    }
                } else {
                    // –ï—Å–ª–∏ symbols_status –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ bot_status
                    const botStatus = data.bot_status || {};
                    const activeSymbols = data.account?.active_symbols || ['BTCUSDT'];
                    const noDataMsg = activeSymbols.length > 0 ? 
                        '<p style="color: #aaa; font-size: 0.9em;">Bot status: ' + (botStatus.current_status || 'Stopped') + '</p>' :
                        '<p style="color: #666;">No active symbols configured</p>';
                    
                    const statusList = document.getElementById('symbols-status-list');
                    if (statusList) {
                        statusList.innerHTML = noDataMsg;
                    }
                    
                    const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                    if (dashboardStatusList) {
                        dashboardStatusList.innerHTML = noDataMsg;
                    }
                }
            } catch (error) {
                // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ controller –ø—Ä–∏ –æ—à–∏–±–∫–µ
                currentSymbolsStatusController = null;
                
                // AbortError - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å–∏–º–≤–æ–ª–∞)
                if (error.name === 'AbortError') {
                    console.log('[UI] Symbols status request was aborted (this is normal when switching symbols or timeout)');
                    return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
                }
                
                console.error('[UI] Error loading symbols status:', error);
                console.error('[UI] Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                });
                
                // –†–∞–∑–ª–∏—á–∞–µ–º —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
                let errorMsg = '';
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    errorMsg = '<p style="color: #ff4444;">üåê Network error: Server unavailable or not responding</p><p style="color: #aaa; font-size: 0.85em; margin-top: 5px;">Please check if the server is running</p>';
                    console.warn('[UI] Failed to fetch - server may be down or unreachable');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
                    fetch('/api/status', { method: 'GET', credentials: 'same-origin' })
                        .then(response => {
                            if (response.ok) {
                                console.log('[UI] Server is reachable now, retrying...');
                                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                                setTimeout(loadSymbolsStatus, 1000);
                            }
                        })
                        .catch(checkError => {
                            console.error('[UI] Server check failed:', checkError);
                        });
                } else {
                    errorMsg = `<p style="color: #ff4444;">‚ùå Error loading status: ${error.message}</p>`;
                }
                
                const statusList = document.getElementById('symbols-status-list');
                if (statusList) {
                    statusList.innerHTML = errorMsg;
                }
                
                const dashboardStatusList = document.getElementById('dashboard-symbols-status-list');
                if (dashboardStatusList) {
                    dashboardStatusList.innerHTML = errorMsg;
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–ù–ï –º–µ–Ω—è–µ—Ç PRIMARY_SYMBOL!)
        async function switchPrimarySymbol(symbol) {
            try {
                console.log(`[UI] Switching display symbol to ${symbol} (for chart view only, NOT changing PRIMARY_SYMBOL)`);
                
                // –í–ê–ñ–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û —Å–∏–º–≤–æ–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                // –û–Ω–∞ –ù–ï –º–µ–Ω—è–µ—Ç PRIMARY_SYMBOL - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ Symbols
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é changePrimarySymbol, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –º–µ–Ω—è–µ—Ç PRIMARY_SYMBOL
                await changePrimarySymbol(symbol);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
                await loadSymbolsStatus();
            } catch (error) {
                console.error('[UI] Error switching display symbol:', error);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
                await loadSymbolsStatus();
            }
        }
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        let currentSymbol = null;
        
        async function loadChart() {
            if (typeof window.loadChartLW === 'function') {
                return await window.loadChartLW();
            }
        }
        
        // Strategy Selection Functions (Per Symbol)
        async function loadStrategySettingsForSymbol() {
            const symbolSelect = document.getElementById('strategy-symbol-select');
            if (!symbolSelect) return;
            
            const symbol = symbolSelect.value;
            try {
                const response = await fetch(`/api/settings/symbol/${symbol}`);
                const data = await response.json();
                
                if (data.success && data.settings) {
                    const settings = data.settings;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
                    const trendCheckbox = document.getElementById('enable-trend-strategy');
                    const flatCheckbox = document.getElementById('enable-flat-strategy');
                    const mlCheckbox = document.getElementById('enable-ml-strategy');
                    const momentumCheckbox = document.getElementById('enable-momentum-strategy');
                    const smcCheckbox = document.getElementById('smcCheckbox');
                    const ictCheckbox = document.getElementById('enable-ict-strategy');
                    const liquidationHunterCheckbox = document.getElementById('enable-liquidation-hunter-strategy');
                    const zscoreCheckbox = document.getElementById('enable-zscore-strategy');
                    const vboCheckbox = document.getElementById('enable-vbo-strategy');
                    const amtOfCheckbox = document.getElementById('enable-amt-of-strategy');
                    const strategyPrioritySelect = document.getElementById('strategy-priority-select');
                    
                    if (trendCheckbox) trendCheckbox.checked = settings.enable_trend_strategy || false;
                    if (flatCheckbox) flatCheckbox.checked = settings.enable_flat_strategy || false;
                    if (mlCheckbox) mlCheckbox.checked = settings.enable_ml_strategy || false;
                    if (momentumCheckbox) momentumCheckbox.checked = settings.enable_momentum_strategy || false;
                    if (smcCheckbox) smcCheckbox.checked = settings.enable_smc_strategy || false;
                    if (ictCheckbox) ictCheckbox.checked = settings.enable_ict_strategy || false;
                    if (liquidationHunterCheckbox) liquidationHunterCheckbox.checked = settings.enable_liquidation_hunter_strategy || false;
                    if (zscoreCheckbox) zscoreCheckbox.checked = settings.enable_zscore_strategy || false;
                    if (vboCheckbox) vboCheckbox.checked = settings.enable_vbo_strategy || false;
                    if (amtOfCheckbox) amtOfCheckbox.checked = settings.enable_amt_of_strategy || false;
                    if (strategyPrioritySelect) strategyPrioritySelect.value = settings.strategy_priority || 'trend';
                }
            } catch (error) {
                console.error('Error loading strategy settings for symbol:', error);
            }
        }
        
        async function copyStrategySettingsToAllSymbols() {
            const symbolSelect = document.getElementById('strategy-symbol-select');
            if (!symbolSelect) return;
            
            const currentSymbol = symbolSelect.value;
            if (!confirm(`–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è ${currentSymbol} –Ω–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã (BTCUSDT, ETHUSDT, SOLUSDT)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/settings/symbol/${currentSymbol}/copy-to-all`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è ${currentSymbol} —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤—Å–µ –ø–∞—Ä—ã!`);
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('Error copying strategy settings:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`);
            }
        }
        
        let optimizationPollInterval = null;
        
        async function checkOptimizationStatus() {
            try {
                const response = await fetch('/api/strategy/optimize/status');
                const status = await response.json();
                
                const btn = document.getElementById('optimize-btn');
                const statusDiv = document.getElementById('optimize-status');
                const resultsDiv = document.getElementById('optimize-results');
                
                if (!statusDiv) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (status.running) {
                    const progress = status.total > 0 ? Math.round((status.progress / status.total) * 100) : 0;
                    statusDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <span style="color: #00d4ff;">üîÑ ${status.current_test || '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...'}</span>
                        </div>
                        <div style="width: 100%; background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 20px;">
                            <div style="width: ${progress}%; background: linear-gradient(90deg, #00d4ff 0%, #0099cc 100%); height: 100%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: #000; font-size: 0.8em; font-weight: bold;">
                                ${progress}%
                            </div>
                        </div>
                        <div style="margin-top: 5px; color: #888; font-size: 0.9em;">
                            –ü—Ä–æ–≥—Ä–µ—Å—Å: ${status.progress} / ${status.total}
                        </div>
                    `;
                } else if (status.error) {
                    // –û—à–∏–±–∫–∞
                    statusDiv.innerHTML = `<span style="color: #ff4444;">‚ùå –û—à–∏–±–∫–∞: ${status.error}</span>`;
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π';
                    }
                    if (optimizationPollInterval) {
                        clearInterval(optimizationPollInterval);
                        optimizationPollInterval = null;
                    }
                    alert(`‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: ${status.error}`);
                } else if (status.result) {
                    // –ó–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
                    statusDiv.innerHTML = '<span style="color: #00ff88;">‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</span>';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    let resultsHtml = '<div style="margin-top: 20px; padding: 15px; background: #1a2a2a; border-radius: 8px;">';
                    resultsHtml += '<h4 style="color: #00d4ff; margin-top: 0;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</h4>';
                    
                    const optimizationResult = status.result.optimization_result || {};
                    const recommendations = optimizationResult.recommendations || {};
                    const appliedSettings = status.result.applied_settings || {};
                    
                    for (const [symbol, rec] of Object.entries(recommendations)) {
                        const profitable = rec.profitable_strategies || [];
                        const settings = rec.settings || {};
                        
                        resultsHtml += `<div style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 6px; border-left: 4px solid #00d4ff;">`;
                        resultsHtml += `<h5 style="color: #00d4ff; margin-top: 0;">${symbol}</h5>`;
                        
                        if (profitable.length > 0) {
                            resultsHtml += `<p style="color: #aaa; margin-bottom: 10px;">–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: <strong style="color: #00ff88;">${profitable.length}</strong></p>`;
                            resultsHtml += `<p style="color: #aaa; margin-bottom: 10px;">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: <strong style="color: #00d4ff;">${settings.strategy_priority?.toUpperCase() || 'HYBRID'}</strong></p>`;
                            
                            resultsHtml += `<div style="margin-top: 10px;"><strong style="color: #aaa;">–í–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:</strong></div>`;
                            resultsHtml += `<ul style="margin-top: 5px; padding-left: 20px;">`;
                            for (const strat of profitable) {
                                resultsHtml += `<li style="color: #00ff88; margin-bottom: 5px;">`;
                                resultsHtml += `${strat.strategy.toUpperCase()}: PnL <strong>${strat.pnl > 0 ? '+' : ''}${strat.pnl.toFixed(2)}</strong> USDT, `;
                                resultsHtml += `WR <strong>${strat.win_rate.toFixed(1)}%</strong>, `;
                                resultsHtml += `<strong>${strat.total_trades}</strong> —Å–¥–µ–ª–æ–∫`;
                                resultsHtml += `</li>`;
                            }
                            resultsHtml += `</ul>`;
                        } else {
                            resultsHtml += `<p style="color: #ff4444;">‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è ${symbol}</p>`;
                        }
                        
                        resultsHtml += `</div>`;
                    }
                    
                    resultsHtml += '</div>';
                    resultsDiv.innerHTML = resultsHtml;
                    resultsDiv.style.display = 'block';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ UI
                    setTimeout(() => {
                        if (typeof loadStrategySettingsForSymbol !== 'undefined') {
                            loadStrategySettingsForSymbol();
                        }
                        if (typeof loadStrategyStats !== 'undefined') {
                            loadStrategyStats();
                        }
                    }, 1000);
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π';
                    }
                    
                    if (optimizationPollInterval) {
                        clearInterval(optimizationPollInterval);
                        optimizationPollInterval = null;
                    }
                    
                    alert(`‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä.\n\n${status.result.message || ''}`);
                }
            } catch (error) {
                console.error('Error checking optimization status:', error);
            }
        }
        
        async function optimizeStrategies() {
            const btn = document.getElementById('optimize-btn');
            const statusDiv = document.getElementById('optimize-status');
            const resultsDiv = document.getElementById('optimize-results');
            
            if (!btn || !statusDiv) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const days = parseInt(document.getElementById('optimize-days')?.value || '30');
            const minPnl = parseFloat(document.getElementById('optimize-min-pnl')?.value || '0.0');
            const minWinRate = parseFloat(document.getElementById('optimize-min-win-rate')?.value || '0.0');
            
            if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π?\n\n–ü–µ—Ä–∏–æ–¥: ${days} –¥–Ω–µ–π\n–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π PnL: ${minPnl} USDT\n–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Win Rate: ${minWinRate}%\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...`)) {
                return;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π polling, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if (optimizationPollInterval) {
                clearInterval(optimizationPollInterval);
                optimizationPollInterval = null;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            btn.disabled = true;
            btn.textContent = '‚è≥ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...';
            statusDiv.innerHTML = '<span style="color: #00d4ff;">üîÑ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</span>';
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            
            try {
                console.log('[optimizeStrategies] Sending request to /api/strategy/optimize');
                const requestData = {
                    days: days,
                    min_pnl: minPnl,
                    min_win_rate: minWinRate,
                    auto_apply: true
                };
                console.log('[optimizeStrategies] Request data:', requestData);
                
                const response = await fetch('/api/strategy/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[optimizeStrategies] Response status:', response.status);
                console.log('[optimizeStrategies] Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[optimizeStrategies] Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('[optimizeStrategies] Response data:', result);
                
                if (result.success) {
                    // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                    checkOptimizationStatus(); // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
                    optimizationPollInterval = setInterval(checkOptimizationStatus, 2000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #ff4444;">‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π';
                    alert(`‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('[optimizeStrategies] Error:', error);
                console.error('[optimizeStrategies] Error stack:', error.stack);
                statusDiv.innerHTML = `<span style="color: #ff4444;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
                btn.disabled = false;
                btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–π';
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: ${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.`);
            }
        }
        window.optimizeStrategies = optimizeStrategies; // Make global
        
        async function loadStrategySelection() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.app) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                    const trendCheckbox = document.getElementById('enable-trend-strategy');
                    const flatCheckbox = document.getElementById('enable-flat-strategy');
                    const mlCheckbox = document.getElementById('enable-ml-strategy');
                    const momentumCheckbox = document.getElementById('enable-momentum-strategy');
                    const smcCheckbox = document.getElementById('smcCheckbox');
                    const ictCheckbox = document.getElementById('enable-ict-strategy');
                    const liquidationHunterCheckbox = document.getElementById('enable-liquidation-hunter-strategy');
                    const zscoreCheckbox = document.getElementById('enable-zscore-strategy');
                    const vboCheckbox = document.getElementById('enable-vbo-strategy');
                    
                    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ boolean
                    const toBool = (val) => {
                        if (typeof val === 'boolean') return val;
                        if (typeof val === 'string') {
                            const lower = val.toLowerCase().trim();
                            return lower === 'true' || lower === '1' || lower === 'yes';
                        }
                        return Boolean(val);
                    };
                    
                    if (trendCheckbox) {
                        trendCheckbox.checked = toBool(data.app.enable_trend_strategy);
                    }
                    if (flatCheckbox) {
                        flatCheckbox.checked = toBool(data.app.enable_flat_strategy);
                    }
                    if (mlCheckbox) {
                        mlCheckbox.checked = toBool(data.app.enable_ml_strategy);
                    }
                    if (momentumCheckbox) {
                        momentumCheckbox.checked = toBool(data.app.enable_momentum_strategy);
                    }
                    if (smcCheckbox) {
                        smcCheckbox.checked = toBool(data.app.enable_smc_strategy);
                    }
                    if (ictCheckbox) {
                        ictCheckbox.checked = toBool(data.app.enable_ict_strategy);
                    }
                    if (liquidationHunterCheckbox) {
                        liquidationHunterCheckbox.checked = toBool(data.app.enable_liquidation_hunter_strategy);
                    }
                    if (zscoreCheckbox) {
                        zscoreCheckbox.checked = toBool(data.app.enable_zscore_strategy);
                    }
                    if (vboCheckbox) {
                        vboCheckbox.checked = toBool(data.app.enable_vbo_strategy);
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä—É
                    const symbolSelect = document.getElementById('symbol-select');
                    if (symbolSelect) {
                        if (data.app.symbol) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å –≤ –æ–ø—Ü–∏—è—Ö
                            const optionExists = Array.from(symbolSelect.options).some(opt => opt.value === data.app.symbol);
                            if (optionExists) {
                                symbolSelect.value = data.app.symbol;
                            }
                        }
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä—É –¥–ª—è ML
                    const mlSymbolSelect = document.getElementById('ml-symbol-select');
                    if (mlSymbolSelect && data.app.symbol) {
                        mlSymbolSelect.value = data.app.symbol;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –ø–∞—Ä—ã)
                    const strategyPrioritySelect = document.getElementById('strategy-priority-select');
                    if (strategyPrioritySelect && data.app.strategy_priority) {
                        strategyPrioritySelect.value = data.app.strategy_priority;
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞—Ä—ã
                    const strategySymbolSelect = document.getElementById('strategy-symbol-select');
                    if (strategySymbolSelect) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ primary_symbol –∏–ª–∏ symbol
                        const defaultSymbol = data.app.primary_symbol || data.app.symbol || 'BTCUSDT';
                        if (Array.from(strategySymbolSelect.options).some(opt => opt.value === defaultSymbol)) {
                            strategySymbolSelect.value = defaultSymbol;
                        }
                        loadStrategySettingsForSymbol();
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
                    const modelTypeForAllSelect = document.getElementById('ml-model-type-for-all');
                    if (modelTypeForAllSelect && data.app.ml_model_type_for_all !== undefined) {
                        modelTypeForAllSelect.value = data.app.ml_model_type_for_all || "";
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    if (data.app.ml_model_path) {
                        setTimeout(loadMLModelInfo, 500);
                    }
                }
            } catch (error) {
                console.error('Error loading strategy selection:', error);
            }
        }
        
        async function loadStrategyStats() {
            try {
                const response = await fetch('/api/strategy/stats/all');
                const data = await response.json();
                
                const container = document.getElementById('strategy-stats-container');
                if (!container) {
                    console.error('strategy-stats-container not found');
                    return;
                }
                
                const formatNumber = (num) => {
                    if (num === null || num === undefined) return '0.00';
                    return typeof num === 'number' ? num.toFixed(2) : num;
                };
                
                const formatPercent = (num) => {
                    if (num === null || num === undefined) return '0.00%';
                    return typeof num === 'number' ? (num.toFixed(2) + '%') : num;
                };
                
                let html = '';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Trend —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const trendStats = data.trend || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%); border: 1px solid rgba(0, 255, 136, 0.3);">
                        <h3 style="color: #00ff88; margin-bottom: 15px;">üìà Trend Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${trendStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(trendStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(trendStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${trendStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${trendStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(trendStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(trendStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(trendStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(trendStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(trendStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Flat —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const flatStats = data.flat || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 170, 0, 0.1) 0%, rgba(255, 170, 0, 0.05) 100%); border: 1px solid rgba(255, 170, 0, 0.3);">
                        <h3 style="color: #ffaa00; margin-bottom: 15px;">üìä Flat Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${flatStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(flatStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(flatStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${flatStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${flatStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(flatStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(flatStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(flatStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(flatStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(flatStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ML —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const mlStats = data.ml || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">ü§ñ ML Strategy</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${mlStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(mlStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(mlStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${mlStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${mlStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(mlStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(mlStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(mlStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(mlStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(mlStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Momentum —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const momentumStats = data.momentum || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">‚ö° Momentum Breakout</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${momentumStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(momentumStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(momentumStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(momentumStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(momentumStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(momentumStats.avg_pnl || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è SMC —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const smcStats = data.smc || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(153, 51, 255, 0.1) 0%, rgba(153, 51, 255, 0.05) 100%); border: 1px solid rgba(153, 51, 255, 0.3);">
                        <h3 style="color: #9933ff; margin-bottom: 15px;">üü£ Smart Money Concepts</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${smcStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(smcStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(smcStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${smcStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${smcStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(smcStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(smcStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(smcStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(smcStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(smcStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è ICT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const ictStats = data.ict || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%); border: 1px solid rgba(255, 107, 107, 0.3);">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">üî¥ ICT Silver Bullet</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${ictStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(ictStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(ictStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${ictStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${ictStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(ictStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(ictStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(ictStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(ictStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(ictStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Liquidation Hunter —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const liqHunterStats = data.liquidation_hunter || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%); border: 1px solid rgba(255, 149, 0, 0.3);">
                        <h3 style="color: #ff9500; margin-bottom: 15px;">üü† Liquidation Hunter</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${liqHunterStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(liqHunterStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(liqHunterStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${liqHunterStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${liqHunterStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(liqHunterStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(liqHunterStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(liqHunterStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(liqHunterStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(liqHunterStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è Z-Score —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const zscoreStats = data.zscore || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(0, 255, 170, 0.1) 0%, rgba(0, 255, 170, 0.05) 100%); border: 1px solid rgba(0, 255, 170, 0.3);">
                        <h3 style="color: #00ffaa; margin-bottom: 15px;">üü¢ Z-Score</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${zscoreStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(zscoreStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(zscoreStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${zscoreStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${zscoreStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(zscoreStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(zscoreStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(zscoreStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(zscoreStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(zscoreStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è VBO —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                const vboStats = data.vbo || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(255, 0, 255, 0.1) 0%, rgba(255, 0, 255, 0.05) 100%); border: 1px solid rgba(255, 0, 255, 0.3);">
                        <h3 style="color: #ff00ff; margin-bottom: 15px;">üü£ VBO (Volatility Breakout)</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${vboStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(vboStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(vboStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${vboStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${vboStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(vboStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(vboStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(vboStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(vboStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(vboStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const allStats = data.all || {};
                html += `
                    <div class="card" style="background: linear-gradient(135deg, rgba(170, 170, 170, 0.1) 0%, rgba(170, 170, 170, 0.05) 100%); border: 1px solid rgba(170, 170, 170, 0.3);">
                        <h3 style="color: #aaa; margin-bottom: 15px;">üìä All Strategies Combined</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Trades:</span>
                            <span class="stat-value">${allStats.total_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Win Rate:</span>
                            <span class="stat-value" style="color: ${(allStats.win_rate || 0) >= 50 ? '#00ff88' : '#ff4444'}">${formatPercent(allStats.win_rate || 0)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Winning Trades:</span>
                            <span class="stat-value" style="color: #00ff88">${allStats.winning_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Losing Trades:</span>
                            <span class="stat-value" style="color: #ff4444">${allStats.losing_trades || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total PnL:</span>
                            <span class="stat-value" style="color: ${(allStats.total_pnl || 0) >= 0 ? '#00ff88' : '#ff4444'}">${formatNumber(allStats.total_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg PnL:</span>
                            <span class="stat-value">${formatNumber(allStats.avg_pnl || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Win:</span>
                            <span class="stat-value" style="color: #00ff88">${formatNumber(allStats.avg_win || 0)} USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Loss:</span>
                            <span class="stat-value" style="color: #ff4444">${formatNumber(allStats.avg_loss || 0)} USDT</span>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading strategy stats:', error);
                const container = document.getElementById('strategy-stats-container');
                if (container) {
                    container.innerHTML = '<p style="color: #ff4444; padding: 20px;">Error loading statistics</p>';
                }
            }
        }
        
        async function saveStrategySelection() {
            try {
                const symbolSelect = document.getElementById('strategy-symbol-select');
                if (!symbolSelect) {
                    alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤—ã–±–æ—Ä –ø–∞—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
                    return;
                }
                
                const selectedSymbol = symbolSelect.value;
                
                const trendCheckbox = document.getElementById('enable-trend-strategy');
                const flatCheckbox = document.getElementById('enable-flat-strategy');
                const mlCheckbox = document.getElementById('enable-ml-strategy');
                const momentumCheckbox = document.getElementById('enable-momentum-strategy');
                const smcCheckbox = document.getElementById('smcCheckbox');
                const ictCheckbox = document.getElementById('enable-ict-strategy');
                const liquidationHunterCheckbox = document.getElementById('enable-liquidation-hunter-strategy');
                const zscoreCheckbox = document.getElementById('enable-zscore-strategy');
                const vboCheckbox = document.getElementById('enable-vbo-strategy');
                const amtOfCheckbox = document.getElementById('enable-amt-of-strategy');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const missingElements = [];
                if (!trendCheckbox) missingElements.push('enable-trend-strategy');
                if (!flatCheckbox) missingElements.push('enable-flat-strategy');
                if (!mlCheckbox) missingElements.push('enable-ml-strategy');
                
                if (missingElements.length > 0) {
                    console.error('[saveStrategySelection] Missing elements:', missingElements);
                    alert('Error: Could not find strategy selection elements:\n' + missingElements.join(', ') + '\n\nPlease refresh the page and try again.');
                    return;
                }
                
                const strategyPrioritySelect = document.getElementById('strategy-priority-select');
                const selectedPriority = strategyPrioritySelect ? strategyPrioritySelect.value : 'trend';
                
                const data = {
                        enable_trend_strategy: trendCheckbox.checked,
                        enable_flat_strategy: flatCheckbox.checked,
                        enable_ml_strategy: mlCheckbox.checked,
                    enable_momentum_strategy: momentumCheckbox ? momentumCheckbox.checked : false,
                    enable_liquidity_sweep_strategy: false,  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
                    enable_smc_strategy: smcCheckbox ? smcCheckbox.checked : false,
                    enable_ict_strategy: ictCheckbox ? ictCheckbox.checked : false,
                    enable_liquidation_hunter_strategy: liquidationHunterCheckbox ? liquidationHunterCheckbox.checked : false,
                    enable_zscore_strategy: zscoreCheckbox ? zscoreCheckbox.checked : false,
                    enable_vbo_strategy: vboCheckbox ? vboCheckbox.checked : false,
                    enable_amt_of_strategy: amtOfCheckbox ? amtOfCheckbox.checked : false,
                        strategy_priority: selectedPriority
                };
                
                const response = await fetch(`/api/settings/symbol/${selectedSymbol}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const priorityText = {
                        'trend': 'Trend Strategy Priority',
                        'flat': 'Flat Strategy Priority',
                        'ml': 'ML Strategy Priority',
                        'momentum': 'Momentum Breakout Priority',
                        'smc': 'Smart Money Concepts Priority',
                        'ict': 'ICT Silver Bullet Priority',
                        'liquidation_hunter': 'Liquidation Hunter Priority',
                        'zscore': 'Z-Score Priority',
                        'vbo': 'VBO Priority',
                        'hybrid': 'Hybrid (Latest Signal)',
                        'confluence': 'Confluence (Double Confirmation)'
                    };
                    const enabledStrategies = [];
                    if (trendCheckbox.checked) enabledStrategies.push('Trend');
                    if (flatCheckbox.checked) enabledStrategies.push('Flat');
                    if (mlCheckbox.checked) enabledStrategies.push('ML');
                    if (momentumCheckbox && momentumCheckbox.checked) enabledStrategies.push('Momentum');
                    if (smcCheckbox && smcCheckbox.checked) enabledStrategies.push('Smart Money Concepts');
                    if (ictCheckbox && ictCheckbox.checked) enabledStrategies.push('ICT Silver Bullet');
                    if (liquidationHunterCheckbox && liquidationHunterCheckbox.checked) enabledStrategies.push('Liquidation Hunter');
                    if (zscoreCheckbox && zscoreCheckbox.checked) enabledStrategies.push('Z-Score');
                    if (vboCheckbox && vboCheckbox.checked) enabledStrategies.push('VBO');
                    
                    alert(`‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è ${selectedSymbol} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n` +
                          `–í–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ${enabledStrategies.length > 0 ? enabledStrategies.join(', ') : '–ù–µ—Ç'}\n` +
                          `–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ${priorityText[selectedPriority] || selectedPriority}\n\n` +
                          '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞—Ä—ã. –ï—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ.');
                    
                    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (result.settings) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                        if (trendCheckbox && result.settings.enable_trend_strategy !== undefined) {
                            trendCheckbox.checked = result.settings.enable_trend_strategy;
                        }
                        if (flatCheckbox && result.settings.enable_flat_strategy !== undefined) {
                            flatCheckbox.checked = result.settings.enable_flat_strategy;
                        }
                        if (mlCheckbox && result.settings.enable_ml_strategy !== undefined) {
                            mlCheckbox.checked = result.settings.enable_ml_strategy;
                        }
                        if (momentumCheckbox && result.settings.enable_momentum_strategy !== undefined) {
                            momentumCheckbox.checked = result.settings.enable_momentum_strategy;
                        }
                        const smcCheckbox = document.getElementById('smcCheckbox');
                        if (smcCheckbox && result.settings.enable_smc_strategy !== undefined) {
                            smcCheckbox.checked = result.settings.enable_smc_strategy;
                        }
                        const ictCheckbox = document.getElementById('enable-ict-strategy');
                        if (ictCheckbox && result.settings.enable_ict_strategy !== undefined) {
                            ictCheckbox.checked = result.settings.enable_ict_strategy;
                        }
                        const liquidationHunterCheckbox = document.getElementById('enable-liquidation-hunter-strategy');
                        if (liquidationHunterCheckbox && result.settings.enable_liquidation_hunter_strategy !== undefined) {
                            liquidationHunterCheckbox.checked = result.settings.enable_liquidation_hunter_strategy;
                        }
                        const zscoreCheckbox = document.getElementById('enable-zscore-strategy');
                        if (zscoreCheckbox && result.settings.enable_zscore_strategy !== undefined) {
                            zscoreCheckbox.checked = result.settings.enable_zscore_strategy;
                        }
                        const vboCheckbox = document.getElementById('enable-vbo-strategy');
                        if (vboCheckbox && result.settings.enable_vbo_strategy !== undefined) {
                            vboCheckbox.checked = result.settings.enable_vbo_strategy;
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                        if (strategyPrioritySelect && result.settings.strategy_priority) {
                            strategyPrioritySelect.value = result.settings.strategy_priority;
                        }
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞—Ä—ã
                    setTimeout(() => {
                        loadStrategySettingsForSymbol();
                    }, 500);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                    if (typeof loadChart !== 'undefined') {
                        setTimeout(() => {
                            loadChartLW();
                        }, 1200);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–∏–º–≤–æ–ª
                    if (typeof loadMLModelInfo !== 'undefined') {
                        setTimeout(loadMLModelInfo, 1000);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                    if (typeof loadStrategyStats !== 'undefined') {
                        setTimeout(loadStrategyStats, 1000);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
                    if (typeof updateStatus !== 'undefined') {
                        setTimeout(updateStatus, 500);
                    }
                } else {
                    console.error('[saveStrategySelection] Error response:', result);
                    alert('‚ùå Error saving settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving strategy selection:', error);
                alert('‚ùå Error saving settings: ' + error.message);
            }
        }
        window.saveStrategySelection = saveStrategySelection; // Make global
        
        async function loadAllPairsModelsInfo() {
            try {
                const response = await fetch('/api/ml/models/all-pairs');
                const data = await response.json();
                
                const contentDiv = document.getElementById('all-pairs-models-content');
                if (!contentDiv) return;
                
                if (data.error) {
                    contentDiv.innerHTML = `<p style="color: #ff4444;">Error: ${data.error}</p>`;
                    return;
                }
                
                const models = data.models || {};
                const modelTypePreference = data.model_type_preference || "auto";
                
                let html = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏
                html += `<div style="margin-bottom: 15px; padding: 10px; background: #2a2a2a; border-radius: 4px;">`;
                html += `<span style="color: #aaa;">Model Type Preference: </span>`;
                html += `<span style="color: #00d4ff; font-weight: bold;">${modelTypePreference === "auto" ? "Auto (Ensemble > RF > XGB)" : modelTypePreference.toUpperCase()}</span>`;
                html += `</div>`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª—è—Ö –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
                const symbols = ["BTCUSDT", "ETHUSDT", "SOLUSDT"];
                for (const symbol of symbols) {
                    const modelInfo = models[symbol] || {};
                    const found = modelInfo.found || false;
                    
                    html += `<div style="margin-bottom: 15px; padding: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                    html += `<span style="color: #e0e0e0; font-weight: bold; font-size: 1.1em;">${symbol}</span>`;
                    
                    if (found) {
                        const metadata = modelInfo.metadata || {};
                        const modelType = metadata.model_type || "unknown";
                        const modelName = modelInfo.model_name || "Unknown";
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let modelTypeDisplay = modelType;
                        let modelTypeIcon = "üìä";
                        if (modelType.includes("ensemble")) {
                            modelTypeDisplay = "Ensemble (RF + XGBoost)";
                            modelTypeIcon = "üéØ";
                        } else if (modelType === "rf") {
                            modelTypeDisplay = "Random Forest";
                            modelTypeIcon = "üå≤";
                        } else if (modelType === "xgb") {
                            modelTypeDisplay = "XGBoost";
                            modelTypeIcon = "‚ö°";
                        }
                        
                        html += `<span style="color: #00ff88; font-size: 0.9em;">${modelTypeIcon} ${modelTypeDisplay}</span>`;
                        html += `</div>`;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                        if (metadata.accuracy !== undefined || metadata.cv_mean !== undefined) {
                            html += `<div style="margin-top: 8px; font-size: 0.9em;">`;
                            if (metadata.accuracy !== undefined) {
                                html += `<span style="color: #aaa;">Accuracy: </span>`;
                                html += `<span style="color: #00d4ff;">${((metadata.accuracy || 0) * 100).toFixed(2)}%</span>`;
                            }
                            if (metadata.cv_mean !== undefined) {
                                if (metadata.accuracy !== undefined) html += `<span style="color: #666;"> | </span>`;
                                html += `<span style="color: #aaa;">CV: </span>`;
                                html += `<span style="color: #00d4ff;">${((metadata.cv_mean || 0) * 100).toFixed(2)}%</span>`;
                                if (metadata.cv_std !== undefined) {
                                    html += `<span style="color: #666;"> ¬± ${((metadata.cv_std || 0) * 100).toFixed(2)}%</span>`;
                                }
                            }
                            html += `</div>`;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –æ–±—É—á–µ–Ω–∏—è
                        if (metadata.trained_at) {
                            try {
                                const trainedDate = new Date(metadata.trained_at);
                                const daysAgo = Math.floor((Date.now() - trainedDate.getTime()) / (1000 * 60 * 60 * 24));
                                html += `<div style="margin-top: 5px; font-size: 0.85em; color: #888;">`;
                                html += `Trained: ${trainedDate.toLocaleDateString()} (${daysAgo} days ago)`;
                                html += `</div>`;
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã
                            }
                        }
                    } else {
                        html += `<span style="color: #ff4444; font-size: 0.9em;">‚ùå Model not found</span>`;
                        html += `</div>`;
                        if (modelInfo.error) {
                            html += `<div style="margin-top: 5px; font-size: 0.85em; color: #888;">${modelInfo.error}</div>`;
                        }
                    }
                    
                    html += `</div>`;
                }
                
                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading all pairs models info:', error);
                const contentDiv = document.getElementById('all-pairs-models-content');
                if (contentDiv) {
                    contentDiv.innerHTML = `<p style="color: #ff4444;">Error loading models info: ${error.message}</p>`;
                }
            }
        }
        
        window.loadAllPairsModelsInfo = loadAllPairsModelsInfo;
        
        async function loadMLModelInfo() {
            try {
                const response = await fetch('/api/ml/model/info');
                const mlInfoDiv = document.getElementById('ml-model-info');
                if (!mlInfoDiv) return;
                
                if (response.status === 404) {
                    mlInfoDiv.innerHTML = '<p style="color: #aaa;">No ML model configured</p>';
                    return;
                }
                
                const data = await response.json();
                if (data.error) {
                    mlInfoDiv.innerHTML = `<p style="color: #ff4444;">Error: ${data.error}</p>`;
                    return;
                }
                
                const metadata = data.metadata || {};
                const stats = data.stats || {};
                const shouldRetrain = data.should_retrain || false;
                const retrainReasons = data.retrain_reasons || [];
                const isEnsemble = data.is_ensemble || false;
                const ensembleMetrics = data.ensemble_metrics || {};
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const modelType = metadata.model_type || 'Unknown';
                const modelTypeDisplay = modelType.includes('Ensemble') ? modelType : 
                    (modelType === 'rf' || modelType === 'random_forest' ? 'Random Forest' :
                    (modelType === 'xgb' || modelType === 'xgboost' ? 'XGBoost' : modelType));
                
                let html = '<div style="margin-bottom: 20px;">';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ç–∏–ø–æ–º –º–æ–¥–µ–ª–∏
                html += `
                    <div style="padding: 15px; background: ${isEnsemble ? '#1a3a1a' : '#1a1a1a'}; border: 2px solid ${isEnsemble ? '#00ff88' : '#333'}; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: ${isEnsemble ? '#00ff88' : '#00d4ff'}; margin: 0 0 10px 0; font-size: 1.3em;">
                            ${isEnsemble ? 'üéØ' : 'üìä'} Model Type: <span style="font-weight: bold;">${modelTypeDisplay}</span>
                        </h3>
                        ${isEnsemble ? '<p style="color: #aaa; margin: 0; font-size: 0.9em;">Ensemble combines Random Forest and XGBoost for better performance</p>' : ''}
                    </div>
                `;
                
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                
                if (metadata.trained_at) {
                    const trainedDate = new Date(metadata.trained_at);
                    const daysAgo = Math.floor((Date.now() - trainedDate.getTime()) / (1000 * 60 * 60 * 24));
                    html += `
                        <div class="stat-item">
                            <span class="stat-label">Trained At:</span>
                            <span class="stat-value">${trainedDate.toLocaleString()}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Days Ago:</span>
                            <span class="stat-value">${daysAgo}</span>
                        </div>
                    `;
                }
                
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Symbol:</span>
                        <span class="stat-value">${metadata.symbol || 'N/A'}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Interval:</span>
                        <span class="stat-value">${metadata.interval || '15'}m</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Training Accuracy:</span>
                        <span class="stat-value">${((metadata.accuracy || 0) * 100).toFixed(2)}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CV Accuracy:</span>
                        <span class="stat-value">${((metadata.cv_mean || 0) * 100).toFixed(2)}% ${metadata.cv_std ? '¬± ' + ((metadata.cv_std || 0) * 100).toFixed(2) + '%' : ''}</span>
                    </div>
                `;
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω—Å–∞–º–±–ª—è
                if (isEnsemble && ensembleMetrics) {
                    if (ensembleMetrics.precision !== null && ensembleMetrics.precision !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">Precision:</span>
                                <span class="stat-value">${((ensembleMetrics.precision || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.recall !== null && ensembleMetrics.recall !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">Recall:</span>
                                <span class="stat-value">${((ensembleMetrics.recall || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.f1_score !== null && ensembleMetrics.f1_score !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">F1-Score:</span>
                                <span class="stat-value">${((ensembleMetrics.f1_score || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    if (ensembleMetrics.cv_f1_mean !== null && ensembleMetrics.cv_f1_mean !== undefined) {
                        html += `
                            <div class="stat-item">
                                <span class="stat-label">CV F1-Score:</span>
                                <span class="stat-value">${((ensembleMetrics.cv_f1_mean || 0) * 100).toFixed(2)}%</span>
                            </div>
                        `;
                    }
                    
                    // –í–µ—Å–∞ –∞–Ω—Å–∞–º–±–ª—è
                    if (ensembleMetrics.rf_weight !== null && ensembleMetrics.rf_weight !== undefined &&
                        ensembleMetrics.xgb_weight !== null && ensembleMetrics.xgb_weight !== undefined) {
                        html += `
                            <div class="stat-item" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <span class="stat-label" style="font-weight: bold; color: #00d4ff;">Ensemble Weights:</span>
                                <div style="margin-top: 5px;">
                                    <span style="color: #aaa;">Random Forest: </span>
                                    <span class="stat-value">${((ensembleMetrics.rf_weight || 0) * 100).toFixed(1)}%</span>
                                    <span style="color: #aaa; margin-left: 15px;">XGBoost: </span>
                                    <span class="stat-value">${((ensembleMetrics.xgb_weight || 0) * 100).toFixed(1)}%</span>
                                </div>
                                ${ensembleMetrics.ensemble_method ? `<p style="color: #888; font-size: 0.85em; margin-top: 5px;">Method: ${ensembleMetrics.ensemble_method}</p>` : ''}
                            </div>
                        `;
                    }
                }
                
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Live Win Rate:</span>
                        <span class="stat-value" style="color: ${stats.win_rate >= 50 ? '#00ff88' : '#ff4444'};">
                            ${(stats.win_rate || 0).toFixed(2)}%
                        </span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Live Total PnL:</span>
                        <span class="stat-value" style="color: ${stats.total_pnl >= 0 ? '#00ff88' : '#ff4444'};">
                            ${stats.total_pnl >= 0 ? '+' : ''}${(stats.total_pnl || 0).toFixed(2)} USDT
                        </span>
                    </div>
                `;
                
                html += '</div></div>';
                
                // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω—Å–∞–º–±–ª—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                if (!isEnsemble && metadata.symbol) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: #1a3a1a40; border: 1px solid #00ff88; border-radius: 4px;">
                            <h3 style="color: #00ff88; margin-top: 0;">üí° Recommendation: Use Ensemble Model</h3>
                            <p style="color: #aaa; margin: 10px 0;">
                                An ensemble model (combining Random Forest and XGBoost) is available for ${metadata.symbol || 'this symbol'}.
                                Ensemble models typically provide better performance and more robust predictions.
                            </p>
                            <p style="color: #888; font-size: 0.9em; margin: 5px 0;">
                                Select an ensemble model from the dropdown above to use it.
                            </p>
                        </div>
                    `;
                }
                
                if (shouldRetrain) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: #ff444420; border: 1px solid #ff4444; border-radius: 4px;">
                            <h3 style="color: #ff4444; margin-top: 0;">‚ö†Ô∏è Retraining Recommended</h3>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${retrainReasons.map(r => `<li style="color: #ffaa00;">${r}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                mlInfoDiv.innerHTML = html;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
                if (data.metadata) {
                    setTimeout(() => {
                        const modelSelect = document.getElementById('ml-model-select');
                        if (modelSelect && data.metadata) {
                            // –ò—â–µ–º –º–æ–¥–µ–ª—å –ø–æ —Å–∏–º–≤–æ–ª—É –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
                            const modelOptions = Array.from(modelSelect.options);
                            for (const option of modelOptions) {
                                if (option.value && option.value.includes(data.metadata.symbol) && option.value.includes(String(data.metadata.interval || '15'))) {
                                    modelSelect.value = option.value;
                                    modelSelect.dataset.currentModel = option.value;
                                    break;
                                }
                            }
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error loading ML model info:', error);
                const mlInfoDiv = document.getElementById('ml-model-info');
                if (mlInfoDiv) {
                    mlInfoDiv.innerHTML = '<p style="color: #ff4444;">Error loading model info</p>';
                }
            }
        }
        
        async function loadMLModelsList() {
            try {
                const response = await fetch('/api/ml/models/list');
                const data = await response.json();
                
                const modelSelect = document.getElementById('ml-model-select');
                if (!modelSelect) return;
                
                if (data.error) {
                    modelSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    return;
                }
                
                const models = data.models || [];
                
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                    return;
                }
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                modelSelect.innerHTML = '';
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ —Å–∏–º–≤–æ–ª–∞–º
                const modelsBySymbol = {};
                models.forEach(model => {
                    const symbol = model.symbol || 'UNKNOWN';
                    if (!modelsBySymbol[symbol]) {
                        modelsBySymbol[symbol] = [];
                    }
                    modelsBySymbol[symbol].push(model);
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã
                const sortedSymbols = Object.keys(modelsBySymbol).sort();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª–∏, –≥—Ä—É–ø–ø–∏—Ä—É—è –ø–æ —Å–∏–º–≤–æ–ª–∞–º
                sortedSymbols.forEach(symbol => {
                    const symbolModels = modelsBySymbol[symbol];
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Å–∏–º–≤–æ–ª–∞: —Å–Ω–∞—á–∞–ª–∞ –∞–Ω—Å–∞–º–±–ª–∏, –ø–æ—Ç–æ–º –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏
                    symbolModels.sort((a, b) => {
                        if (a.is_ensemble && !b.is_ensemble) return -1;
                        if (!a.is_ensemble && b.is_ensemble) return 1;
                        return (b.accuracy || 0) - (a.accuracy || 0);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ç–≥—Ä—É–ø–ø—É –¥–ª—è —Å–∏–º–≤–æ–ª–∞
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${symbol} (${symbolModels.length} model${symbolModels.length > 1 ? 's' : ''})`;
                    
                    symbolModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.path;
                    const trainedDate = model.trained_at ? new Date(model.trained_at).toLocaleDateString() : 'Unknown';
                    const accuracy = (model.accuracy * 100).toFixed(2);
                    const modelTypeDisplay = model.model_type || 'Unknown';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∞–Ω—Å–∞–º–±–ª—è
                        let metricsText = '';
                        if (model.is_ensemble) {
                            const metrics = [];
                            if (model.f1_score !== null && model.f1_score !== undefined) {
                                metrics.push(`F1: ${(model.f1_score * 100).toFixed(1)}%`);
                            }
                            if (model.cv_f1_mean !== null && model.cv_f1_mean !== undefined) {
                                metrics.push(`CV F1: ${(model.cv_f1_mean * 100).toFixed(1)}%`);
                            }
                            if (metrics.length > 0) {
                                metricsText = ` [${metrics.join(', ')}]`;
                            }
                        }
                        
                        option.textContent = `${modelTypeDisplay} - ${accuracy}%${metricsText} - ${trainedDate}`;
                        optgroup.appendChild(option);
                    });
                    
                    modelSelect.appendChild(optgroup);
                });
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏–∑ API
                fetch('/api/ml/model/info')
                    .then(response => response.json())
                    .then(modelInfo => {
                        if (modelInfo.metadata && modelInfo.current_model_path) {
                            const currentModelPath = modelInfo.current_model_path;
                            modelSelect.value = currentModelPath;
                            modelSelect.dataset.currentModel = currentModelPath;
                        }
                    })
                    .catch(err => {
                        console.log('Could not get current model path:', err);
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—É—Ç—å
                        const currentModelPath = modelSelect.dataset.currentModel;
                        if (currentModelPath) {
                            modelSelect.value = currentModelPath;
                        }
                    });
            } catch (error) {
                console.error('Error loading ML models list:', error);
                const modelSelect = document.getElementById('ml-model-select');
                if (modelSelect) {
                    modelSelect.innerHTML = '<option value="">Error loading models</option>';
                }
            }
        }
        window.loadMLModelsList = loadMLModelsList;
        
        async function selectMLModel() {
            try {
                const modelSelect = document.getElementById('ml-model-select');
                const statusDiv = document.getElementById('select-model-status');
                
                if (!modelSelect || !statusDiv) {
                    alert('Error: Could not find model selection elements');
                    return;
                }
                
                const modelPath = modelSelect.value;
                if (!modelPath) {
                    statusDiv.textContent = 'Please select a model first';
                    statusDiv.style.color = '#ff4444';
                    return;
                }
                
                statusDiv.textContent = 'Selecting model...';
                statusDiv.style.color = '#aaa';
                
                const response = await fetch('/api/ml/model/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model_path: modelPath })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusDiv.textContent = '‚úÖ Model selected successfully!';
                    statusDiv.style.color = '#00ff88';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏ –∏ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    setTimeout(() => {
                        if (typeof loadMLModelInfo !== 'undefined') {
                            loadMLModelInfo();
                        }
                    }, 300);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    setTimeout(() => {
                        if (typeof loadAllPairsModelsInfo !== 'undefined') {
                            loadAllPairsModelsInfo();
                        }
                    }, 500);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    modelSelect.dataset.currentModel = modelPath;
                } else {
                    statusDiv.textContent = `‚ùå Error: ${result.error || 'Unknown error'}`;
                    statusDiv.style.color = '#ff4444';
                }
            } catch (error) {
                console.error('Error selecting ML model:', error);
                const statusDiv = document.getElementById('select-model-status');
                if (statusDiv) {
                    statusDiv.textContent = `‚ùå Error: ${error.message}`;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        window.selectMLModel = selectMLModel;
        
        async function saveMLModelTypeForAll() {
            try {
                const modelTypeSelect = document.getElementById('ml-model-type-for-all');
                const statusDiv = document.getElementById('model-type-status');
                
                if (!modelTypeSelect) {
                    console.error('ml-model-type-for-all select not found');
                    return;
                }
                
                const modelType = modelTypeSelect.value || "";
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        app: {
                            ml_model_type_for_all: modelType || null
                        }
                    })
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned non-JSON response (${response.status}): ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (statusDiv) {
                        const displayType = modelType || 'Auto';
                        statusDiv.innerHTML = `<span style="color: #00ff88;">‚úî Model type for all pairs saved successfully! (${displayType})</span>`;
                    }
                    console.log('Model type for all pairs saved:', modelType || 'Auto');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    if (data.settings && data.settings.ml_model_type_for_all !== undefined) {
                        modelTypeSelect.value = data.settings.ml_model_type_for_all || "";
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        if (typeof loadSettings !== 'undefined') {
                            loadSettings();
                        }
                    }, 1000);
                } else {
                    const errorMsg = data.error || data.message || 'Failed to save model type';
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #ff4444;">Error: ${errorMsg}</span>`;
                    }
                    console.error('Error saving model type:', errorMsg);
                }
            } catch (error) {
                console.error('Error saving model type for all pairs:', error);
                const statusDiv = document.getElementById('model-type-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ff4444;">Error: ${error.message}</span>`;
                }
            }
        }
        
        window.saveMLModelTypeForAll = saveMLModelTypeForAll;
        
        async function retrainMLModel(mode = 'optimal') {
            try {
                const symbolSelect = document.getElementById('ml-symbol-select');
                const statusDiv = document.getElementById('retrain-status');
                
                if (!symbolSelect || !statusDiv) {
                    alert('Error: Could not find retrain elements');
                    return;
                }
                
                const symbol = symbolSelect.value;
                const modeDisplay = mode === 'optimal' ? '–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ' : '–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ';
                
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å ${modeDisplay} –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –¥–ª—è ${symbol}?`)) {
                    return;
                }
                
                statusDiv.textContent = `üöÄ –ó–∞–ø—É—Å–∫ ${modeDisplay} –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è...`;
                statusDiv.style.color = '#aaa';
                
                const response = await fetch('/api/ml/model/retrain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, mode: mode })
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.textContent = `‚úÖ ${result.message}`;
                    statusDiv.style.color = '#00ff88';
                } else {
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    statusDiv.style.color = '#ff4444';
                }
            } catch (error) {
                console.error('Retrain error:', error);
                const statusDiv = document.getElementById('retrain-status');
                if (statusDiv) {
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        window.retrainMLModel = retrainMLModel;
        
        async function retrainAllMLModels(mode = 'optimal') {
            try {
                const optimalBtn = document.getElementById('retrain-all-optimal-btn');
                const aggressiveBtn = document.getElementById('retrain-all-aggressive-btn');
                const statusDiv = document.getElementById('retrain-all-status');
                
                const modeName = mode === 'optimal' ? 'OPTIMAL' : 'AGGRESSIVE';
                
                if (!confirm(`Are you sure you want to retrain ALL ML models in ${modeName} mode?\n\nThis will retrain models for:\n- BTCUSDT\n- ETHUSDT\n- SOLUSDT\n\nThis process may take 10-20 minutes.`)) {
                    return;
                }
                
                if (optimalBtn) optimalBtn.disabled = true;
                if (aggressiveBtn) aggressiveBtn.disabled = true;
                
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ffaa00;">‚è≥ Starting ${modeName} model retraining... This may take 10-20 minutes.</span>`;
                }
                
                const response = await fetch('/api/ml/model/retrain-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color: #00ff88;">‚úÖ ${modeName} model retraining started! The models will be updated when training completes.</span>`;
                    }
                } else {
                    throw new Error(data.error || 'Failed to start retraining');
                }
            } catch (error) {
                console.error('Error retraining all ML models:', error);
                const statusDiv = document.getElementById('retrain-all-status');
                const optimalBtn = document.getElementById('retrain-all-optimal-btn');
                const aggressiveBtn = document.getElementById('retrain-all-aggressive-btn');
                
                if (statusDiv) {
                    statusDiv.innerHTML = `<span style="color: #ff4444;">‚ùå Error: ${error.message}</span>`;
                }
                
                if (optimalBtn) optimalBtn.disabled = false;
                if (aggressiveBtn) aggressiveBtn.disabled = false;
            }
        }
        
        window.retrainAllMLModels = retrainAllMLModels;
        
        async function loadWalletData() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                const primarySymbolSelect = document.getElementById('primary-symbol-select');
                const selectedSymbol = primarySymbolSelect ? primarySymbolSelect.value : (typeof currentSymbol !== 'undefined' && currentSymbol ? currentSymbol : 'BTCUSDT');
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`/api/wallet?symbol=${encodeURIComponent(selectedSymbol)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading wallet data:', data.error);
                    return;
                }
                
                const wallet = data.wallet || {};
                const position = data.position || null;
                const orders = data.open_orders || {};
                const trading = data.trading || {};
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ Dashboard (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                // Available Balance = Wallet Balance - Position Margin (—Å–≤–æ–±–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π)
                const walletBalance = wallet.wallet_balance || 0;
                const usedMargin = wallet.used_margin || 0;
                const availableBalance = walletBalance - usedMargin;
                
                const walletAvailableEl = document.getElementById('wallet-available');
                if (walletAvailableEl) {
                    walletAvailableEl.textContent = `${availableBalance.toFixed(2)} USDT`;
                    walletAvailableEl.style.color = '#00ff88';
                }
                
                const walletBalanceEl = document.getElementById('wallet-balance');
                if (walletBalanceEl) {
                    walletBalanceEl.textContent = wallet.wallet_balance ? `${wallet.wallet_balance.toFixed(2)} USDT` : '-';
                }
                
                const walletMarginEl = document.getElementById('wallet-margin');
                if (walletMarginEl) {
                    walletMarginEl.textContent = wallet.used_margin ? `${wallet.used_margin.toFixed(2)} USDT` : '-';
                    walletMarginEl.style.color = '#ffaa00';
                }
                
                // Total PnL –≤ –±–ª–æ–∫–µ Account –±–µ—Ä–µ—Ç—Å—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞ (cum_realised_pnl –∏–∑ –∫–æ—à–µ–ª—å–∫–∞)
                const totalPnlFromBalance = wallet.cum_realised_pnl !== undefined ? wallet.cum_realised_pnl : 0;
                const walletTotalPnlEl = document.getElementById('wallet-total-pnl');
                if (walletTotalPnlEl) {
                    walletTotalPnlEl.textContent = `${totalPnlFromBalance >= 0 ? '+' : ''}${totalPnlFromBalance.toFixed(2)} USDT`;
                    walletTotalPnlEl.className = `stat-value ${totalPnlFromBalance >= 0 ? 'positive' : 'negative'}`;
                }
                
                // Bonus
                const walletBonusEl = document.getElementById('wallet-bonus');
                if (walletBonusEl) {
                    if (wallet.bonus && wallet.bonus > 0) {
                        walletBonusEl.style.display = 'block';
                        const walletBonusValueEl = document.getElementById('wallet-bonus-value');
                        if (walletBonusValueEl) {
                            walletBonusValueEl.textContent = `${wallet.bonus.toFixed(2)} USDT`;
                            walletBonusValueEl.style.color = '#00d4ff';
                        }
                    } else {
                        walletBonusEl.style.display = 'none';
                    }
                }
                
                // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ /api/wallet - –ø–æ–∑–∏—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ symbols_status –≤ updateStatus()
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∏–º–≤–æ–ª–∞
                
                // Trading Statistics
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Trading Pair
                const primarySymbolSelectForStats = document.getElementById('primary-symbol-select');
                const selectedSymbolForStats = primarySymbolSelectForStats ? primarySymbolSelectForStats.value : (data.symbol || selectedSymbol || 'BTCUSDT');
                
                // Total PnL –≤ –±–ª–æ–∫–µ Trading Statistics –±–µ—Ä–µ—Ç—Å—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏ (cum_realised_pnl –∏–∑ –ø–æ–∑–∏—Ü–∏–∏) –∏–ª–∏ –∏–∑ –∫–æ—à–µ–ª—å–∫–∞
                // –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
                let totalPnlFromTrading = trading.total_pnl !== undefined ? trading.total_pnl : totalPnlFromBalance;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É PnL –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ updateStatus)
                if (typeof window.currentPnlStats !== 'undefined' && window.currentPnlStats && window.currentPnlStats.pnl_total !== undefined) {
                    totalPnlFromTrading = window.currentPnlStats.pnl_total;
                }
                
                let statsHtml = '';
                if (position) {
                    statsHtml += `<div class="stat-item"><span class="stat-label">Current Unrealised PnL:</span><span class="stat-value ${position.unrealised_pnl >= 0 ? 'positive' : 'negative'}">${position.unrealised_pnl >= 0 ? '+' : ''}${position.unrealised_pnl?.toFixed(2) || '0.00'} USDT</span></div>`;
                } else {
                    statsHtml += `<div class="stat-item"><span class="stat-label">Current Unrealised PnL:</span><span class="stat-value">0.00 USDT</span></div>`;
                }
                statsHtml += `<div class="stat-item"><span class="stat-label">Total PnL:</span><span class="stat-value ${totalPnlFromTrading >= 0 ? 'positive' : 'negative'}">${totalPnlFromTrading >= 0 ? '+' : ''}${totalPnlFromTrading.toFixed(2)} USDT</span></div>`;
                statsHtml += `<div class="stat-item"><span class="stat-label">Trading Pair:</span><span class="stat-value">${selectedSymbolForStats}</span></div>`;
                const tradingStatsEl = document.getElementById('trading-stats');
                if (tradingStatsEl) {
                    tradingStatsEl.innerHTML = statsHtml;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º
                if (typeof loadCombinedPnlStats === 'function') {
                    try {
                        await loadCombinedPnlStats();
                    } catch (e) {
                        console.warn('Error loading combined PnL stats:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ UI
                const walletAvailableEl = document.getElementById('wallet-available');
                if (walletAvailableEl) {
                    walletAvailableEl.textContent = 'Error loading';
                    walletAvailableEl.style.color = '#ff4444';
                }
            }
        }
        
        async function loadCombinedPnlStats() {
            try {
                const response = await fetch('/api/pnl/combined');
                const data = await response.json();
                
                if (!data.success || !data.combined) {
                    document.getElementById('combined-pnl-stats').innerHTML = '<div style="color: #aaa; font-size: 0.9em;">No statistics available</div>';
                    return;
                }
                
                const combined = data.combined;
                const perSymbol = data.per_symbol || {};
                const activeSymbols = data.active_symbols || [];
                
                let html = '';
                
                // –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                html += '<div style="margin-bottom: 20px;">';
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Today:</span><span class="stat-value ${combined.pnl_today >= 0 ? 'positive' : 'negative'}">${combined.pnl_today >= 0 ? '+' : ''}${combined.pnl_today.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Week:</span><span class="stat-value ${combined.pnl_week >= 0 ? 'positive' : 'negative'}">${combined.pnl_week >= 0 ? '+' : ''}${combined.pnl_week.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined PnL Month:</span><span class="stat-value ${combined.pnl_month >= 0 ? 'positive' : 'negative'}">${combined.pnl_month >= 0 ? '+' : ''}${combined.pnl_month.toFixed(2)} USDT</span></div>`;
                html += `<div class="stat-item"><span class="stat-label">Combined Total PnL:</span><span class="stat-value ${combined.pnl_total >= 0 ? 'positive' : 'negative'}" style="font-weight: bold; font-size: 1.1em;">${combined.pnl_total >= 0 ? '+' : ''}${combined.pnl_total.toFixed(2)} USDT</span></div>`;
                html += '</div>';
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∏–º–≤–æ–ª—É
                if (activeSymbols.length > 1 && Object.keys(perSymbol).length > 0) {
                    html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">';
                    html += '<h4 style="color: #aaa; margin-bottom: 10px; font-size: 0.95em;">Per Symbol:</h4>';
                    for (const symbol of activeSymbols) {
                        const stats = perSymbol[symbol];
                        if (stats) {
                            html += `<div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-radius: 5px;">`;
                            html += `<div style="font-weight: bold; color: #00d4ff; margin-bottom: 5px;">${symbol}</div>`;
                            html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85em;">`;
                            html += `<div><span style="color: #aaa;">Today:</span> <span class="${stats.pnl_today >= 0 ? 'positive' : 'negative'}">${stats.pnl_today >= 0 ? '+' : ''}${stats.pnl_today.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Week:</span> <span class="${stats.pnl_week >= 0 ? 'positive' : 'negative'}">${stats.pnl_week >= 0 ? '+' : ''}${stats.pnl_week.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Month:</span> <span class="${stats.pnl_month >= 0 ? 'positive' : 'negative'}">${stats.pnl_month >= 0 ? '+' : ''}${stats.pnl_month.toFixed(2)}</span></div>`;
                            html += `<div><span style="color: #aaa;">Total:</span> <span class="${stats.pnl_total >= 0 ? 'positive' : 'negative'}" style="font-weight: bold;">${stats.pnl_total >= 0 ? '+' : ''}${stats.pnl_total.toFixed(2)}</span></div>`;
                            html += `</div></div>`;
                        }
                    }
                    html += '</div>';
                }
                
                document.getElementById('combined-pnl-stats').innerHTML = html;
            } catch (error) {
                console.error('Error loading combined PnL stats:', error);
                document.getElementById('combined-pnl-stats').innerHTML = '<div style="color: #ff4444; font-size: 0.9em;">Error loading statistics</div>';
            }
        }
        
        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        async function loadWallet() {
            await loadWalletData();
        }
        window.loadWallet = loadWallet;
        window.loadWalletData = loadWalletData;
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, Tonkeeper)
        if (typeof window.ton !== 'undefined' && typeof window.ton.destroy !== 'function') {
            // –ï—Å–ª–∏ window.ton —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ destroy –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ
            try {
                window.ton.destroy = function() {
                    // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫
                };
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
            }
        }
        
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        let serverAvailable = true;
        let consecutiveErrors = 0;
        const maxConsecutiveErrors = 3;
        const errorBackoffDelay = 10000; // 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        
        // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è updateStatus —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function updateStatusWithErrorHandling() {
            try {
                await updateStatus();
                
                // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
                consecutiveErrors = 0;
                if (!serverAvailable) {
                    serverAvailable = true;
                    console.log('[UI] Server connection restored');
                }
            } catch (error) {
                // updateStatus() –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Ö –Ω–∞—Ä—É–∂—É
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏
                const statusElement = document.getElementById('current-status');
                const hasError = statusElement && statusElement.innerHTML.includes('Connection Error');
                
                if (hasError) {
                    consecutiveErrors++;
                    if (consecutiveErrors >= maxConsecutiveErrors && serverAvailable) {
                        serverAvailable = false;
                        console.warn(`[UI] Server unavailable after ${maxConsecutiveErrors} consecutive errors. Reducing update frequency to ${errorBackoffDelay}ms.`);
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–∫–∏, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    consecutiveErrors = 0;
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStatusWithErrorHandling();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
        function scheduleNextUpdate() {
            if (updateInterval) {
                clearTimeout(updateInterval);
                updateInterval = null;
            }
            
            const delay = serverAvailable ? 5000 : errorBackoffDelay; // 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, 10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            updateInterval = setTimeout(() => {
                updateStatusWithErrorHandling().finally(() => {
                    scheduleNextUpdate();
                });
            }, delay);
        }
        
        scheduleNextUpdate();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞
        loadChartLW();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.loadChart = loadChart;
        // startBot –∏ stopBot —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã—à–µ (—Å—Ç—Ä–æ–∫–∏ 2106 –∏ 2227)
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ (–±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
        setInterval(() => {
            if (window.activeTVChart && typeof loadChartLW === 'function') {
                // –í—ã–∑—ã–≤–∞–µ–º loadChartLW –ë–ï–ó forceRefresh, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–∏–π
                // –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –º–∞—Å—à—Ç–∞–±, –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏—è
                loadChartLW(false);
            }
        }, 60000); // 1 –º–∏–Ω—É—Ç–∞
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
        setTimeout(() => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
            if (typeof loadSymbolSettings !== 'undefined') {
                loadSymbolSettings();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (typeof loadSymbolsStatus === 'function') {
                loadSymbolsStatus();
            }
            
            if (typeof loadStrategySelection !== 'undefined') {
                loadStrategySelection();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞—Ä—ã
                const strategySymbolSelect = document.getElementById('strategy-symbol-select');
                if (strategySymbolSelect) {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ primary_symbol
                    const symbolSelect = document.getElementById('symbol-select');
                    if (symbolSelect && symbolSelect.value) {
                        strategySymbolSelect.value = symbolSelect.value;
                    }
                    loadStrategySettingsForSymbol();
                }
            }
            if (typeof loadMLModelsList !== 'undefined') {
                loadMLModelsList();
            }
            if (typeof loadMLModelInfo !== 'undefined') {
                loadMLModelInfo();
            }
            if (typeof loadAllPairsModelsInfo !== 'undefined') {
                loadAllPairsModelsInfo();
            }
        }, 100);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
        document.getElementById('show-sma').addEventListener('change', loadChartLW);
        document.getElementById('show-bb').addEventListener('change', loadChartLW);
        document.getElementById('show-volume').addEventListener('change', loadChartLW);
        document.getElementById('show-signals').addEventListener('change', loadChartLW);
        document.getElementById('show-rsi').addEventListener('change', loadChartLW);
        document.getElementById('show-macd').addEventListener('change', loadChartLW);
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ API Bybit
        async function loadBybitApiSettings() {
            try {
                const response = await fetch('/api/bybit/settings');
                if (response.ok) {
                    const data = await response.json();
                    const apiKeyInput = document.getElementById('bybit-api-key');
                    const apiSecretInput = document.getElementById('bybit-api-secret');
                    const baseUrlSelect = document.getElementById('bybit-base-url');
                    
                    if (apiKeyInput) {
                        apiKeyInput.value = data.api_key || "";
                    }
                    if (apiSecretInput) {
                        apiSecretInput.value = data.api_secret || "";
                    }
                    if (baseUrlSelect && data.base_url) {
                        baseUrlSelect.value = data.base_url;
                    }
                    
                    const statusDiv = document.getElementById('api-settings-status');
                    if (statusDiv) {
                        statusDiv.textContent = 'Settings loaded successfully.';
                        statusDiv.style.color = '#00ff88';
                    }
                } else {
                    const statusDiv = document.getElementById('api-settings-status');
                    if (statusDiv) {
                        statusDiv.textContent = 'Could not load settings.';
                        statusDiv.style.color = '#ff4444';
                    }
                }
            } catch (error) {
                console.error('Error loading API settings:', error);
                const statusDiv = document.getElementById('api-settings-status');
                if (statusDiv) {
                    statusDiv.textContent = 'Error loading settings: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
            }
        }
        
        async function saveBybitApiSettings() {
            const apiKeyInput = document.getElementById('bybit-api-key');
            const apiSecretInput = document.getElementById('bybit-api-secret');
            const baseUrlSelect = document.getElementById('bybit-base-url');
            const statusDiv = document.getElementById('api-settings-status');
            
            if (!apiKeyInput || !apiSecretInput || !baseUrlSelect) {
                alert('Error: Settings form elements not found');
                return;
            }
            
            const apiKey = apiKeyInput.value.trim();
            const apiSecret = apiSecretInput.value.trim();
            const baseUrl = baseUrlSelect.value.trim();
            
            if (!apiKey || !apiSecret || !baseUrl) {
                alert('Please fill in all fields');
                return;
            }
            
            if (statusDiv) {
                statusDiv.textContent = 'Saving...';
                statusDiv.style.color = '#00d4ff';
            }
            
            try {
                const response = await fetch('/api/bybit/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKey,
                        api_secret: apiSecret,
                        base_url: baseUrl
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (statusDiv) {
                        statusDiv.textContent = '‚úÖ Settings saved successfully! Please restart the bot for changes to take effect.';
                        statusDiv.style.color = '#00ff88';
                    }
                    alert('‚úÖ API settings saved successfully!\n\nPlease restart the bot for changes to take effect.');
                } else {
                    if (statusDiv) {
                        statusDiv.textContent = '‚ùå Error: ' + (result.error || 'Unknown error');
                        statusDiv.style.color = '#ff4444';
                    }
                    alert('‚ùå Error saving settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving API settings:', error);
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Error: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
                alert('‚ùå Error saving settings: ' + error.message);
            }
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà Hide';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è Show';
            }
        }
        
        async function logout(force = false) {
            if (!force && !confirm('Are you sure you want to logout?')) {
                return;
            }
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    window.location.href = '/login';
                }
            } catch (error) {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/login';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function changeAdminPassword() {
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const statusDiv = document.getElementById('password-change-status');
            
            if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput) {
                alert('Error: Password form elements not found');
                return;
            }
            
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!currentPassword || !newPassword || !confirmPassword) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Please fill in all fields';
                    statusDiv.style.color = '#ff4444';
                }
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword.length < 6) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå New password must be at least 6 characters long';
                    statusDiv.style.color = '#ff4444';
                }
                alert('New password must be at least 6 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå New passwords do not match';
                    statusDiv.style.color = '#ff4444';
                }
                alert('New passwords do not match');
                return;
            }
            
            if (statusDiv) {
                statusDiv.textContent = 'Changing password...';
                statusDiv.style.color = '#00d4ff';
            }
            
            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (statusDiv) {
                        statusDiv.textContent = '‚úÖ Password changed successfully! Please log in again with the new password.';
                        statusDiv.style.color = '#00ff88';
                    }
                    alert('‚úÖ Password changed successfully!\n\nPlease log in again with the new password.');
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
                    setTimeout(() => {
                        logout(true);
                    }, 2000);
                } else {
                    if (statusDiv) {
                        statusDiv.textContent = '‚ùå Error: ' + (result.error || 'Unknown error');
                        statusDiv.style.color = '#ff4444';
                    }
                    alert('‚ùå Error changing password: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error changing password:', error);
                if (statusDiv) {
                    statusDiv.textContent = '‚ùå Error: ' + error.message;
                    statusDiv.style.color = '#ff4444';
                }
                alert('‚ùå Error changing password: ' + error.message);
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
        window.loadBybitApiSettings = loadBybitApiSettings;
        window.saveBybitApiSettings = saveBybitApiSettings;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.logout = logout;
        window.changeAdminPassword = changeAdminPassword;
    </script>
</body>
</html>
