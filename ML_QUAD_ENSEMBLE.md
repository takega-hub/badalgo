# üöÄ Quad Ensemble: RF + XGBoost + LightGBM + LSTM

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

**QuadEnsemble** - —ç—Ç–æ –º–æ—â–Ω—ã–π –∞–Ω—Å–∞–º–±–ª—å, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π 4 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–∞ –º–æ–¥–µ–ª–µ–π –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:

1. **RandomForest** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –¥–µ—Ä–µ–≤—å—è —Ä–µ—à–µ–Ω–∏–π
2. **XGBoost** - –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±—É—Å—Ç–∏–Ω–≥
3. **LightGBM** - –±—ã—Å—Ç—Ä—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±—É—Å—Ç–∏–Ω–≥
4. **LSTM** - —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤**: –ö–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: LSTM —É–ª–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ê–Ω—Å–∞–º–±–ª—å –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤ –∫ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—é
- **–í–∑–≤–µ—à–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ**: –í–µ—Å–∞ –º–æ–¥–µ–ª–µ–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

```bash
pip install scikit-learn xgboost lightgbm torch pandas numpy
```

## üèãÔ∏è –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

### –ß–µ—Ä–µ–∑ ModelTrainer:

```python
from bot.ml.model_trainer import ModelTrainer
import pandas as pd
import numpy as np

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
trainer = ModelTrainer()
df = ...  # DataFrame —Å OHLCV –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
X, y = trainer.feature_engineer.prepare_features(df)

# –û–±—É—á–µ–Ω–∏–µ QuadEnsemble
ensemble, metrics = trainer.train_quad_ensemble(
    X=X,
    y=y,
    df=df,  # –ü–æ–ª–Ω—ã–π DataFrame –¥–ª—è LSTM
    rf_n_estimators=100,
    xgb_n_estimators=100,
    lgb_n_estimators=100,
    lstm_sequence_length=60,
    lstm_hidden_size=64,
    lstm_num_layers=2,
    lstm_epochs=50,
)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
trainer.save_model(
    model=ensemble,
    scaler=trainer.scaler,
    feature_names=trainer.feature_engineer.get_feature_names(),
    metrics=metrics,
    filename="quad_ensemble_ETHUSDT_15.pkl",
    symbol="ETHUSDT",
    interval="15",
    model_type="quad_ensemble",
)
```

## üîç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í MLStrategy:

QuadEnsemble –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –∞–Ω—Å–∞–º–±–ª—å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:

```python
from bot.ml.strategy_ml import MLStrategy

strategy = MLStrategy(
    model_path="ml_models/quad_ensemble_ETHUSDT_15.pkl",
    confidence_threshold=0.5,
    min_signal_strength="—Å–ª–∞–±–æ–µ",
)

# –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ (LSTM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑ df)
prediction, confidence = strategy.predict(df)
```

### –í–∞–∂–Ω–æ –¥–ª—è LSTM:

QuadEnsemble —Ç—Ä–µ–±—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∞–Ω–Ω—ã—Ö –¥–ª—è LSTM. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `predict_proba` –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π DataFrame:

```python
# –í–Ω—É—Ç—Ä–∏ MLStrategy —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –ù–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –Ω–∞–ø—Ä—è–º—É—é:
proba = ensemble.predict_proba(X, df_history=df)
```

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

### RandomForest:
- `rf_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `rf_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)

### XGBoost:
- `xgb_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `xgb_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6)
- `xgb_learning_rate`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1)

### LightGBM:
- `lgb_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `lgb_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6)
- `lgb_learning_rate`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1)

### LSTM:
- `lstm_sequence_length`: –î–ª–∏–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60)
- `lstm_hidden_size`: –†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 64)
- `lstm_num_layers`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
- `lstm_epochs`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)

## üìä –í–µ—Å–∞ –º–æ–¥–µ–ª–µ–π

–í–µ—Å–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏:

```python
# –í–µ—Å–∞ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ CV –º–µ—Ç—Ä–∏–∫–∞—Ö
rf_weight = rf_cv_score / total_score
xgb_weight = xgb_cv_score / total_score
lgb_weight = lgb_cv_score / total_score
lstm_weight = lstm_cv_score / total_score
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

QuadEnsemble –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
- ‚úÖ **–õ—É—á—à—É—é —Ç–æ—á–Ω–æ—Å—Ç—å** —á–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏
- ‚úÖ **–ë–æ–ª—å—à–µ —Å–∏–≥–Ω–∞–ª–æ–≤** –±–ª–∞–≥–æ–¥–∞—Ä—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—é –ø–æ–¥—Ö–æ–¥–æ–≤
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
- ‚úÖ **–£—á–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** —á–µ—Ä–µ–∑ LSTM

## ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **LSTM —Ç—Ä–µ–±—É–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏**: –ü—Ä–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏ –Ω—É–∂–µ–Ω DataFrame —Å –º–∏–Ω–∏–º—É–º `sequence_length` —Å—Ç—Ä–æ–∫–∞–º–∏
2. **–ú–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—É—á–µ–Ω–∏—è**: –û–±—É—á–µ–Ω–∏–µ 4 –º–æ–¥–µ–ª–µ–π –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
3. **–ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏**: LSTM –º–æ–¥–µ–ª–∏ –∑–∞–Ω–∏–º–∞—é—Ç –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞
4. **PyTorch –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**: –î–ª—è LSTM —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π PyTorch

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å TripleEnsemble

| –ü–∞—Ä–∞–º–µ—Ç—Ä | TripleEnsemble | QuadEnsemble |
|----------|---------------|--------------|
| –ú–æ–¥–µ–ª–∏ | RF + XGB + LGB | RF + XGB + LGB + LSTM |
| –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | ‚ùå | ‚úÖ |
| –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è | –ë—ã—Å—Ç—Ä–µ–µ | –ú–µ–¥–ª–µ–Ω–Ω–µ–µ |
| –¢–æ—á–Ω–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è |
| –ü–∞–º—è—Ç—å | –ú–µ–Ω—å—à–µ | –ë–æ–ª—å—à–µ |

## üìù –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `train_quad_ensemble.py`:

```bash
# –ë–∞–∑–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ
python train_quad_ensemble.py --symbol ETHUSDT --days 180

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
python train_quad_ensemble.py \
    --symbol ETHUSDT \
    --days 180 \
    --interval 15m \
    --rf_n_estimators 150 \
    --xgb_n_estimators 150 \
    --lgb_n_estimators 150 \
    --lstm_sequence_length 60 \
    --lstm_hidden_size 128 \
    --lstm_num_layers 2 \
    --lstm_epochs 100
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫—Ä–∏–ø—Ç–∞:

**–û–±—â–∏–µ:**
- `--symbol`: –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: BTCUSDT)
- `--days`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 180)
- `--interval`: –¢–∞–π–º—Ñ—Ä–µ–π–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15m)

**RandomForest:**
- `--rf_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `--rf_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)

**XGBoost:**
- `--xgb_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `--xgb_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6)
- `--xgb_learning_rate`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1)

**LightGBM:**
- `--lgb_n_estimators`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ä–µ–≤—å–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100)
- `--lgb_max_depth`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6)
- `--lgb_learning_rate`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1)

**LSTM:**
- `--lstm_sequence_length`: –î–ª–∏–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60)
- `--lstm_hidden_size`: –†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 64)
- `--lstm_num_layers`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–µ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
- `--lstm_epochs`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)
- `--lstm_batch_size`: –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 32)
- `--lstm_learning_rate`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.001)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –û–±—É—á–∏—Ç–µ QuadEnsemble –Ω–∞ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å TripleEnsemble
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã LSTM –ø–æ–¥ –≤–∞—à —Ç–∞–π–º—Ñ—Ä–µ–π–º
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
