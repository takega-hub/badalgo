# Улучшения ML стратегии для BTCUSDT

## Проблемы, обнаруженные в анализе

### 1. Дисбаланс LONG/SHORT сигналов
- **Проблема**: Все 12 сделок были SHORT (0 LONG)
- **Причина**: Пороги уверенности для LONG были выше, чем для SHORT
  - LONG: threshold_mult = 0.25-0.35, dynamic_threshold = 0.30
  - SHORT: threshold_mult = 0.15-0.20, dynamic_threshold = 0.20
- **Исправление**: Сбалансированы пороги LONG/SHORT до одинаковых значений (0.15-0.20, 0.20)

### 2. Низкий Win Rate (25%)
- **Проблема**: Win rate 25% при R≈2.07 → EV отрицательный
- **Причина**: TP/SL не оптимизированы для текущей волатильности
- **Исправление**: Добавлены адаптивные TP/SL на основе ATR

### 3. Долгая длительность сделок (19.48 часов)
- **Проблема**: Сделки держатся слишком долго
- **Причина**: Отсутствие фильтров по волатильности
- **Исправление**: Новые защитные механизмы от резких движений интегрированы в live.py

## Внесенные изменения

### 1. Балансировка порогов LONG/SHORT
**Файл**: `bot/ml/strategy_ml.py`

```python
# БЫЛО (для LONG):
threshold_mult = 0.25 if is_volatile_symbol else 0.35
dynamic_threshold = self.confidence_threshold * 0.30

# СТАЛО (для LONG):
threshold_mult = 0.15 if is_volatile_symbol else 0.20  # Как для SHORT
dynamic_threshold = self.confidence_threshold * 0.20  # Как для SHORT
```

**Результат**: Теперь LONG и SHORT имеют одинаковые пороги, что должно привести к балансу сигналов.

### 2. Адаптивные TP/SL на основе волатильности
**Файл**: `bot/ml/strategy_ml.py`

Добавлена логика адаптации TP/SL:
- Высокая волатильность → более широкие TP/SL (больше шансов на успех)
- Низкая волатильность → более узкие TP/SL (быстрее выход)
- Специальная оптимизация для BTCUSDT: более узкий TP (0.9x) для улучшения win rate

**Формула**:
```python
volatility_multiplier = max(0.8, min(1.5, atr_pct / avg_atr_pct))
tp_pct = base_tp_pct * tp_multiplier * volatility_multiplier
sl_pct = base_sl_pct * sl_multiplier * volatility_multiplier
```

### 3. Интеграция защитных механизмов от волатильности
**Файл**: `bot/live.py`

ML сигналы теперь проходят через все защитные механизмы:
- Circuit Breaker
- Volatility Spike Detection
- Price Velocity Filter
- Multiple Candle Body Filter
- Volume Spike Filter
- Volatility Cooldown
- Market Calm Check
- Directional Movement Check

## Рекомендации для дальнейшей оптимизации

### 1. Мониторинг баланса LONG/SHORT
После применения изменений нужно отслеживать:
- Количество LONG vs SHORT сигналов
- Win rate для LONG vs SHORT
- PnL для LONG vs SHORT

### 2. Оптимизация TP/SL для BTCUSDT
Текущие настройки:
- Base TP: 2.5% (25% от маржи / 10x leverage)
- Base SL: 1.0% (10% от маржи / 10x leverage)
- Для BTCUSDT: TP multiplier = 0.9x (более узкий TP)

**Возможные улучшения**:
- Тестировать TP multiplier в диапазоне 0.8-1.0x
- Тестировать SL multiplier в диапазоне 0.9-1.1x
- Цель: Win rate > 33% при сохранении R-ratio > 2.0

### 3. Переобучение моделей
Если после оптимизации результаты не улучшатся:
- Переобучить модели с фокусом на баланс LONG/SHORT
- Добавить фичи волатильности в обучающие данные
- Использовать взвешенную выборку для баланса классов

### 4. Отключение ML для BTCUSDT
Если после всех оптимизаций ML остается убыточным:
- Рассмотреть отключение ML для BTCUSDT
- Использовать только rule-based стратегии (VBO, Hybrid)
- Сфокусироваться на ETHUSDT и SOLUSDT для ML

## Ожидаемые результаты

После применения изменений:
1. **Баланс LONG/SHORT**: Ожидается ~50/50 распределение сигналов
2. **Win Rate**: Ожидается улучшение с 25% до 30-35%+
3. **Profit Factor**: Ожидается улучшение с 0.69 до 0.8-1.0+
4. **Длительность сделок**: Ожидается снижение благодаря фильтрам волатильности

## Тестирование

Для проверки эффективности изменений:
1. Запустить бэктест на тех же данных
2. Сравнить результаты до/после
3. Мониторить live торговлю в течение недели
4. Собрать статистику по LONG/SHORT сигналам
