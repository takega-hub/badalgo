# –ú–µ—Å—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ TP/SL –≤ –∫–æ–¥–µ

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ TP/SL

### 1. `_calculate_tp_sl_for_signal()` (bot/live.py:197)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å—á–µ—Ç TP/SL –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ —Å–∏–≥–Ω–∞–ª—É

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **SMC:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ TP/SL –∏–∑ —Å–∏–≥–Ω–∞–ª–∞, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏
- **ML:** 
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `ml_max_loss_pct_margin` –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏ –ü–ï–†–ï–î —Ä–∞—Å—á–µ—Ç–æ–º
  - –ò–∑–≤–ª–µ–∫–∞–µ—Ç TP/SL –∏–∑ reason —Å–∏–≥–Ω–∞–ª–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã), –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- **TREND/FLAT:** 
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `take_profit_pct` –∏ `stop_loss_pct` –∫–∞–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
  - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç TP/SL –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
  - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ 2-3:1

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- SL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 7-10% –æ—Ç –º–∞—Ä–∂–∏
- TP/SL –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ (TP –≤—ã—à–µ –≤—Ö–æ–¥–∞ –¥–ª—è LONG, SL –Ω–∏–∂–µ –≤—Ö–æ–¥–∞ –¥–ª—è LONG)
- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∑–Ω–∞—á–µ–Ω–∏–π

---

### 2. `_ensure_tp_sl_set()` (bot/live.py:617)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TP/SL –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **ML:** 
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `ml_max_loss_pct_margin` –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏ –ü–ï–†–ï–î —Ä–∞—Å—á–µ—Ç–æ–º
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º—É–º 7% –æ—Ç –º–∞—Ä–∂–∏ (0.7% –æ—Ç —Ü–µ–Ω—ã –ø—Ä–∏ 10x –ø–ª–µ—á–µ), –∞ –Ω–µ 0.5% –æ—Ç —Ü–µ–Ω—ã
- **TREND/FLAT:** 
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `take_profit_pct` –∏ `stop_loss_pct` –∫–∞–∫ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç –º–∞—Ä–∂–∏
  - –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç —Ü–µ–Ω—ã: `/ leverage`

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- **–ë–µ–∑—É–±—ã—Ç–æ–∫:** –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç SL –≤ –±–µ–∑—É–±—ã—Ç–æ–∫ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª—É—á—à–µ –±–∞–∑–æ–≤–æ–≥–æ SL)
- **Trailing Stop:** –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª—É—á—à–µ –±–∞–∑–æ–≤–æ–≥–æ SL)

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ SL: –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ > 50% –æ—Ç entry price
- –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ API: –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏

---

## –ú–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ TP/SL —á–µ—Ä–µ–∑ API

### 1. `_ensure_tp_sl_set()` ‚Üí `client.set_trading_stop()` (bot/live.py:1184)
**–ö–æ–≥–¥–∞:** –ü—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–µ–π (–∫–∞–∂–¥—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏)

### 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ (bot/live.py:4500)
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Å–∏–≥–Ω–∞–ª—É
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** –†–µ–∑—É–ª—å—Ç–∞—Ç `_calculate_tp_sl_for_signal()`

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ –ø–æ–∑–∏—Ü–∏–∏ (averaging) (bot/live.py:4673, 5266)
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
**–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç:** SL –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞

### 4. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ LONG (bot/live.py:4805)
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è LONG –ø–æ–∑–∏—Ü–∏–∏
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** –†–µ–∑—É–ª—å—Ç–∞—Ç `_calculate_tp_sl_for_signal()`

### 5. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ SHORT (bot/live.py:5091)
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è SHORT –ø–æ–∑–∏—Ü–∏–∏
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** –†–µ–∑—É–ª—å—Ç–∞—Ç `_calculate_tp_sl_for_signal()`

### 6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ –ø–æ–∑–∏—Ü–∏–∏ LONG (bot/live.py:5398)
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ LONG –ø–æ–∑–∏—Ü–∏–∏
**–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç:** SL –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞

---

## –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –î–ª—è ML —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
- `ml_target_profit_pct_margin`: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ –æ—Ç –º–∞—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.0 –¥–ª—è 25%)
- `ml_max_loss_pct_margin`: –ü—Ä–æ—Ü–µ–Ω—Ç —É–±—ã—Ç–∫–∞ –æ—Ç –º–∞—Ä–∂–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 7-10%)

### –î–ª—è TREND/FLAT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
- `take_profit_pct`: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ –æ—Ç –º–∞—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.30 –¥–ª—è 30%)
- `stop_loss_pct`: –ü—Ä–æ—Ü–µ–Ω—Ç —É–±—ã—Ç–∫–∞ –æ—Ç –º–∞—Ä–∂–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0.07-0.10 –¥–ª—è 7-10%)

### –û–±—â–∏–µ:
- `leverage`: –ü–ª–µ—á–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10x)
- `breakeven_activation_pct`: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–µ–∑—É–±—ã—Ç–∫–∞
- `trailing_stop_activation_pct`: –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ trailing stop

---

## –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞

### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –æ—Ç –º–∞—Ä–∂–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç —Ü–µ–Ω—ã:
```
price_pct = margin_pct / leverage
```

**–ü—Ä–∏–º–µ—Ä:**
- Entry: $142.15
- Leverage: 10x
- SL: 7% –æ—Ç –º–∞—Ä–∂–∏
- ‚Üí SL –æ—Ç —Ü–µ–Ω—ã: 7% / 10 = 0.7%
- ‚Üí SL —Ü–µ–Ω–∞: $142.15 * (1 - 0.007) = $141.15

### –†–∞—Å—á–µ—Ç TP/SL –¥–ª—è LONG:
```
base_tp = entry_price * (1 + tp_pct)
base_sl = entry_price * (1 - sl_pct)
```

### –†–∞—Å—á–µ—Ç TP/SL –¥–ª—è SHORT:
```
base_tp = entry_price * (1 - tp_pct)
base_sl = entry_price * (1 + sl_pct)
```

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

1. **ML —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ `_ensure_tp_sl_set()`:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 7-10% –æ—Ç –º–∞—Ä–∂–∏ –ü–ï–†–ï–î —Ä–∞—Å—á–µ—Ç–æ–º `sl_pct`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º—É–º–∞ 7% –æ—Ç –º–∞—Ä–∂–∏ –≤–º–µ—Å—Ç–æ 0.5% –æ—Ç —Ü–µ–Ω—ã

2. **ML —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤ `_calculate_tp_sl_for_signal()`:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 7-10% –æ—Ç –º–∞—Ä–∂–∏ –ü–ï–†–ï–î —Ä–∞—Å—á–µ—Ç–æ–º `sl_pct`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ SL –∏–∑ reason —Å–∏–≥–Ω–∞–ª–∞ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω 7-10% –æ—Ç –º–∞—Ä–∂–∏

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ SL:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 7-10% –æ—Ç –º–∞—Ä–∂–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
   - –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

4. **–õ–æ–≥–∏–∫–∞ –±–µ–∑—É–±—ã—Ç–∫–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª—É—á—à–µ –±–∞–∑–æ–≤–æ–≥–æ SL
   - –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SL

5. **–õ–æ–≥–∏–∫–∞ trailing stop:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª—É—á—à–µ –±–∞–∑–æ–≤–æ–≥–æ SL
   - –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SL

6. **–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ API:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 7-10% –æ—Ç –º–∞—Ä–∂–∏
   - –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 1% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ SL —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1% –æ—Ç –º–∞—Ä–∂–∏ –≤–º–µ—Å—Ç–æ 7-10%):

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:
   - `üö® CRITICAL: ML SL from margin` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É
   - `‚ö†Ô∏è WARNING: SL too small` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ SL —Å–ª–∏—à–∫–æ–º –º–∞–ª
   - `‚úÖ SL is correct` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ SL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:
   - `ML_MAX_LOSS_PCT_MARGIN` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 7-10 (–Ω–µ 1.0)
   - `STOP_LOSS_PCT` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0.07-0.10 (–Ω–µ 0.01)

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ reason —Å–∏–≥–Ω–∞–ª–∞:
   - –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç `SL_0.10%`, —ç—Ç–æ –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 7% –æ—Ç –º–∞—Ä–∂–∏
   - –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç `SL_1.00%`, —ç—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ (10% –æ—Ç –º–∞—Ä–∂–∏ –ø—Ä–∏ 10x –ø–ª–µ—á–µ)
