# Исправления стратегии AMT & Order Flow Scalper

## Проблемы, которые были исправлены

### 1. ❌ Проблема с logger
**Проблема:** `logger` использовался до определения (определен в строке 784, но использовался раньше)
**Исправление:** Перемещен `logger = logging.getLogger(__name__)` в начало файла после импортов

### 2. ❌ Неправильное логирование
**Проблема:** Использовался `logger.debug` вместо единообразного `bot_log`
**Исправление:** Все вызовы `logger.debug` заменены на `bot_log` с соответствующими категориями и уровнями

### 3. ❌ Недостающие параметры в live.py
**Проблема:** В `live.py` не переопределялись `min_total_volume` и `min_cvd_delta` из настроек
**Исправление:** Добавлены строки:
```python
abs_cfg.min_total_volume = current_settings.strategy.amt_of_min_total_volume
abs_cfg.min_cvd_delta = current_settings.strategy.amt_of_min_cvd_delta
```

### 4. ❌ Улучшен парсинг тиков
**Проблема:** Парсинг тиков мог не работать с разными форматами данных от Bybit API
**Исправление:** 
- Добавлена поддержка множества вариантов полей (time/T/execTime/timestamp, price/execPrice/p, qty/execQty/q/size, side/S)
- Добавлена нормализация стороны (BUYER -> BUY, SELLER -> SELL)
- Улучшена обработка ошибок с логированием

### 5. ❌ Улучшена диагностика CVD метрик
**Проблема:** Недостаточно информации о том, почему не вычисляются CVD метрики
**Исправление:** 
- Добавлено логирование временного диапазона тиков
- Добавлен fallback для использования доступных данных, если окно слишком маленькое
- Улучшено логирование причин отсутствия данных

### 6. ❌ Улучшено логирование генерации сигналов
**Проблема:** Недостаточно информации о том, почему не генерируются сигналы
**Исправление:**
- Добавлено подробное логирование для каждого типа сигнала (Breakout LONG/SHORT, Squeeze LONG/SHORT, Absorption)
- Добавлено логирование условий проверки сигналов
- Добавлено логирование финальных настроек перед генерацией сигналов

## Новые возможности

### Диагностический скрипт
Создан скрипт `diagnose_amt_strategy.py` для полной диагностики работы стратегии:

```bash
# Диагностика для BTCUSDT (по умолчанию)
python diagnose_amt_strategy.py

# Диагностика для другого символа
python diagnose_amt_strategy.py ETHUSDT
```

Скрипт проверяет:
1. ✅ Получение OHLCV данных
2. ✅ Получение и парсинг тиков (trades)
3. ✅ Построение Volume Profile (POC, VAH, VAL)
4. ✅ Вычисление CVD метрик
5. ✅ Генерацию сигналов с подробной информацией

## Рекомендации по использованию

### 1. Проверка работы стратегии
Запустите диагностический скрипт для проверки:
```bash
python diagnose_amt_strategy.py BTCUSDT
```

### 2. Проверка логов
После запуска бота проверьте логи на наличие сообщений:
- `[AMT]` - общая информация о работе стратегии
- `[AMT_OF]` - детальная информация о проверках условий

### 3. Настройка параметров
Если сигналов нет, проверьте настройки в `bot/config.py`:
- `amt_of_min_total_volume` - минимальный объем (по умолчанию 10,000)
- `amt_of_min_cvd_delta` - минимальный CVD (по умолчанию 5,000)
- `amt_of_min_buy_sell_ratio` - минимальное соотношение покупок/продаж (по умолчанию 2.0)
- `amt_of_delta_aggr_mult` - множитель для порога Delta Velocity (по умолчанию 2.5)

Для BTCUSDT используются более высокие пороги (см. `AMT_CONFIG_REGISTRY` в `amt_orderflow_strategy.py`):
- `min_total_volume`: 80,000
- `min_cvd_delta`: 35,000
- `min_buy_sell_ratio`: 2.5

### 4. Возможные причины отсутствия сигналов

1. **Недостаточно тиков в окне**
   - Проверьте логи: `[AMT_OF] CVD Metrics: No trades in window`
   - Увеличьте `amt_of_lookback_seconds` или проверьте доступность API

2. **Недостаточный объем**
   - Проверьте логи: `[AMT_OF] Absorption Check: Vol X/Y`
   - Уменьшите `amt_of_min_total_volume` или дождитесь более активного рынка

3. **Недостаточный CVD**
   - Проверьте логи: `[AMT_OF] Absorption Rejected: CVD X < Min CVD Y`
   - Уменьшите `amt_of_min_cvd_delta` или дождитесь более выраженного дисбаланса

4. **Недостаточное соотношение покупок/продаж**
   - Проверьте логи: `[AMT_OF] Absorption Rejected: Buy/Sell ratio X < Min Y`
   - Уменьшите `amt_of_min_buy_sell_ratio`

5. **Слишком большое движение цены**
   - Проверьте логи: `[AMT_OF] Absorption Rejected: Price drift X% > Max Y%`
   - Увеличьте `amt_of_max_price_drift_pct`

6. **Не выполнены условия для Breakout/Squeeze**
   - Проверьте логи: `[AMT] Breakout LONG check:` или `[AMT] Breakout SHORT check:`
   - Проверьте, что цена находится относительно VAH/VAL
   - Проверьте, что Delta Velocity превышает порог

## Следующие шаги

1. ✅ Запустите диагностический скрипт для проверки работы
2. ✅ Проверьте логи бота на наличие сообщений `[AMT]` и `[AMT_OF]`
3. ✅ При необходимости скорректируйте параметры в `bot/config.py`
4. ✅ Мониторьте генерацию сигналов в реальном времени

## Файлы, которые были изменены

1. `bot/amt_orderflow_strategy.py` - основная логика стратегии
2. `bot/live.py` - добавлено переопределение параметров
3. `diagnose_amt_strategy.py` - новый диагностический скрипт
